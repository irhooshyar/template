<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"/>
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- anychart modules -->
    {#    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>#}
    {#    <script src="../../static/library/anychart-base.min-8.10.0.js"></script>#}
    {#    <script src="../../static/library/anychart-8.10.0-ui.min.js"></script>#}
    {#    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>#}
    {#    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>#}
    {#    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>#}
    <script src="../../static/library/anychart-8.11.0-bundle.js"></script>
    {#    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>#}
    {#    <script src="../../static/library/anychart-8.10.0-radar.min.js"></script>#}

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/vote_analysis.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <script src="../../static/js/ChartColumnInteractivity.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>

    <meta charset="UTF-8">
    <title>شعار سال</title>
    {% include "doc/title_icon.html" %}
</head>

<body>
<!-- Menu -->
<nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
    {% include "doc/header2.html" %}
</nav>

<script>
    $(document).ready(function () {

        // Active panel
        $('#RahbariDropdown').addClass('active');
        $('#leadership_slogan').addClass('active');

        $('select#language').on('change', function (e) {

            let selected_language = this.value;
            let current_url = window.location.href;
            if (selected_language === 'England') {
                let page_name = current_url.split('/')[3]
                let requested_url = current_url.replace(page_name, 'en')
                window.location = requested_url;
            } else if (selected_language === 'Russia') {
                let page_name = current_url.split('/')[3]
                let requested_url = current_url.replace(page_name, 'ru')
                window.location = requested_url;
            }

        });
    });
</script>

<div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
    <div class="d-flex align-items-center rtl flex-row-reverse mx-auto p-1"
         style="background: linear-gradient(#8693AB, #cbd3da, #e9ecef); box-shadow: 0 0 2px 2px #f8f9fa inset; border: 4px solid #f8f9fa; border-radius: 24px">
        <img style="width: 120px;" id="prefix_ShowHideImg" src="../../static/image/rahbar_profile.png">
        <div class="d-flex flex-column gap-2 rtl mr-2" dir="rtl">
            <span class="font-weight-bolder">تحلیل اسناد رهبری</span>
            <span>صفحه تحلیل شعار سال <span class="text-primary">(نسخه آزمایشی)</span></span>
        </div>
    </div>
    <form id="subject_analysis_form" action="" class="custom-control mx-auto needs-validation"
          enctype="multipart/form-data" method="post" novalidate>

        <div class="row flex-row-reverse mx-auto">

            <!-- Country select -->
            <div class="col-md-6 col-12 col-lg-2 bg-light pt-3  mt-1" dir="rtl" style="display: none">
                <label for="country" class=" text-right bg-light float-right">مجموعه سند:</label>
                <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select"
                        onchange="CountryChanged()">
                    <!-- leadership_slogan in views.py -->
                    {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Slogan select -->
            <div class="col-md-6 col-12 col-lg-4 bg-light pt-3  mt-1" dir="rtl" style="padding-right: 0">
                <label class=" text-right bg-light float-right" style="direction: rtl;;"> انتخاب سال و شعار:</label>
                <select id="slogan" name="slogan_year" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="keywordChange()">
                    <!-- leadership_slogan in views.py , key:value  -->
                    {% for k,v in slogans.items %}

                        {% if v == '1398 - رونق تولید' %}
                            <option value="{{ k }}" selected>{{ v }}</option>

                        {% else %}
                            <option value="{{ k }}">{{ v }}</option>
                        {% endif %}

                    {% endfor %}
                </select>
            </div>

            <div class="col-lg-1 col-md-2 pt-5 col-12 mt-1 px-0">
                <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right  mr-2">
                    <div class="spinner-border text-light" role="status">
                        <span class="sr-only">درحال جستجو ...</span>
                    </div>
                    نمایش
                </button>

            </div>

            <!-- keywords  -->
            <div class="col-md-6 col-12 col-lg-3 bg-light pt-3  mt-1 ">
                <label class=" text-right bg-light float-right" style="direction: rtl;;">کلیدواژه‌ها :</label>
                <input id="slogan-keyword" name="slogan_year" class="form-control text-right float-right" disabled>
                </input>
            </div>

            <!-- modal button  -->
            <div class="text-light col-lg-2 col-md-2 pt-5 col-12 mt-1 pl-5">

                <button style="background-color:lightblue;color:black" type="button" class="btn modal_btn"
                        data-bs-toggle="modal"
                        id="document_note_text" onclick="ShowSynonymousWords()">واژگان مترادف
                </button>
            </div>
            <div style="direction: rtl; text-align: start"
                 class="text-light col-lg-2 col-md-2 pt-3 pt-5 col-11 mt-1 pl-5">
                <a style="text-decoration: none" id="document_id_link" target="_blank" href="">
                    <button style="background-color:lightblue;color:black" type="button" class="btn modal_btn"
                            data-bs-toggle="modal"
                            id="document_id">
                        سند نوروزی مرتبط
                    </button>
                </a>
            </div>

        </div>
    </form>


    <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
        role="tablist">

        <li class="nav-item float-right" role="presentation">
            <button id="slogan_info_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#slogan_info_pane" type="button" role="tab" aria-controls="slogan_info_pane"
                    aria-selected="true"> اطلاعات شعار در اسناد
            </button>
        </li>
        <li class="nav-item float-right" role="presentation">
            <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#bar_chart_info_pane" type="button" role="tab" aria-controls="bar_chart_info_pane"
                    aria-selected="false">داشبورد آماری
            </button>
        </li>

        <!-- Download Buttons -->
        <!--            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"-->
        <!--                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"-->
        <!--                type="button">-->
        <!--                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>-->

        <!--            </button>-->

        <!--            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"-->
        <!--                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">-->
        <!--                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>-->
        <!--            </button>-->

        <p id="AraCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>
    </ul>

    <div id="original_pane" class="tab-content float-right px-1" id="pills-tabContent">
        <!-- Ara Result Pane اطلاعات شعار در سال-->
        <div id="slogan_info_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
             aria-labelledby="statistics_info_tab">
            <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                <div id="doc_count_container" class="full" chart-height="550px"></div>
                <div id="chart_container1" class="half" chart-height="450px"></div>
                <div id="word_count_container" class="half" chart-height="450px"></div>
                <div id="chart_container3" class="half" chart-height="450px"></div>
                <div id="chart_container2" class="half" chart-height="450px"></div>
            </div>
        </div>

        <!-- Bar chart Info Pane داشبورد آماری -->
        <div dir="rtl" class="tab-pane fade float-right w-100" id="bar_chart_info_pane" role="tabpanel"
             aria-labelledby="bar_chart_info_tab">

            <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                <div id="subject_container" class="half" chart-height="450px"></div>
                <div id="level_container" class="half" chart-height="450px"></div>
                <div id="approval_container" class="full" chart-height="2000px"></div>
            </div>
        </div>

    </div>

</div>

<!-- Modal Container -->
<div class="modal fade" id="SelectDocumentModal">
    <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div style="direction: rtl !important;" class="modal-header">
                <h5 id="ModalHeader" class="modal-title">انتخاب رأی</h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
            </div>


            <!-- Modal body -->
            <div id="ModalBody" class="modal-body text-justify">
                <div class="container">
                    <table id="PopUpTable" class="table table-striped PopUpTable">
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="showResult" onclick="ShowResult()" type="button" class="btn"
                        data-bs-toggle="modal">نمایش
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ChartModal Container -->
<button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
<div class="modal fade" id="ChartModal">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div style="direction: rtl !important;" class="modal-header">
                <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal body -->
            <div id="ChartModalText" class="modal-body text-justify">
            </div>

            <!-- Modal footer -->


            <!-- Modal footer -->
            <div dir="rtl" class="modal-footer">
                <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                    اسناد
                </button>

                <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل</button>
            </div>

        </div>
    </div>
</div>

<button type="button" id="ChartModalBtn_2" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal_2"></button>
<div class="modal fade" id="ChartModal_2">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div style="direction: rtl !important;" class="modal-header">
                <h5 id="ChartModalHeader_2" class="modal-title">عنوان</h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal body -->
            <div id="ChartModalText_2" class="modal-body text-justify">
                <h6 id="DocsCount_2" class='text-secondary'></h6>
                <div id="ChartModalBodyText_2">
                </div>

                <button id="LoadMoreDocuments_2" class="btn btn-white w-100 mb-1 float-left"
                        style="color: #0e3f8b"><i class="fa fa-plus pl-2"
                                                  style="position:relative;top:3px;"></i>نمایش بیش‌تر
                </button>

            </div>

            <!-- Modal footer -->
            <div dir="rtl" class="modal-footer">

                <input type="number" id="ColumnModalPaginationInput_2" min="1" max="1" value="1"
                       class="form-select text-right float-right d-none">


                <button id="ExportExcel_2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی
                    اکسل
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal Container for Synonymous Words  -->
<div class="modal fade" id="documentContent">
    <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">

            <!-- Modal Header -->
            <div style="direction: rtl !important;" class="modal-header">
                <h5 id="documentContentHeader" class="modal-title">نام پنل: </h5>
                <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body bg-light text-justify">
                <div class="container" id="DocumentContentBody">
                </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>

        </div>
    </div>
</div>

<!-- Scrollbar -->
<button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
    <i class="far fa-caret-square-up"></i>
</button>

<script src="../../static/js/logincheck.js"></script>

<script src="../../static/js/scroll_button_handler.js"></script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>


<script>

    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }

    }

    let selectedAra = [];
    let searchResultValue = [];
    let jsonTable = []

    const chart_container = 'chart_container';

    var sloganKeyword = {% autoescape off %}{{ slogan_keyword }}{% endautoescape %}; // leadership_slogan in views.py
    // var sloganSynonymousWords = {% autoescape off %}{{ slogan_synonymous_words }}{% endautoescape %};
    function keywordChange() {
        const year = document.getElementById("slogan").value;
        document.getElementById("slogan-keyword").value = sloganKeyword[year].split('-').join('- ');

        const doc_ids =
        {% autoescape off %}{{ year_document_id }}{% endautoescape %}
        const document_link = 'http://' + location.host + "/document_profile/?id=" + doc_ids[year]
        document.getElementById("document_id_link").href = document_link
        // document.getElementById("slogan-synonymous-words").value = sloganSynonymousWords[year].split('-').join('- ');
        // ShowResult()

    }

    async function init() {
        initSearchableSelects();
        CountryChanged();
        keywordChange()

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)
    }

    init();

    function clearPrevResults(container_id_list) {
        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }

    async function CountryChanged() {
        const country_id = document.getElementById("country").value;
        const country_name = $('#country option:selected').text();
        /* Clear Previous results */

        selectedAra = []
        container_id_list = []

        clearPrevResults(container_id_list);
        notyf.dismissAll();


    }

    async function ShowResult() {
        await SpinnerModeFunction("Active");
        container_id_list = []

        clearPrevResults(container_id_list);
        notyf.dismissAll();

        startBlockUI('slogan_info_pane');

        const t = document.getElementById("country")
        const country_id = t.value;
        const country_name = t.options[t.selectedIndex].text

        const slogan_year = document.getElementById("slogan").value;

        const new_prof_chart = new_prof_slogan_year_changed(slogan_year);

        request_link = 'http://' + location.host + "/GetChartSloganAnalysis/" + country_id + "/" + slogan_year + "/"; //  اطلاعات شعار در اسناد
        let response = await fetch(request_link).then(response => response.json());

        await new_prof_chart;

        chart_data1 = response['slogan_analysis1']
        chart_data2 = response['slogan_analysis2']
        chart_data3 = response['slogan_analysis3']


        showChart(chart_data1, "chart_container1", country_id, country_name, slogan_year, true, "تعداد تکرار کلیدواژه", "سال", "میانگین تعداد تکرار کلیدواژه‌ها در هر سند")
        showChart(chart_data2, "chart_container2", country_id, country_name, slogan_year, true, "تعداد تکرار کلیدواژه", "سال", "میانگین تعداد تکرار واژگان مترادف در هر سند")
        showChart(chart_data3, "chart_container3", country_id, country_name, slogan_year, true, "تعداد تکرار کلیدواژه", "سال", "تعداد تکرار کلیدواژه‌ها نرمال‌شده با توجه به طول اسناد")

        stopBlockUI('slogan_info_pane', 'اطلاعات شعار در اسناد');

        await SpinnerModeFunction("Disable");


        /************************* Generate chart data *********************/
        startBlockUI('bar_chart_info_pane');


        request_link = 'http://' + location.host + "/GetInfoChartSloganAnalysis/" + country_id + "/" + slogan_year + "/"; // داشبورد آماری
        response = await fetch(request_link).then(response => response.json());

        const subject_chart_data = response["subject_chart_data"] // موضوع سند
        const approval_references_chart_data = response["approval_references_chart_data"] // مراجع تصویب
        const level_chart_data = response["level_chart_data"] // سطح سند

        showChart(subject_chart_data, "subject_container", country_id, country_name, slogan_year, true, "تعداد سند", "موضوع", "توزیع موضوعی اسناد")
        showChart(level_chart_data, "level_container", country_id, country_name, slogan_year, true, "تعداد سند", "سطح", "توزیع اسناد بر اساس سطح اسناد")
        showChart(approval_references_chart_data, "approval_container", country_id, country_name, slogan_year, true, "تعداد سند", "مرجع تصویب", "توزیع اسناد بر اساس مرجع تصویب")

        stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = $("#country option:selected").text();
        let slogan_select = $("#slogan option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        form_data.append('slogan_select', slogan_select);
        UserLog(form_data)

    }

    //data, container, keySort,country_name, yTitle, xTitle

    function showChart(data, container, country_id, country_name, slogan_year, sortKeys, yAxisTitle, xAxisTitle, title) {
        const options = {
            data,
            sortKeys,
            title,
            yAxisTitle,
            xAxisTitle,
            onClick: async function (event, data) {

                document.getElementById("ChartModalText").innerHTML = ""

                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                const text = data.row(index)[0];
                const column_name = text;

                let filtered_result = []
                let header = ""
                let save_file_name = 'پنل درگاه: '

                startFullPageBlockUI();

                if (container === "subject_container") {
                    chart_type = 'subject_chart_data'

                    header = "موضوع: " + text
                    save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", country_name).replace("2", text)
                } else if (container === "approval_container") {
                    chart_type = 'approval_reference_chart_data'

                    header = "مرجع تصویب: " + text
                    save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", country_name).replace("2", text)
                } else if (container === "level_container") {
                    chart_type = 'level_chart_data'

                    header = "سطح سند: " + text
                    save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", country_name).replace("2", text)
                }

                // else if (container === "chart_container1" || container === "chart_container2") {
                else if (container === "chart_container1" || container === "chart_container2" || container === "chart_container3") {

                    chart_type = 'chart_container'

                    header = "سال: " + text
                    save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", country_name).replace("2", text)
                }

                document.getElementById("ChartModalHeader").innerText = header


                let request_link = 'http://' + location.host + "/GetDetailChartSloganAnalysis/" + country_id + "/" +
                    slogan_year + "/" + chart_type + "/" + column_name + "/"

                let response = await fetch(request_link).then(response => response.json());

                filtered_result = response['document_list']

                let filtered_result_tag = ""
                let list_of_docId = ""
                for (const doc of filtered_result) {
                    const link = 'http://' + location.host + "/information/?id=" + doc["document_id"]
                    let tag = "<li class='mt-3' id=" + doc["document_id"] + "><a target='_blank' href='" + link + "'>" + doc["document_name"] + "</a></li>"
                    filtered_result_tag += tag
                    list_of_docId += doc["document_id"] + "_"
                }

                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML = filtered_result_tag

                stopFullPageBlockUI('کلیک روی نمودار')
                $("#ChartModalBtn").click();

                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };

                console.log(save_file_name)
                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = async function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "نام سند" + sep + "سطح سند" + sep +
                        "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                    for (let document of filtered_result) {

                        Csv += document["document_name"] + sep + document["level_name"] + sep + document["subject_name"] + sep +
                            document["type_name"] + sep + document["approval_reference_name"] + sep + document["approval_date"] + "\n"

                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };

            }
        }
        if (container === "subject_container") {
            options.onClick = async function (event, data) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                const text = data[index][0];
                const column_name = text;


                let filtered_result = []
                let header = ""
                let save_file_name = "تحلیل شعار سال:"

                startFullPageBlockUI();
                chart_type = 'subject_chart_data'

                header = "موضوع: " + text
                save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", country_name).replace("2", text)

                document.getElementById("ChartModalHeader").innerText = header


                let request_link = 'http://' + location.host + "/GetDetailChartSloganAnalysis/" + country_id + "/" +
                    slogan_year + "/" + chart_type + "/" + column_name + "/"

                let response = await fetch(request_link).then(response => response.json());

                filtered_result = response['document_list']

                let filtered_result_tag = ""
                let list_of_docId = ""
                for (const doc of filtered_result) {
                    const link = 'http://' + location.host + "/information/?id=" + doc["document_id"]
                    let tag = "<li class='mt-3' id=" + doc["document_id"] + "><a target='_blank' href='" + link + "'>" + doc["document_name"] + "</a></li>"
                    filtered_result_tag += tag
                    list_of_docId += doc["document_id"] + "_"
                }

                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML = filtered_result_tag

                stopFullPageBlockUI('کلیک روی نمودار')
                $("#ChartModalBtn").click();

                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };

                console.log(save_file_name)
                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = async function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "نام سند" + sep + "سطح سند" + sep +
                        "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                    for (let document of filtered_result) {

                        Csv += document["document_name"] + sep + document["level_name"] + sep + document["subject_name"] + sep +
                            document["type_name"] + sep + document["approval_reference_name"] + sep + document["approval_date"] + "\n"

                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };
                stopFullPageBlockUI('کلیک روی نمودار')

                $("#ChartModalBtn").click();
            }

            newDoughnutChart(container, options);
        } else {
            newBarChart(container, options)
        }
    }

</script>
<script src="../../static/js/zipDownload/jszip.min.js"></script>
<script src="../../static/js/zipDownload/FileSaver.min.js"></script>

<!-- Export results -->
<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['document_name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " آرای موجود در"
        downloadFiles(searchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep +
            "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "کلیدواژه ها" + sep + "تعداد کلیدواژه ها" + "\n"
        for (const document of searchResultValue) {
            Csv += document["document_name"] + sep + document["document_subject"] + sep +
                document["document_approval_reference"] + sep + document["document_approval_date"] + sep +
                document["document_keywords"] + sep + document["keywords_count"] + "\n"

        }

        let save_file_name = " آرای موجود در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

    var sloganSynonymousWords = {% autoescape off %}{{ slogan_synonymous_words }}{% endautoescape %};

    async function ShowSynonymousWords(document_note_text) {
        const slogan_year = document.getElementById("slogan").value;
        document.getElementById('documentContentHeader').innerHTML = "";
        document.getElementById('DocumentContentBody').innerHTML = "";
        $('#documentContent').modal('show');

        const header = 'واژگان مترادف'
        if (sloganSynonymousWords[slogan_year] == undefined) {
            document.getElementById('documentContentHeader').innerHTML = header;
            document.getElementById('DocumentContentBody').innerHTML = "";
            return;
        }
        // let text = '<p>' + sloganSynonymousWords[slogan_year].split('-').join('- ') + '</p>';
        let text = '';
        var words = sloganSynonymousWords[slogan_year].split('-');
        for (let index = 0; index < words.length; index++) {
            text += '<p>' + (index + 1).toString() + '. ' + words[index] + '</p>';
        }
        document.getElementById('documentContentHeader').innerText += header
        document.getElementById('DocumentContentBody').innerHTML += text
    }

</script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/leadership_slogan/leadership_slogan_tour.js">
</script>
<script src="../../static/js/leadership_slogan/newDashboard.js"></script>
<script src="../../static/js/tour.js"></script>

<!-- <script src="../../static/js/UserLogSave.js"></script> -->
<script src="../../static/js/signout_function.js"></script>


</html>