<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dropdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->


    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css" />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">
    <meta charset="UTF-8">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>
    <title> انطباق‌سنجی مصوبات</title>
    {% include "doc/title_icon.html" %}

</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {
            {% comment %} $('.searchable').select2({
                dir: 'rtl',
            }); {% endcomment %}
            // Active panel
            $('#approvals_adaptation').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <div class="d-flex align-items-center rtl flex-row-reverse mx-auto p-1"
            style="background: linear-gradient(#8693AB, #cbd3da, #e9ecef); box-shadow: 0 0 2px 2px #f8f9fa inset; border: 4px solid #f8f9fa; border-radius: 24px">
            <img style="width: 120px;" id="prefix_ShowHideImg" src="../../static/image/rahbar_profile.png">
            <div class="d-flex flex-column gap-2 rtl mr-2" dir="rtl">
                <span class="font-weight-bolder">تحلیل اسناد رهبری</span>
                <span>صفحه انطباق‌سنجی مصوبات <span class="text-primary">(نسخه آزمایشی)</span></span>
            </div>
        </div>
        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" autocomplete="off" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mx-auto">

                <!-- Country Input -->
                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        {% if "رهبری" in v %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>

                </div>

                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light d-none">
                    <label class="float-right" style="direction: rtl;">عبارت مورد نظر:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="متن جست‌وجو ..." type="text" required="" name="SearchBox" id="SearchBox" value="">
                </div>

                <!-- Keywords-->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> برچسب:</label>

                    <select id="LabelsName" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="NewSearch()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        جست‌وجو
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- document type -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">نوع سند:</label>
                    <select id="TypeName" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>


                <!-- From Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> سال تصویب از:</label>

                    <select id="YearFrom" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- To Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;"> سال تصویب تا:</label>

                    <select id="YearTo" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>


                <!-- Document Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light d-none" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">در:</label>

                    <select id="WhereSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                        <option value="عنوان یا متن">عنوان و یا متن</option>
                        <option value="عنوان" selected>عنوان</option>
                        <option value="متن">متن</option>
                    </select>
                </div>

                <!-- Match Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light d-none" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع جستجو:</label>
                    <select id="SearchTypeSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                        <option value="and">و (And)</option>
                        <option value="or">یا (OR)</option>
                        <option selected value="exact">دقیقا (Exact)</option>
                    </select>
                </div>

            </div>

        </form>
        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab"
                        aria-controls="bar_chart_info_pane" aria-selected="false">داشبورد آماری</button>
                </li>


                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>
            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">
                    <!-- Page select -->
                    <div class="col-md-6 col-12 col-lg-2 float-left">

                        <input type="number" onchange="TablePaginationChanged(event)" id="TablePaginationInput" min="1"
                            max="1" value="1" class="form-select text-right float-right" style="direction: rtl;">

                    </div>


                    <!-- Result Pagination -->
                    <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                        <span id="from_page">1</span>
                        /
                        <span id="total_page">1</span>
                    </p>
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

                <!-- Bar chart Info Pane -->
                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100"
                    id="bar_chart_info_pane" role="tabpanel" aria-labelledby="bar_chart_info_tab">

                    <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">

                        <div id="type_container" chart-height="750px" class="half">
                        </div>


                        <div id="year_container" chart-height="750px" class="half">
                        </div>


                        <div id="labels_container" chart-height="3000px" class="full">
                        </div>


                    </div>

                </div>
            </div>

        </div>


    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div id="modal_dialog" class="modal-dialog modal-fullscreen  modal-dialog-scrollable "
            style="max-height: 100vh !important;">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title w-100">
                        <div class="row w-100">
                            <div id="src_document_header" class="col-6 float-right text-center my-auto"></div>
                            <div id="dest_document_header" class="col-6 float-left text-center my-auto"></div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">
                        <div id="SrcDocumentParagraph" class="col-6 float-right">
                            <div class="table-responsive search_result_table mt-4">
                                <table class="table table-striped SimSearchTable" style="min-height: 200px;"
                                    id="SimSearchTable">
                                </table>
                            </div>
                        </div>
                        <div id="DestDocumentParagraph" class="col-6 float-left"></div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button> -->
                </div>

            </div>
        </div>
    </div>


    <!-- 3-Similarity Container -->
    <div class="modal fade" id="SimilaritiesDetail">
        <div id="modal_dialog" class="modal-dialog modal-fullscreen  modal-dialog-scrollable "
            style="max-height: 100vh !important;">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="SimilaritiesDetail_ModalHeader" class="modal-title text-center w-100">

                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="SimilaritiesDetail_Body" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">

                        <div id="label_sim_container" class="col-4 float-right">
                            <h6 id="label_sim_header" class="w-100 float-right text-center m-auto fw-bold text-primary">
                                شباهت براساس برچسب‌ها <span class="text-secondary">(نسخه آزمایشی)</span></h6>

                            <div class="table-responsive search_result_table mt-4">
                                <table class="table table-striped LabelSimSearchTable" style="min-height: 200px;"
                                    id="LabelSimSearchTable">
                                </table>
                            </div>
                        </div>

                        <div id="para_sim_container" class="col-4 float-right">
                            <h6 id="para_sim_header" class="w-100 float-right text-center m-auto fw-bold text-primary">
                                شباهت پاراگرافی <span class="text-secondary">(نسخه آزمایشی)</span></h6>

                            <div class="table-responsive search_result_table mt-4">
                                <table class="table table-striped ParaSimSearchTable" style="min-height: 200px;"
                                    id="ParaSimSearchTable">
                                </table>
                            </div>
                        </div>

                        <div id="title_sim_container" class="col-4 float-right">
                            <h6 id="title_sim_header" class="w-100 float-right text-center m-auto fw-bold text-primary">
                                شباهت براساس عنوان اسناد <span class="text-secondary">(نسخه آزمایشی)</span></h6>

                            <div class="table-responsive search_result_table mt-4">
                                <table class="table table-striped TitleSimSearchTable" style="min-height: 200px;"
                                    id="TitleSimSearchTable">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">

                </div>

            </div>
        </div>
    </div>



    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- ChartModal_2 Container -->
    <button type="button" id="ChartModalBtn_2" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal_2"></button>
    <div class="modal fade" id="ChartModal_2">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader_2" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText_2" class="modal-body text-justify">
                    <h6 id="DocsCount_2" class='text-secondary'></h6>
                    <div id="ChartModalBodyText_2">
                    </div>

                    <button id="LoadMoreDocuments_2" class="btn btn-white w-100 mb-1 float-left"
                        style="color: #0e3f8b">
                        <i class="fa fa-plus pl-2" style="position:relative;top:3px;">
                        </i>
                        نمایش بیش‌تر
                    </button>

                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">

                    <input type="number" id="ColumnModalPaginationInput_2" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none">


                    <button id="ExportExcel_2" disabled class="btn btn-primary"><i class="fa fa-download"></i> خروجی
                        اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="LabelSimModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h6 id="LabelSimModalHeader" class="modal-title w-100">عنوان</h6>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="LabelSimModalBody" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
        <!-- <i class="bi bi-chevron-up"></i> -->
        <!-- <i class="bi bi-chevron-double-up"></i> -->
        <!-- <i class="bi bi-arrow-up-circle"></i> -->
    </button>


    <!-- Toast -->
    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                    aria-label="Close"></button>
                <i style="position: relative; top: -4px; font-size: 18px;"
                    class="bi bi-info-circle-fill  text-info"></i>
                <span id="toast_message">
                </span>
            </div>
        </div>
    </div>


    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>
    <!-- Intro Js -->
    <script src="../../static/js/search/search_tour.js"></script>
    <script src="../../static/js/tour.js"></script>


    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <script>

        initSearchableSelects();
        init()

        const CHART_FIELD_DICT = {
            "labels_container": "label_name",
            "type_container": "type_name",
            "year_container": "rahbari_year",
            "sentiment_container": "sentiment",
            "subject_container": "classification_subject",
            "person_container": "persons",
            "location_container": "locations",
            "organization_container": "organizations",
        }



        SearchResultValue = []
        ES_SearchResult = []

        MAX_RESULT_WINDOW = 5000
        SEARCH_RESULT_SIZE = 100

        container_id_list = ['SearchResultLable', 'SearchTable']

        let UserSearchParameters = {

            country_id: "",
            type_id: "",
            type_name: "",
            label_name: "",
            from_year: "",
            to_year: "",
            table_curr_page: "",

            update_parameters: function () {


                this.country_id = document.getElementById("country").value;
                this.type_id = document.getElementById("TypeName").value
                this.type_name = $("#TypeName option:selected").text();
                this.label_name = document.getElementById("LabelsName").value
                this.from_year = document.getElementById("YearFrom").value
                this.to_year = document.getElementById("YearTo").value
                this.table_curr_page = document.getElementById('TablePaginationInput').value

            }
        }



        let ColumnUserSearchParameters = {

            country_id: "",
            type_name: "",
            label_name: "",
            from_year: "",
            to_year: "",
            column_curr_page: "",

            update_parameters: function () {


                this.country_id = document.getElementById("country").value;
                this.type_name = $("#TypeName option:selected").text();
                this.label_name = $("#LabelsName option:selected").text();
                this.from_year = $("#YearFrom option:selected").text();
                this.to_year = $("#YearTo option:selected").text();

                this.column_curr_page = document.getElementById('ColumnModalPaginationInput_2').value

            }
        }



        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        async function init() {
            const country_id = document.getElementById("country").value
            startFullPageBlockUI();

            let request_link = 'http://' + location.host + "/GetRahbariSearchParameters/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["parameters_result"]

            /****************** Categories List ****************************/

            document.getElementById("LabelsName").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['Labels'];

            /****************** Type List ****************************/
            document.getElementById("TypeName").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['Type'];

            /****************** Year List ****************************/
            document.getElementById("YearFrom").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['FromYear'];
            document.getElementById("YearTo").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['ToYear'];

            UserSearchParameters.update_parameters();
            ColumnUserSearchParameters.update_parameters()

            syncAllSelectsWithResetExceptions(["country"])

            stopFullPageBlockUI('مقداردهی اولیه')

            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)
        }

        function CountryChanged() {
            init()
        }


        function TablePaginationChanged(event) {

            input_id = event.target.id

            curr_page_number = parseInt(event.target.value);
            max_page_number = parseInt(document.getElementById(input_id).max);
            min_page_number = parseInt(document.getElementById(input_id).min);


            if (curr_page_number > max_page_number) {
                document.getElementById(input_id).value = max_page_number
            }

            else if (curr_page_number < min_page_number) {
                document.getElementById(input_id).value = min_page_number
            }


            ShowResult();

        }

        async function update_table_pagination_input(curr_page, total_hits) {

            page_count = 0;

            if (total_hits < SEARCH_RESULT_SIZE) {
                page_count = 1

            } else if (total_hits < MAX_RESULT_WINDOW) {
                page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

            } else if (total_hits >= MAX_RESULT_WINDOW) {
                page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
            }

            document.getElementById("TablePaginationInput").min = 1;
            document.getElementById("TablePaginationInput").max = page_count;
            document.getElementById("TablePaginationInput").value = curr_page;

            document.getElementById("from_page").innerText = curr_page;
            document.getElementById("total_page").innerText = page_count

        }


        function showDocumentInformation(documents_information_result, mode, where, total_hits, text) {

            SearchResultValue = documents_information_result;

            const search_text = document.getElementById("SearchBox").value;

            document.getElementById("SearchResultLable").innerText = "تعداد کل نتایج: " + total_hits + " سند"
            let index = 1;
            let document_result = []

            console.log("*********", documents_information_result)

            for (let doc of documents_information_result) {
                const doc_id = doc['_source']['document_id']
                var doc_name = doc['_source']['name']
                const doc_file_name = doc['_source']['document_file_name']
                const type = doc['_source']['type']
                const rahbari_date = doc['_source']['rahbari_date']
                const rahbari_year = doc['_source']['rahbari_year'] !== 0 ? doc['_source']['rahbari_year'] : 'نامشخص'
                const labels = doc['_source']['labels']

                let count = Math.round((doc['_score'] * 100)) / 100

                let button_disable = ""


                // const detail_function = `DetailFunction('${es_id}', '${name}', '${mode}', '${where}', '${index - 1}')`;
                const detail_function = `DetailFunction2('${doc_id}','${doc_name}')`;
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + button_disable + ' onclick="' + detail_function + '" data-bs-target="#SimilaritiesDetail">جزئیات</button>'

                const document_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
                doc_name = '<a target="_blank" href="' + document_link + '">' + doc_name + "</a>"

                const row = {
                    "index": index,
                    "doc_id": doc_id,
                    "doc_name": doc_name,
                    "doc_file_name": doc_file_name,
                    "rahbari_date": rahbari_date,
                    "rahbari_year": rahbari_year,
                    "rahbari_type": type,
                    "rahbari_labels": labels,
                    "count": count,
                    "detail": detail
                }

                document_result.push(row)
                index += 1
            }
            $('#SearchTable').empty();
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "سندی یافت نشد.",
                "columns": [{
                    "name": "index",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "doc_name",
                    "title": "نام سند",
                    "style": {
                        "width": "35"
                    }
                }, {
                    "name": "rahbari_type",
                    "title": "نوع سند",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "rahbari_date",
                    "title": "تاریخ تصویب",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "rahbari_labels",
                    "title": "برچسب",
                    "style": {
                        "width": "20%"
                    }
                }, {
                    "name": "detail",
                    "title": "جزئیات",
                    "style": {
                        "width": "10%"
                    }
                }
                ],
                "rows": document_result
            });
        }

        async function GetDocumentsInformation(country_id, type_id, label_name, from_year, to_year, place, text, search_type, curr_page) {

            let request_link = '';
            notyf.dismissAll();

            startBlockUI('SearchTable');
            console.log(label_name)

            const rahbari_type = 0
            const document_ids = 0
            const with_rahbari_type = 0
            request_link = 'http://' + location.host + "/SearchRahbari_ES/" + country_id + "/" + type_id + "/" +
                label_name + "/" + from_year + "/" + to_year + "/" + rahbari_type + "/" + document_ids + "/" + place + "/" + text + "/" + search_type + "/" + with_rahbari_type + "/"
                + curr_page  + "/" + SEARCH_RESULT_SIZE + "/";

            let response = await fetch(request_link).then(response => response.json());

            console.log("__", response)

            /*  Show Table Result */
            total_hits = response["total_hits"]
            ES_SearchResult = response["result"]
            ES_Aggregations = response["aggregations"]
            curr_page = response["curr_page"]

            update_table_pagination_input(curr_page, total_hits)

            showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text)
            stopBlockUI('SearchTable', 'نتایج جست‌وجو');
            GetChartData_Es(country_id, text, ES_Aggregations, ES_SearchResult);

        }

        async function GetChartData_Es(country_id, text, ES_Aggregations, documents_information_result) {

            let request_link = '';
            startBlockUI('bar_chart_info_pane');



            type_chart = ES_Aggregations['rahbari-type-agg']['buckets']
            year_chart = ES_Aggregations['rahbari-year-agg']['buckets']
            labels_chart = ES_Aggregations['rahbari-labels-agg']['buckets']

            doc_ids = []

            for (doc of documents_information_result) {
                doc_id = doc['_source']['document_id']
                doc_ids.push(doc_id)
            }

            /* Show Chart  */

            showChartData(type_chart, "type_container", documents_information_result, false, 'نوع', "توزیع اسناد براساس نوع")
            showChartData(year_chart, "year_container", documents_information_result, true, 'سال', "توزیع اسناد براساس سال")
            showChartData(labels_chart, "labels_container", documents_information_result, true, 'برچسب', "توزیع اسناد براساس برچسب")
            stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

        }




        function showChartData(data, container, documents_information_result, keySort, xAxisTitle, title) {
            let chart_data = []
            for (column of data) {
                key = column["key"]
                value = column["doc_count"]

                chart_data.push([key, value])
            }
            showChart(chart_data, container, documents_information_result, keySort, xAxisTitle, title)
        }


        function showChart(data, container, documents_information_result, sortKeys, xAxisTitle, title) {

            const options = {
                data,
                sortKeys,
                xAxisTitle,
                title,
                yAxisTitle: "تعداد سند",
                onClick: async function (event, data) {

                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    const text = data.row(index)[0];
                    const best_result_count = documents_information_result.length

                    let filtered_result = []
                    let header = ""

                    await GetClickedColumnDocuments(container, text)
                    $("#ChartModalBtn_2").click();




                }




            };

            newBarChart(container, options)

        }

        async function NewSearch() {
            await update_table_pagination_input(1, 0);
            UserSearchParameters.update_parameters();
            ColumnUserSearchParameters.update_parameters();

            await ShowResult()
        }

        async function ShowResult() {
            await SpinnerModeFunction("Active");
            clearPrevResults(container_id_list);
            await SpinnerModeFunction("Active");

            const country_id = UserSearchParameters.country_id
            const type_id = UserSearchParameters.type_id
            const label_name = UserSearchParameters.label_name;
            const from_year = UserSearchParameters.from_year;
            const to_year = UserSearchParameters.to_year;

            const place = document.getElementById("WhereSelect").value;
            let text = document.getElementById("SearchBox").value;
            const search_type = document.getElementById("SearchTypeSelect").value
            // update_table_pagination_input(UserSearchParameters.table_curr_page,0)
            const curr_page = document.getElementById("TablePaginationInput").value


            if (text.trim().length > 0) {
                text = text.replaceAll('/', '>')
                text = text.replaceAll('\\', '<')
                GetDocumentsInformation(country_id, type_id, label_name, from_year, to_year, place, text, search_type, curr_page);
            }
            else {
                GetDocumentsInformation(country_id, type_id, label_name, from_year, to_year, place, "empty", "All", curr_page);
            }

            await SpinnerModeFunction("Disable");

            //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name = $("#country option:selected").text();
            let type = $("#TypeName option:selected").text();
            let label = $("#LabelsName option:selected").text();
            let fromYear = $("#YearFrom option:selected").text();
            let toYear = $("#YearTo option:selected").text();
            form_data.append('detail_type', detail_type);
            form_data.append('country_name', country_name);
            form_data.append('type', type);
            form_data.append('label', label);
            form_data.append('fromYear', fromYear);
            form_data.append('toYear', toYear);
            UserLog(form_data)

        }


        function popup_handler() {
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            });
        }

        async function showHighlightedParagraphs_Details(document_id, document_name, paragraphs_list) {
            /* Title Text */
            const link = 'http://' + location.host + "/document_profile/?id=" + document_id
            let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
            document.getElementById("ModalHeader").innerHTML = title_tag

            document.getElementById("DetailText").innerHTML = ""
            for (let paragraph of paragraphs_list) {

                tag = "<li class='mb-3'>" + paragraph + "</li>"
                document.getElementById("DetailText").innerHTML += tag;
            }
            document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        }

        async function DetailFunction(document_id, document_name) {
            document.getElementById("SimSearchTable").innerHTML = '';
            document.getElementById("dest_document_header").innerHTML = ''
            document.getElementById("DestDocumentParagraph").innerHTML = ''

            startBlockUI('SimSearchTable');
            let country_id = document.getElementById("country").value;
            let request_link = 'http://' + location.host + "/GetDoticSimDocument/" + document_id + '/';
            let response = await fetch(request_link).then(response => response.json());
            let sim_doc_list = response['sim_doc_list']


            await showDetailsDataExact(sim_doc_list, document_id, document_name)
            stopBlockUI('SimSearchTable', 'جدول اسناد مشابه')
        }



        async function DetailFunction2(document_id, document_name) {

            /* Title Text */
            const src_document_link = 'http://' + location.host + "/document_profile/?id=" + document_id;
            let src_document_tag = "<a class='mt-2' target='blank' href='" + src_document_link + "'>" + document_name + "</a>";

            // clear tables
            document.getElementById("TitleSimSearchTable").innerHTML = '';
            document.getElementById("TitleSimSearchTable").innerHTML = '';
            document.getElementById("LabelSimSearchTable").innerHTML = '';
            document.getElementById("ParaSimSearchTable").innerHTML = '';


            /********** LabelSimSearchTable *****************/

            startBlockUI('LabelSimSearchTable');
            country_id = document.getElementById("country").value;
            request_link = 'http://' + location.host + "/GetDoticSimDocument_ByLabels/" + document_id + '/';
            response = await fetch(request_link).then(response => response.json());
            result_doc_list = response['result_doc_list']
            labels = response['labels']
            await showDetailsDataExact(result_doc_list, document_id, document_name, "LabelSimSearchTable")
            stopBlockUI('LabelSimSearchTable', 'جدول اسناد مشابه')

            label_span = '<h6 class="mt-4">' + ' برچسب سند: ' + labels + "</div>"
            document.getElementById("SimilaritiesDetail_ModalHeader").innerHTML = "<h6 class='text-secondary'> " + "سند انتخابی از اسناد رهبری: " + "</h6>" + src_document_tag + label_span

            /********** ParaSimSearchTable *****************/

            startBlockUI('ParaSimSearchTable');
            country_id = document.getElementById("country").value;
            request_link = 'http://' + location.host + "/GetDoticSimDocument/" + document_id + '/';
            response = await fetch(request_link).then(response => response.json());
            result_similar_docs = response['result_similar_docs']
            await showDetailsDataExact(result_similar_docs, document_id, document_name, "ParaSimSearchTable")
            stopBlockUI('ParaSimSearchTable', 'جدول اسناد مشابه')

            /********** TitleSimSearchTable *****************/

            startBlockUI('TitleSimSearchTable');
            country_id = document.getElementById("country").value;
            request_link = 'http://' + location.host + "/GetDoticSimDocument_ByTitle/" + document_name + '/';
            response = await fetch(request_link).then(response => response.json());
            result_doc_list = response['result_doc_list']
            await showDetailsDataExact(result_doc_list, document_id, document_name, "TitleSimSearchTable")
            stopBlockUI('TitleSimSearchTable', 'جدول اسناد مشابه')

        }


        async function showDetailsDataExact(sim_doc_list, document_id, document_name, table_id) {

            /* Title Text */
            const src_document_link = 'http://' + location.host + "/information/?id=" + document_id;
            let src_document_tag = "<a target='to_blank' href='" + src_document_link + "'>" + document_name + "</a>";

            /* Body Text */
            document.getElementById(table_id).innerHTML = '';
            dest_para_tag = ''
            index = 1
            document_result = []

            //-------- find max score -------------
            max_score = 0
            for (doc of sim_doc_list) {
                doc_sim = Math.round((doc[2] * 100)) / 100
                if (doc_sim > max_score) {
                    max_score += doc_sim
                }
            }
            // ---------------------------------------

            for (doc of sim_doc_list) {
                doc_id = doc[0]
                doc_name = doc[1]
                doc_sim = Math.round((doc[2] * 100)) / 100

                doc_sim = Math.round(((doc_sim / max_score) * 100)) / 100

                let detail = '<button type="button" class="btn modal_btn">جزئیات</button>'


                if (table_id == 'ParaSimSearchTable') {
                    sim_para_count = doc[3]
                    select_function = `SelectParaSimFunction('${doc_id}','${doc_name}', '${document_id}')`;

                    detail = '<button type="button" class="btn modal_btn" onclick="' + select_function + '">انتخاب</button>'

                    if (sim_para_count == 0)
                        detail = '<button type="button" disabled class="btn modal_btn" onclick="' + select_function + '">انتخاب</button>'

                }


                if (table_id == 'LabelSimSearchTable') {
                    sim_para_count = doc[3]
                    const detail_function = `DetailLabelSimFunction('${doc_id}','${doc_name}', '${document_id}')`;

                    detail = '<button type="button" class="btn modal_btn"  onclick="' + detail_function + '">جزئیات</button>'


                }

                const document_link = 'http://' + location.host + "/information/?id=" + doc_id
                doc_name = '<a target="_blank" href="' + document_link + '">' + doc_name + "</a>"


                // if (doc_sim < 100) {
                //     doc_sim = "خیلی کم"
                // }
                // else if (doc_sim < 200) {
                //     doc_sim = "کم"
                // }
                // else if (doc_sim < 300) {
                //     doc_sim = "متوسط"
                // }
                // else if (doc_sim < 400) {
                //     doc_sim = "زیاد"
                // }
                // else if (doc_sim < 500) {
                //     doc_sim = "خیلی زیاد"
                // }



                let row = {

                    "index": index,
                    "doc_id": doc_id,
                    "doc_name": doc_name,
                    "doc_sim": doc_sim,
                    "detail": detail
                }

                document_result.push(row)
                index += 1
            }


            $('#' + table_id).empty();

            if (table_id == 'LabelSimSearchTable' || table_id == 'ParaSimSearchTable') {
                $('.' + table_id).footable({
                    "paging": {
                        "enabled": true
                    },
                    "filtering": {
                        "enabled": false
                    },
                    "sorting": {
                        "enabled": true
                    },
                    "empty": "سندی یافت نشد.",
                    "columns": [{
                        "name": "index",
                        "title": "ردیف",
                        "breakpoints": "xs sm",
                        "type": "number",
                        "style": {
                            "width": "5%"
                        }
                    }, {
                        "name": "doc_name",
                        "title": "نام سند",
                        "style": {
                            "width": "35"
                        }
                    }
                        // , {
                        //     "name": "doc_sim",
                        //     "title": "امتیاز",
                        //     "style": {
                        //         "width": "10%"
                        //     }
                        // },
                        , {
                        "name": "detail",
                        "title": "جزئیات",
                        "style": {
                            "width": "10%"
                        }
                    }
                    ],
                    "rows": document_result
                });


            }
            else {
                $('.' + table_id).footable({
                    "paging": {
                        "enabled": true
                    },
                    "filtering": {
                        "enabled": false
                    },
                    "sorting": {
                        "enabled": true
                    },
                    "empty": "سندی یافت نشد.",
                    "columns": [{
                        "name": "index",
                        "title": "ردیف",
                        "breakpoints": "xs sm",
                        "type": "number",
                        "style": {
                            "width": "5%"
                        }
                    }, {
                        "name": "doc_name",
                        "title": "نام سند",
                        "style": {
                            "width": "35"
                        }
                    }
                        // , {
                        //     "name": "doc_sim",
                        //     "title": "امتیاز",
                        //     "style": {
                        //         "width": "10%"
                        //     }
                        // },

                    ],
                    "rows": document_result
                });


            }


            // document.getElementById("DestDocumentParagraph").innerHTML = '<ul>' + dest_para_tag + '</ul>';




            // document.getElementById("DetailText").innerHTML = '<p class="m-4">'+supervisions_text+'</p>';
            popup_handler();
        }

        async function DetailLabelSimFunction(doc2_id, doc2_name, doc1_id) {
            document.getElementById("LabelSimModalBody").innerHTML = ""
            $('#LabelSimModal').modal('show');

            /* Title Text */
            const selected_document_link = 'http://' + location.host + "/information/?id=" + doc2_id;
            let selected_document_tag = "<a target='to_blank' href='" + selected_document_link + "'>" + doc2_name + "</a>";

            document.getElementById("LabelSimModalHeader").innerHTML = "<span class='text-secondary'>" + " سند انتخابی: " + "</span>" + selected_document_tag

            let request_link = 'http://' + location.host + "/GetDetail_DoticSimDocument_ByLabels/" + doc1_id + '/' + doc2_id + '/';
            let response = await fetch(request_link).then(response => response.json());
            let paragraph_list = response['result_para']
            console.log(paragraph_list)
            body_tag = ""
            for (para of paragraph_list) {


                paragraph_id = para['_source']['paragraph_id']
                paragraph = para["highlight"]["attachment.content"][0]


                paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + paragraph_id;

                paragraph_tag = "<a class='' title = 'پروفایل حکم' target='blank' href='" + paragraph_link + "'>" + paragraph + "</a>"

                // profile_tag = paragraph

                tag = "<li class='mb-3 lh-lg'>" + paragraph_tag + "</li>"
                body_tag += tag


            }

            if (body_tag == "") {
                body_tag = "<h5 class='mt-5 text-center text-secondary'>عبارت موردنظر در متن سند یافت نشد.</h5>"
            }

            document.getElementById("LabelSimModalBody").innerHTML += "<ul>" + body_tag + "</ul>"



        }

        async function SelectParaSimFunction(doc2_id, doc2_name, doc1_id) {
            document.getElementById("LabelSimModalBody").innerHTML = ""
            startFullPageBlockUI();
            /* Title Text */
            const dest_document_link = 'http://' + location.host + "/information/?id=" + doc2_id;
            let dest_document_tag = "<a target='to_blank' href='" + dest_document_link + "'>" + doc2_name + "</a>";
            document.getElementById("LabelSimModalHeader").innerHTML = "<span class='text-secondary'>" + " سند انتخابی: " + "</span>" + dest_document_tag

            $('#LabelSimModal').modal('show');
            let request_link = 'http://' + location.host + "/GetParaSimilarity/" + doc1_id + '/' + doc2_id + '/';
            let response = await fetch(request_link).then(response => response.json());
            let sim_para_list = response['result']

            /* Body Text */
            tag = ''
            for (row of sim_para_list) {
                src_para = row['src_para']
                dest_para = row['dest_para']
                dest_doc_id = row['dest_doc_id']
                dest_doc_name = row['dest_doc_name']

                dest_doc_link = 'http://' + location.host + "/book_information/?id=" + dest_doc_id
                dest_doc_tag = '<a style="text-decoration:none;" href="' + dest_doc_link + '">' + dest_doc_name + "</a>"


                score = row['score']
                tag += '<div class="mb-2 px-2 pt-2 border-bottom border-2 rounded">' +
                    '<p class="text-secondary">' + 'پاراگراف مبدأ: ' + '</p>' + '<p>' + src_para + '</p>' +
                    '<p class="text-secondary">' + 'امتیاز شباهت: ' + '<span class="text-primary bold">' + score + '</span>' + '</p>' +
                    '<span class="text-secondary">' + 'پاراگراف مشابه در سند ' +
                    '<span class="bold">' + dest_doc_tag + ':</span>' + '</span>' +
                    '<p class="mt-1">' + dest_para + '</p>' +
                    '</div>'
            }
            document.getElementById("LabelSimModalBody").innerHTML = tag
            stopFullPageBlockUI('انتخاب سند')
        }



        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }
        }
    </script>
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>
    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = document.getElementById('country').value
            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            save_file_name += " مجموعه سند {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            for (const document of file_name_list) {
                const document_name = document["_source"]["raw_file_name"] + extension
                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI('دانلود اسناد');
        }


        async function DownloadSerachResultFunction() {

            const save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var csv = "";


            sep = ","

            let Csv = "نام سند" + sep + "نوع سند" + sep +
                "برچسب سند" + sep + "سال سند" + "\n"

            for (const document of SearchResultValue) {
                Csv += document['_source']["name"].replaceAll(',', '-') + sep + document['_source']["type"].replaceAll(',', '-') + sep + document['_source']['labels'].toString().replaceAll(',', '-') + sep +
                    document['_source']["rahbari_year"].replaceAll(',', '-') + "\n"

            }

            let save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
            save_file_name += " مجموعه سند {" + document.getElementById("country").innerText + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }


        async function createKeywordsGraphData(keywords_information_result) {

            nodes = []
            edges = []
            chart_data = []

            for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {

                if (documents_list.length > 1) {
                    common_keyword_node = {
                        'id': keyword, 'name': keyword, 'fill': {
                            'src': "../../static/icons/question1.png"
                        }, 'group': 'common_keyword'
                    }
                    nodes.push(common_keyword_node);
                } else {
                    keyword_node = { 'id': keyword, 'name': keyword, 'group': 'keyword' };
                    nodes.push(keyword_node);
                }

                for (doc_info of documents_list) {
                    const document_id = doc_info["id"]
                    const document_name = doc_info["name"]
                    const document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
                    const doc_name = '<a target="_blank" href="' + document_link + '">' + document_name + "</a>"

                    document_node = {
                        'id': document_id, 'name': document_name, 'fill': {
                            'src': "../../static/icons/docs.png"
                        }, 'group': 'document'
                    }
                    nodes.push(document_node);

                    edge = {
                        'id': document_id + '__' + keyword,
                        'from': document_id,
                        'to': keyword,
                        'from_name': document_name
                    };

                    edges.push(edge);
                }


            }

            chart_data = {
                'nodes': nodes,
                'edges': edges
            }


            showKeywordsGraph('definition_keywords_graph_container', chart_data)

        }



        async function showKeywordsGraph(chart_container, chart_data) {


            document.getElementById(chart_container).innerHTML = ''
            // create a chart and set the data
            var chart = anychart.graph(chart_data);

            // set the container id
            chart.container(chart_container);

            // configure labels of keywords
            let keywords = chart.group("keyword");
            let common_keywords = chart.group("common_keyword");
            let documents = chart.group("document");



            if (common_keywords != undefined) {
                common_keywords.normal().height(35);
                common_keywords.hovered().height(40);
                common_keywords.selected().height(40);
                common_keywords.normal().stroke(null);

                common_keywords.labels().enabled(true);
                common_keywords.labels().format("{%id}").fontFamily('vazir');
                common_keywords.labels().fontSize(14);
                common_keywords.labels().fontWeight(600);
            }


            if (documents != undefined) {
                documents.normal().height(35);
                documents.hovered().height(40);
                documents.selected().height(40);
                documents.normal().stroke(null);
            }

            chart.nodes().tooltip().format("{%name}");
            chart.edges().tooltip().format(" سند:  {%from_name} \n کلیدواژه:  {%to}");
            chart.edges().tooltip().fontFamily('vazir');
            chart.nodes().tooltip().fontFamily('vazir');

            // initiate drawing the chart
            chart.draw();

            chart.listen("mouseOver", function (e) {
                document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function (e) {
                document.body.style.cursor = "auto";
            });

            chart.listen('Click', async function (event) {

                const click_tag = event.domTarget.tag;
                if (click_tag["type"] === "node") {

                    // window.open('http://' + location.host + "/document_profile?id=" + click_tag["id"]);
                } else if (click_tag["type"] === "edge") {

                    edge_data = click_tag["id"].split('__');
                    doc_id = edge_data[0]
                    keyword = edge_data[1]

                    const link = 'http://' + location.host + "/GetKeywordsGeneralDefinitionByDocumentId/" + doc_id + "/" + keyword + "/";
                    response = await fetch(link).then(response => response.json());
                    response = response['keyword_information']

                    document.getElementById('EdgeModalHeader').innerText = 'کلیدواژه: ' + keyword

                    paragraph_text = response['croped_text']
                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ':', keyword_tag)

                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ' :', keyword_tag)


                    const document_address = 'http://' + location.host + "/document_profile/?id=" + response["doc_id"]
                    const document_link = '<a target = "to_blank" href = "' + document_address + '">' + response["doc_name"] + ':</a>'

                    doc_tag = '<h6 class="bold">' + document_link + '</h6>'
                    paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'

                    document.getElementById('EdgeModalText').innerHTML = '<ol start="1"> ' + paragraph_tag + '</ol>';

                    $('#EdgeModalBtn').click();

                }

            })

        }

        /* Search after press Enter */
        $("#info_form").submit(function () { return false; });
        $("#SearchBox").keyup(function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                $("#document_search").click();
            }
        });


        // Column Interactivity

        async function GetClickedColumnDocuments(position, column_value) {
            startFullPageBlockUI();
            document.getElementById("ChartModalBodyText_2").innerHTML = ""
            RESULT_DOCUMENTS = []
            await load_documents(position, column_value, 1, RESULT_DOCUMENTS)

            stopFullPageBlockUI('کلیک روی نمودار');
        }

        async function load_documents(position, column_value, next_page_number, RESULT_DOCUMENTS) {

            Doc_Field = CHART_FIELD_DICT[position]

            label_name_list = [ColumnUserSearchParameters.label_name]
            type_name = ColumnUserSearchParameters.type_name
            from_year = ColumnUserSearchParameters.from_year
            to_year = ColumnUserSearchParameters.to_year

            header = ""
            let save_file_name = "";

            if (Doc_Field == 'label_name') {

                header = "برچسب: " + column_value
                if (!label_name_list.includes(column_value))
                    label_name_list.push(column_value)

                save_file_name += " (مجموعه سند {1} و برچسب {2})".replace("1", "اسناد رهبری").replace("2", column_value)

            } else if (Doc_Field == 'type_name') {

                header = "نوع سند: " + column_value
                type_name = column_value
                save_file_name += " (مجموعه سند {1} و نوع سند {2})".replace("1", "اسناد رهبری").replace("2", column_value)

            } else if (Doc_Field == 'rahbari_year') {

                header = "سال اسناد: " + column_value
                save_file_name += " (مجموعه سند {1} و سال اسناد {2})".replace("1", "اسناد رهبری").replace("2", column_value)

                if (column_value == 'نامشخص') {
                    from_year = "0"
                    to_year = "0"
                } else {
                    from_year = to_year = column_value
                }


            }
            label_name_list = label_name_list.toString();

            request_link = 'http://' + location.host + "/Search_Rahbari_Column_ES/"
                + ColumnUserSearchParameters.country_id + "/"
                + type_name + "/"
                + label_name_list + "/"
                + from_year + "/"
                + to_year + "/"
                + "0" + "/"
                + "عنوان یا متن" + "/"
                + "empty" + "/"
                + "exact" + "/"
                + next_page_number + "/"
                + SEARCH_RESULT_SIZE + "/"

            let response = await fetch(request_link).then(response => response.json());
            result_documents = response['result']
            total_hits = response['total_hits']
            curr_page = response['curr_page']

            RESULT_DOCUMENTS = RESULT_DOCUMENTS.concat(result_documents);


            /* download file creation */
            document.getElementById("DownloadDocuments").onclick = function () {
                downloadFiles(RESULT_DOCUMENTS, save_file_name);
            };

            /* export into excel files */
            document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {
                // startFullPageBlockUI()

                var csv = "";

                sep = ","
                let Csv = "نام سند" + sep + "نوع سند" + sep +
                    "برچسب سند" + sep + "سال سند" + "\n"

                for (const document of RESULT_DOCUMENTS) {
                    Csv += document['_source']["name"].replaceAll(',', '-') + sep + document['_source']["type"].replaceAll(',', '-') + sep + document['_source']['labels'].toString().replaceAll(',', '-') + sep +
                        document['_source']["rahbari_year"].replaceAll(',', '-') + "\n"

                }

                let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                var link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", save_file_name + ".csv");
                document.body.appendChild(link);
                link.click()
                // stopFullPageBlockUI('خروجی اکسل');

            };


            await update_column_pagination_input(curr_page, total_hits);
            max_page = parseInt(document.getElementById("ColumnModalPaginationInput_2").max)

            document.getElementById("ChartModalHeader_2").innerText = header
            document.getElementById("DocsCount_2").innerText = total_hits + " سند:"

            await show_modal_documents(result_documents, position, column_value, curr_page, max_page, RESULT_DOCUMENTS);


        }

        async function show_modal_documents(result_documents, position, column_value, curr_page, max_page, RESULT_DOCUMENTS) {


            let filtered_result_tag = ""
            let list_of_docId = ""

            for (const doc of result_documents) {
                const link = 'http://' + location.host + "/document_profile/?id=" + doc["_source"]["document_id"]
                let tag = "<li class='mt-3' id=" + doc["_source"]["document_id"] + "><a target='blank' href='" + link + "'>" + doc["_source"]["name"] + "</a></li>"
                filtered_result_tag += tag
                list_of_docId += doc["document_id"] + "_"
            }

            index = (curr_page - 1) * SEARCH_RESULT_SIZE + 1;

            filtered_result_tag = "<ol start='" + index + "'>" + filtered_result_tag + "</ol>"
            document.getElementById("ChartModalBodyText_2").innerHTML += filtered_result_tag

            if (curr_page >= max_page) {
                $("#LoadMoreDocuments_2").hide();
            } else {
                $("#LoadMoreDocuments_2").show();
            }

            /* LoadMoreDocuments_2 */
            document.getElementById("LoadMoreDocuments_2").onclick = function () {

                next_page_number = ColumnModalNextPage(curr_page);
                load_documents(position, column_value, next_page_number, RESULT_DOCUMENTS);

            };


        }

        async function update_column_pagination_input(curr_page, total_hits) {

            page_count = 0;

            if (total_hits < SEARCH_RESULT_SIZE) {
                page_count = 1

            } else if (total_hits < MAX_RESULT_WINDOW) {
                page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

            } else if (total_hits >= MAX_RESULT_WINDOW) {
                page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
            }

            document.getElementById("ColumnModalPaginationInput_2").min = 1;
            document.getElementById("ColumnModalPaginationInput_2").max = page_count;
            document.getElementById("ColumnModalPaginationInput_2").value = curr_page;

        }

        function ColumnModalNextPage(curr_page) {


            next_page_number = curr_page;
            max_page_number = parseInt(document.getElementById("ColumnModalPaginationInput_2").max);

            if (next_page_number < max_page_number) {
                next_page_number = curr_page + 1
            }

            document.getElementById("ColumnModalPaginationInput_2").value = next_page_number

            return next_page_number;

        }

    </script>


</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/search/search_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/signout_function.js"></script>





</html>