<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-radar.min.js"></script>

    <script src="../../static/library/anychart-base.min-8.10.0.js"></script>
    <!-- <script src="../../static/library/anychart-8.10.0-exports.min.js"></script> -->
    <script src="../../static/library/anychart-ui.min-8.10.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/anychart-ui.min-8.10.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/anychart-font.min-8.10.0.css">

    <script src="../../static/library/anychart-8.10.0-tag-cloud.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-heatmap.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <script src="./../static/js/graph/g6.min.js"></script>
    <script src="../../static/library/jquery-ui.min-1.11.4.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">



    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>

    <meta charset="UTF-8">
    <title>تحلیل هوشمند موضوعی</title>
    {% include "doc/title_icon.html" %}
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#RahbariDropdown').addClass('active');
            $('#rahbari_topic').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <div class="d-flex align-items-center rtl flex-row-reverse mx-auto p-1" style="background: linear-gradient(#8693AB, #cbd3da, #e9ecef); box-shadow: 0 0 2px 2px #f8f9fa inset; border: 4px solid #f8f9fa; border-radius: 24px">
            <img style="width: 120px;" id="prefix_ShowHideImg" src="../../static/image/rahbar_profile.png">
            <div class="d-flex flex-column gap-2 rtl mr-2" dir="rtl">
                <span class="font-weight-bolder">تحلیل اسناد رهبری</span>
                <span>صفحه تحلیل هوشمند موضوعی</span>
            </div>
        </div>
        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>
            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">
                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}

                        {% if v == 'اسناد رهبری' %}
                        <option value="{{ k }}">{{ v }}</option>

                        {% endif %}

                        {% endfor %}
                    </select>
                </div>

                <!-- Match Type -->
            <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">
                <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع الگوریتم:</label>
                <select id="AlgorithmTypeSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    <option selected value="LDA">LDA</option>
                    <option value="K-Means">K-Means</option>
                </select>
            </div>

                <!-- Cluster Size  -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">
                    <label class="text-right bg-light float-right" style="direction: rtl;;">تعداد خوشه‌ها:</label>
                    <select id="Cluster_Count_Select" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        نمایش
                    </button>
                </div>
            </div>
        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">موضوعات</button>
                </li>

                <!-- <li class="nav-item float-right" role="presentation">
                    <button id="centroids_result_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#centroids_result_pane" type="button" role="tab"
                        aria-controls="centroids_result_pane" aria-selected="false">تحلیل مراکز خوشه‌ها</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="centroids_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#centroids_graph_pane" type="button" role="tab"
                        aria-controls="centroids_graph_pane" aria-selected="false">گراف مراکز خوشه‌ها</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="clustersKeywords_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#clustersKeywords_graph_pane" type="button" role="tab"
                        aria-controls="clustersKeywords_graph_pane" aria-selected="false">گراف خوشه کلیدواژه</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="without_subject" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#doc_without_subject_pane" type="button" role="tab"
                        aria-controls="doc_without_subject_pane" aria-selected="false">احکام بدون موضوع</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="different_subject" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#doc_different_subject_pane" type="button" role="tab"
                        aria-controls="doc_different_subject_pane" aria-selected="false">احکام با موضوع متفاوت</button>
                </li> -->


                <!-- Download Buttons -->
                <!--                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"-->
                <!--                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"-->
                <!--                    type="button">-->
                <!--                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>-->

                <!--                </button>-->

                <!-- <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل جدول" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button> -->

                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>


            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Table Headers -->
                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right">

                            <select id="ColumnSelect"
                                class=" form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">

                            </select>

                        </div>

                        <!-- Page select -->
                        <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled="true" onchange="TablePaginationChanged(event)"
                                id="TablePaginationInput" min="1" max="1" value="1"
                                class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        <!-- Result Pagination -->
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p>

                    </div>

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

                <div id="doc_without_subject_pane" class="tab-pane w-100 fade show float-right" role="tabpanel"
                    aria-labelledby="without_subject">

                    <div dir="rtl" class="table-responsive mt-4">
                        <table id="WithoutSubjectTableId" style="min-height: 200px;"
                            class="table table-striped WithoutSubjectTable">
                        </table>
                    </div>
                </div>

                <!-- Centroids Pane -->
                <div id="centroids_result_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="centroids_result_tab">

                    <div id="cluster_size_chart_container" class="full">
                    </div>

                    <!-- Members Count Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        فاصله مراکز خوشه‌ها
                    </h5>
                    <br>
                    <div id="heatmap_chart_container" style="height: 85vh" class="bg-white w-100 p-4">
                    </div>

                </div>


                <!-- ------------------------------- -->

                <!-- Centroids-Graph Pane -->
                <div id="centroids_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="centroids_graph_tab">

                    <!-- Graph Between Clusters -->
                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">

                        <div id="centroids_constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">
                            <div id="centroids_WeightDiv" class="col-md-12 p-1 col-12 col-lg-12 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="centroids_WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper" style="width: 100% !important;">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex">
                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">نحوه نمایش</label>
                                </div>
                                <div class="source_container p-4 row mx-auto">

                                    <select id="centroids_ChangeLayout" name="centroids_ChangeLayout"
                                        class="form-select text-right float-right searchable-select"
                                        style="direction: rtl;">

                                        <option value="grid">مربعی</option>
                                        <option value="circular"> دایره ای </option>
                                        <option value="force">ساده</option>
                                        <option value="dagre">بالا به پایین</option>
                                        <option value="radial">شعاعی</option>
                                        <option value="concentric">متحدالمرکز</option>
                                        <option value="comboForce">خوشه ای</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">جستجو در نام گره</label>
                                </div>
                                <div class="source_container p-4 d-flex">
                                    <input style="direction: rtl;" class="form-control text-right"
                                        placeholder="جستجو در نام گره ها ..." type="text" required=""
                                        name="centroids_SearchBox" id="centroids_SearchBox" value="">
                                    <button type="button" id="centroids_SearchBtn"
                                        class="btn modal_btn mr-2">جست‌وجو</button>
                                </div>
                            </div>


                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-1 d-flex">

                            </div>
                        </div>

                        <div dir="ltr">

                            <img style="width: 4%; cursor: pointer; margin-top: 20px;" id="centroids_SelectNeighbourImg"
                                src="../../static/image/neighbourhood.png">
                            <img style="width: 3%; cursor: pointer; margin-top: 20px;" id="centroids_ShowHideImg"
                                src="../../static/image/hide_nodes.png">

                        </div>

                        <div id="centroids_graph_container" class="border mt-1 position-static"
                            style="height:500px; overflow: hidden;">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="centroids_selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="centroids_selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>

                    </div>

                </div>


                <!-- Cluster-Keywords Pane -->
                <div id="clustersKeywords_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="clustersKeywords_graph_tab">

                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">

                        <div id="clustersKeywords_constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">

                            <div id="clustersKeywords_DegreeDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر درجه</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="clustersKeywords_DegreeSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="clustersKeywords_WeightDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="clustersKeywords_WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="d-flex">
                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">نحوه نمایش</label>
                                </div>
                                <div class="source_container p-4 row mx-auto">
                                    <select id="clustersKeywords_ChangeLayout" name="clustersKeywords_ChangeLayout"
                                        class="form-select text-right float-right searchable-select"
                                        style="direction: rtl;">
                                        <option value="grid">مربعی</option>
                                        <option value="circular"> دایره ای </option>
                                        <option value="force">ساده</option>
                                        <option value="dagre">بالا به پایین</option>
                                        <option value="radial">شعاعی</option>
                                        <option value="concentric">متحدالمرکز</option>
                                        <option value="comboForce">خوشه ای</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">جستجو در نام گره</label>
                                </div>
                                <div class="source_container p-4 d-flex">
                                    <input style="direction: rtl;" class="form-control text-right"
                                        placeholder="جستجو در نام گره ها ..." type="text" required=""
                                        name="clustersKeywords_SearchBox" id="clustersKeywords_SearchBox" value="">
                                    <button type="button" id="clustersKeywords_SearchBtn"
                                        class="btn modal_btn mr-2">جست‌وجو</button>
                                </div>
                            </div>


                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-1 d-flex">

                            </div>
                        </div>

                        <div dir="ltr">
                            <img style="width: 4%; cursor: pointer; margin-top: 20px;"
                                id="clustersKeywords_SelectNeighbourImg" src="../../static/image/neighbourhood.png">
                            <img style="width: 3%; cursor: pointer; margin-top: 20px;" id="clustersKeywords_ShowHideImg"
                                src="../../static/image/hide_nodes.png">
                        </div>

                        <div id="clustersKeywords_graph_container" class="border mt-1 position-static"
                            style="height:500px; overflow: hidden;">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="clustersKeywords_selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="clustersKeywords_selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>

                    </div>

                </div>


                <!-- Doc Different Subject Pane -->
                <div id="doc_different_subject_pane" class="tab-pane w-100 fade show float-right" role="tabpanel"
                    aria-labelledby="doc_different_subject">

                    <div dir="rtl" class="table-responsive mt-4">
                        <table id="DifferentSubjectTableId" style="min-height: 200px;"
                            class="table table-striped DifferentSubjectTable">
                        </table>
                    </div>
                </div>


            </div>





        </div>
    </div>

     <!-- Distributions Modal Container -->
     <div class="modal fade" id="distributionsModal">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="DistModalHeader" class="modal-title">تحلیل توزیعی</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="dist_chart_info" class="modal-body bg-light text-justify">
                    <div class="charts-list-container">
                        <div id="subject_container" class="half"></div>
                        <!-- <div id="approval_container" class="half"></div> -->
                        
                        <div id="level_container" class="half"></div>
                        <div id="year_container" class="full"></div>
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">

                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button> -->
                </div>

            </div>
        </div>
    </div>


    <!-- Details Modal Container -->
    <button type="button" id="detailModal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#KmeansdetailModal"></button>
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="KmeansModalHeader" class="modal-title">ابر واژگان</h5>
                    <div id="kmeans_topic_keywords_container" class="w-80 text-right" dir="rtl"></div>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <h6 id="KmeansDocsCount" class='text-secondary'></h6>

                    <div id="KmeansDetailText" class="bg-light text-justify mx-2 h-100">
                    </div>

                    <button id="KmeansLoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left" style="color: #0e3f8b"><i
                            class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش بیش‌تر</button>

                </div>
                <!-- Modal footer -->
                <div id="detail_modal_footer" dir="ltr" class="modal-footer">


                    <input type="number" id="ColumnModalPaginationInput" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none">

                    <!-- <button id="close_btn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button> -->

                    <button id="ExportExcel2" onclick="TopicParagraphs_Excel()"
                        class="btn btn-outline-primary float-left"><i class="fa fa-download"></i>
                        خروجی اکسل احکام
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="SelectDocumentModal">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title"></h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ModalBody" class="modal-body text-justify">
                    <div class="container">
                        <table id="PopUpTable" class="table table-striped LDAPopUpTable">
                        </table>
                        <span class="add-row"></span>
                    </div>
                </div>
                <!-- Modal footer -->
                <div dir="ltr" class="modal-footer">
                    
                    <button id="ExportExcel2" disabled class="btn btn-outline-secondary"><i class="fa fa-download"></i> خروجی اکسل احکام
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="subjectDetailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="CloudHeader" class="modal-title">ابر واژگان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div id="DetailText" class="full">
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button> -->
                </div>

            </div>
        </div>
    </div>
    

    <div class="modal fade" id="detailModalCloud">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="CloudHeader" class="modal-title">ابر واژگان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div id="DetailTextCloud" class="bg-light text-justify mx-2 h-100">
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button> -->
                </div>

            </div>
        </div>
    </div>

    <!-- ANOVA Word Modal Container -->
    <div class="modal fade" id="anova_word_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="anova_word_ModalHeader" class="modal-title">ابر واژگان</h5>
                    <div id="anova_word_topic_keywords_container" class="w-80 text-right" dir="rtl"></div>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <h6 id="anova_word_DocsCount" class='text-secondary'></h6>

                    <div id="anova_word_DetailText" class="bg-light text-justify mx-2 h-100">
                    </div>

                    <button id="anova_word_LoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left"
                        style="color: #0e3f8b"><i class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش
                        بیش‌تر</button>

                </div>
                <!-- Modal footer -->
                <div id="detail_modal_footer" dir="ltr" class="modal-footer">


                    <input type="number" id="anova_word_ColumnModalPaginationInput" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none">

                    <button id="anova_word_ExportExcel2" class="btn btn-outline-primary float-left"><i
                            class="fa fa-download"></i>
                        خروجی اکسل احکام
                    </button>

                </div>

            </div>
        </div>
    </div>

   
    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

</body>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">
<script src="../../static/js/column.js"></script>
<script src="../../static/js/ChartColumnInteractivity.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../../static/js/GraphClass.js"></script>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>


<script>
    CLUSTERS_DATA = {}

    CURRENT_TOPIC_ID = 0;
    CLUSTERING_ALG_ID = 0;

    MAX_RESULT_WINDOW = 5000
    SEARCH_RESULT_SIZE = 25

    CHART_FIELD_DICT = {
        "subject_container": "keyword_subject",
        "level_container": "level_name",
        "year_container": "approval_year",
        "approval_container": "approval_reference_name",
    }
    CHART_NAME_DICT = {
        "subject_container": "موضوع با کلیدواژه",
        "level_container": "سطح احکام",
        "year_container": "سال تصویب احکام",
        "approval_container": "مرجع تصویب احکام",
    }

    COUNTRY_CLUSTER_COUNT_DICT = {
        "اسناد رهبری": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50],
        "فاوا": [5, 10, 15, 20, 25],
        "هوش‌یار- قوانین": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50,
            60, 70, 80, 90, 100]
    }
    
    TABLE_INFO = []
    const COLUMNS = {
        "cloud": "ابر واژگان",
        "detail": "مشاهده احکام",
        "entropy": "آنتروپی",
        "subject": "موضوع غالب (براساس کلیدواژگان)"
    }
    initSearchableSelects();
    append_column(COLUMNS);


    let topic_response = []

    container_id_list = ['SearchTable','DifferentSubjectTableId',
        'heatmap_chart_container',
        'centroids_graph_container',
        'clustersKeywords_graph_container'
    ]

    //user log
    let form_data = new FormData()
    let detail_type = "نمایش پنل"
    form_data.append('detail_type', detail_type);
    UserLog(form_data)


    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }
    

    async function CountryChanged() {


        const country_name = $("#country option:selected").text();

        num_topic = COUNTRY_CLUSTER_COUNT_DICT[country_name]

        const options = []
        for (i of num_topic) {
            options.push({value:i, text:i})
        }
         syncSelectOptions("Cluster_Count_Select", options);

        // await ShowResult();

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)


    }
    CountryChanged()

    async function ShowResult() {
        clearPrevResults(container_id_list);
        notyf.dismissAll();
        
        startBlockUI('SearchTable');

        const number_of_topic = document.getElementById("Cluster_Count_Select").value;
        const AlgoType = document.getElementById("AlgorithmTypeSelect").value;
        const username = getCookie("username");
        const country_id = document.getElementById("country").value
        const vector_type = "TF-IDF"
        const ngram_type = "(1, 1)"

        if(AlgoType == "K-Means"){
            let request_link = 'http://' + location.host + "/GetParagraph_Clusters/" + country_id + "/"
            + AlgoType + "/" + vector_type + "/" + number_of_topic + "/"+ ngram_type + "/" + username + "/";

            let response = await fetch(request_link).then(response => response.json());
            CLUSTERS_DATA = response["clusters_data"]
            CLUSTERING_ALG_ID = response["clustering_algorithm_id"]
            TABLE_INFO = response["table_data"]
            document.getElementById("DocumentCount").innerText = ""

            await show_kmeans_table_result()

        }
        else{
            let request_link = 'http://' + location.host + "/AIGetLDATopic/" + country_id + "/" + number_of_topic + "/" + username + "/";
            let response = await fetch(request_link).then(response => response.json());
            topic_response = response['lda_topics']
            all_para_count = response["all_para_count"]
            console.log(all_para_count)
            await showDocumentInformation(topic_response,all_para_count);
        }

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name = $("#country option:selected").text();
        let cluster_size = $("#Cluster_Count_Select option:selected").text();
        let algo_type = $("#AlgorithmTypeSelect option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name', country_name);
        form_data.append('algo_type', algo_type);
        form_data.append('cluster_size', cluster_size);
        UserLog(form_data)
 


        stopBlockUI('SearchTable', 'موضوعات');


        // //------------------ Heatmap & Size charts -----------------------------
        // startBlockUI('heatmap_chart_container');
        // startBlockUI('cluster_size_chart_container');

        // request_link = 'http://' + location.host + "/AIGet_Topic_Centers_CahrtData/" + country_id + "/" + number_of_topic + "/";
        // response = await fetch(request_link).then(response => response.json());

        // cluster_size_chart_data = response['cluster_size_chart_data']
        // heatmap_chart_data = response['heatmap_chart_data']
        // show_heatmap_charts('heatmap_chart_container', heatmap_chart_data);

        // Centroids_showChart(cluster_size_chart_data, "cluster_size_chart_container", false, "خوشه", "تعداد پاراگراف")
        
        // stopBlockUI('heatmap_chart_container', 'فاصله مراکز خوشه‌ها');
        // stopBlockUI('cluster_size_chart_container', 'توزیع اندازه خوشه‌ها');
        // //------------- Show Graph Between Centroid --------------------------------
        
        // startBlockUI('centroids_graph_pane');

        // await showCentroidGraph("centroids_graph_container")

        // stopBlockUI('centroids_graph_pane', 'گراف مراکز خوشه‌ها');

        // // -----------------------------------------------------------
        // startBlockUI('clustersKeywords_graph_pane');

        // await showClusterKeywordGraph("clustersKeywords_graph_container")

        // stopBlockUI('clustersKeywords_graph_pane', 'گراف خوشه کلیدواژه');
        // //------------------ documentsDifferenceSubjectLDA -----------------------------
        // startBlockUI('DifferentSubjectTableId');

        // request_link3 = 'http://' + location.host + "/AI_predict_subject_LDA/" + country_id + "/" + number_of_topic + "/"
        // response3 = await fetch(request_link3).then(response3 => response3.json());
        // documents_without_subject = response3["documentsWithoutSubjectLDA"]
        // documents_difference_subject = response3["documentsDifferenceSubjectLDA"]


        // await showWithoutSubjectTable(documents_without_subject);
        // await showDifferenceSubjectTable(documents_difference_subject);
        // stopBlockUI('DifferentSubjectTableId', 'احکام با موضوع متفاوت');

        

       
    }


    async function show_kmeans_table_result() {
        selected_columns = ["id", "user_label", "cluster_name", "word_list", "cluster_size"]
        selected_columns = find_selected_column(selected_columns)


        columns = [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            },{
            "name": "cluster_name",
            "title": "نام خوشه",
        }, {
            "name": "word_list",
            "title": "موضوع (20 کلمه کلیدی)",
        }, {
            "name": "cluster_size",
            "title": "تعداد احکام",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cloud",
            "title": "ابر واژگان",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "detail",
            "title": "احکام مرتبط",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "anova",
            "title": "واژگان متمایزکننده (ANOVA)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "cluster_entropy",
            "title": "آنتروپی",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cluster_frequent_keyword_subject",
            "title": "موضوع غالب (براساس کلیدواژگان)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "distributions",
            "title": "تحلیل توزیعی",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "user_label",
            "title": "برچسب پیشنهادی",
            "style": {
                "width": "10%"
            }
        },]

        if (!selected_columns.includes("all")) {
            for (let column of columns) {
                if (selected_columns.includes(column["name"])) {
                    column["visible"] = true
                } else {
                    column["visible"] = false
                }
            }
        }


        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },

            "filtering": {
                "enabled": true,
                "placeholder": "نام کلیدواژه ...",
                "filters": [{
                    "name": "my-filter",
                    "query": $('.form-control').val(),
                    "columns": ["word_list"]
                }]
            },

            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

    }



    async function showCentroidGraph(container) {
        $('#selected_node_table').empty();
        $('#selected_edge_table').empty();

        const country_id = document.getElementById("country").value;
        const number_of_topic = document.getElementById("Cluster_Count_Select").value;


        let request_link = 'http://' + location.host + "/GetLDAGraphData/" + country_id + "/" + number_of_topic + "/"
        let response = await fetch(request_link).then(response => response.json());

        const Nodes_data = response["Nodes_data"]
        const Edges_data = response["Edges_data"]

        container = document.getElementById(container);
        const width = 0.88 * window.innerWidth
        const height = container.scrollHeight || 500;

        let Graph_Object = new MyGraph("centroids_graph_container", Nodes_data, Edges_data, {}, {}, width, height, "circular", "centroids_ChangeLayout", false,
            "Yellow", "", "centroids_WeightSlider", 1, 0.001, "centroids_selected_node_table", "centroids_selected_edge_table",
            "centroids_SelectNeighbourImg", "centroids_ShowHideImg", "شباهت", centroids_node_dbl_click, "",
            "centroids_SearchBox", "centroids_SearchBtn")

        await Graph_Object.show()

        console.log("Graph_Show")
    }


    async function centroids_node_dbl_click(node_date) {

        const country_id = document.getElementById("country").value;
        await DetailFunctionLDA(node_date["id"])
        $("#SelectDocumentModal").modal("show")
    }
    function centroids_edge_dbl_click(edge_date) {
        console.log(edge_date)
    }

    async function showClusterKeywordGraph(container) {
        $('#selected_node_table').empty();
        $('#selected_edge_table').empty();

        const country_id = document.getElementById("country").value;
        const number_of_topic = document.getElementById("Cluster_Count_Select").value;


        let request_link = 'http://' + location.host + "/GetLDAKeywordGraphData/" + country_id + "/" + number_of_topic + "/"
        let response = await fetch(request_link).then(response => response.json());


        const Nodes_data = response["Nodes_data"]
        const Edges_data = response["Edges_data"]

        container = document.getElementById(container);
        const width = 0.88 * window.innerWidth
        const height = container.scrollHeight || 500;

        let Graph_Object = new MyGraph("clustersKeywords_graph_container",
            Nodes_data, Edges_data, {}, {}, width, height, "circular", "clustersKeywords_ChangeLayout", false,
            "Yellow","clustersKeywords_DegreeSlider", "clustersKeywords_WeightSlider", 1, 0.001,
            "clustersKeywords_selected_node_table", "clustersKeywords_selected_edge_table",
            "clustersKeywords_SelectNeighbourImg", "clustersKeywords_ShowHideImg", "امتیاز",
            clustersKeywords_node_dbl_click, clustersKeywords_edge_dbl_click,
            "clustersKeywords_SearchBox", "clustersKeywords_SearchBtn")

        await Graph_Object.show()

        console.log("Graph2_Show")
    }

    async function clustersKeywords_node_dbl_click(node_date) {
        if (node_date["node_type"] === "cluster") {
            const country_id = document.getElementById("country").value;
            await DetailFunctionLDA(node_date["id"])
            $("#SelectDocumentModal").modal("show")
        }
        else {
            const country_id = document.getElementById("country").value;
            const cluster_size = document.getElementById("Cluster_Count_Select").value;
            const username = getCookie("username");
            let request_link = 'http://' + location.host + "/GetKeywordLDAData/" + country_id + "/" + cluster_size + "/" + username + "/" + node_date["id"] + "/";
            let response = await fetch(request_link).then(response => response.json());

            await showDocumentInformation(response["lda_topics"],response["all_para_count"])
            document.getElementById("CloudHeader").innerHTML = "کلیدواژه: " + node_date["id"]
            document.getElementById("DetailText").innerHTML = '<table class="table table-striped" style="min-height: 200px;" id="KeywordSearchTable"></table>'
            columns = [
                {
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            },{
            "name": "topic_name",
            "title": "نام دسته",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "keywords",
            "title": "موضوع (20 کلمه کلیدی)",
            "style": {
                "width": "40%"
            }
        }, {
            "name": "paragraph_count",
            "title": "تعداد احکام",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "entropy",
            "title": "آنتروپی",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "subject",
            "title": "موضوع غالب (براساس کلیدواژگان)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "user_label",
            "title": "برچسب پیشنهادی",
            "style": {
                "width": "10%"
            }
        }]

            $('#KeywordSearchTable').empty();
            $('#KeywordSearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },

                "filtering": {
                    "enabled": true,
                    "placeholder": "نام کلیدواژه ...",
                    "filters": [{
                        "name": "my-filter",
                        "query": $('.form-control').val(),
                        "columns": ["word_list"]
                    }]
                },

                "sorting": {
                    "enabled": true
                },
                "empty": "موضوعی یافت نشد.",
                "columns": columns,
                "rows": TABLE_INFO
            });

            $("#detailModal").modal("show")
        }
    }
    async function clustersKeywords_edge_dbl_click(edge_date) {
        const country_id = document.getElementById("country").value;
        await CloudFunctionLDA(country_id, edge_date["source"])
        $("#detailModal").modal("show")
    }


    async function show_heatmap_charts(container, data) {
        document.getElementById(container).innerHTML = ""

        // create a chart and set the data
        chart = anychart.heatMap(data);

        // set the container id
        chart.container(container);


        // set the chart title
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // initiate drawing the chart
        chart.draw();
    }


    async function showDocumentInformation(lda_topics,all_para_count) {
        let index = 1;
        let document_result_table = [];

        document.getElementById("DocumentCount").innerText = all_para_count + " حکم با درجه تعلق بالای 50 درصد (سخت‌گیرانه) یافت شد.";

        for (let doc of lda_topics) {
            const detail_function = "DetailFunctionLDA(" + doc['id'] + ")";
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" '
                + ' onclick="' + detail_function + '" data-bs-target="#SelectDocumentModal">جزئیات</button>';

            const cloud_function = "CloudFunctionLDA(" + doc['id'] + ")";
            const cloud = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + cloud_function + '" data-bs-target="#detailModalCloud">مشاهده</button>'

            const subject_chart_function = "SubjectChartFunction(" + doc['id'] + ")";
            const subject_chart = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + subject_chart_function + '" data-bs-target="#subjectDetailModal">مشاهده</button>'

            const int_entropy = doc['entropy']

            if (int_entropy <= 0.75) {
                // entropy = '<p class="text-success">' + doc['entropy'] +'</p>'
                subject = '<p class="text-success">' + doc['subject'] + '</p>'
            } else if (int_entropy > 0.75 && int_entropy <= 1.75) {
                // entropy = '<p class="text-warning">' + doc['entropy'] +'</p>'
                subject = '<p class="text-warning">' + doc['subject'] + '</p>'
            } else {
                // entropy = '<p class="text-danger">' + doc['entropy'] +'</p>'
                subject = '<p class="text-danger">' + doc['subject'] + '</p>'
            }


            temp = doc['words'];
            user_label = doc['user_label'];
            const row = { "id":"" , "topic_name": doc['topic_name'], "keywords": temp,
            "paragraph_count": doc['paragraph_count'], 
            "subject_chart": subject_chart, "cloud": cloud, 
            "detail": detail, "entropy": doc['entropy'], "subject": subject ,"user_label":user_label}

            document_result_table.push(row);
            index += 1;
        }
        TABLE_INFO = document_result_table
        show_table_result()



    }

    async function show_table_result() {
        selected_columns = ["index","user_label", "keywords"]
        selected_columns = find_selected_column(selected_columns)


        columns = [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            },{
            "name": "topic_name",
            "title": "نام دسته",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "keywords",
            "title": "موضوع (20 کلمه کلیدی)",
            "style": {
                "width": "35%"
            }
        }, {
            "name": "paragraph_count",
            "title": "تعداد احکام",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cloud",
            "title": "ابر واژگان",
            "style": {
                "width": "7%"
            }
        }, {
            "name": "detail",
            "title": "مشاهده احکام",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "entropy",
            "title": "آنتروپی",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "subject",
            "title": "موضوع غالب (براساس کلیدواژگان)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "subject_chart",
            "title": "تحلیل توزیعی",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "user_label",
            "title": "برچسب پیشنهادی",
            "style": {
                "width": "10%"
            }
        }]

        if (!selected_columns.includes("all")) {
            for (let column of columns) {
                if (selected_columns.includes(column["name"])) {
                    column["visible"] = true
                } else {
                    column["visible"] = false
                }
            }
        }


        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },
            "filtering": {
                "enabled": true,
                "placeholder": "نام کلیدواژه ...",
                "filters": [{
                    "name": "my-filter",
                    "query": $('.form-control').val(),
                    "columns": ["keywords"]
                }]
            },
            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

    }

    $("#ColumnSelect").on('change', function () {
        show_table_result()
    })


    async function save_user_label(topic_id) {
        username = getCookie("username");
        label = $("#" + topic_id).val();

        if (label != "" && label != "بدون برچسب") {
            let request_link = 'http://' + location.host + "/save_topic_label/" +
                topic_id + "/" + username + "/" + label + "/"

            let response = await fetch(request_link).then(response => response.json());
            result_response = response["result_response"];
            notyf.success(result_response);

        } else {
            notyf.error("!برچسبی وارد نشده‌است");
        }

    }



    async function save_user_labelLDA(topic_id) {
        username = getCookie("username");
        label = $("#"+topic_id).val();
        
        if (label != "" && label != "بدون برچسب") {
            let request_link = 'http://' + location.host + "/save_lda_topic_label/" +
                topic_id + "/" + username + "/" + label + "/"

            let response = await fetch(request_link).then(response => response.json());
            result_response = response["result_response"];
            notyf.success(result_response);

        }else {
            notyf.error("!برچسبی وارد نشده‌است");
        }

    }



    async function showWithoutSubjectTable(doc_sub) {
        let index = 1;
        let document_result = [];

        for (let doc of doc_sub) {

            const document_link = 'http://' + location.host + "/document_profile/?id=" + doc['document_id'];
            const doc_name = '<a ' +
                'target="_blank" href="' + document_link + '">' + doc['document_name'] +
                "</a>";

            const para_link = 'http://' + location.host + "/sentiment_analysis/?id=" + doc['paragraph_id'];
            const para_text = '<a ' +
                'target="_blank" href="' + para_link + '">' + doc['paragraph_text'] +
                "</a>";

            const row = { "index": index, 
                "doc_name": doc_name,  
                "para_text":para_text,
                "subject_name": doc['subject_name'],
                "approval_reference_name": doc['approval_reference_name'],
                "approval_date": doc['approval_date']
            }

            document_result.push(row);
            index += 1;
        }
        console.log(document_result)
        $('#WithoutSubjectTableId').empty();
        $('.WithoutSubjectTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": [{
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "doc_name",
                "title": "نام سند",
                "style": {
                    "width": "30%"
                }
            },{
                "name": "subject_name",
                "title": "موضوع سند",
                "style": {
                    "width": "10%"
                }
            },{
                "name": "approval_reference_name",
                "title": "مرجع تصویب",
                "style": {
                    "width": "10%"
                }
            },{
                "name": "approval_date",
                "title": "تاریخ تصویب",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "para_text",
                "title": "متن حکم",
                "style": {
                    "width": "30%"
                }
            }
            ],
            "rows": document_result
        });
    }

    async function showDifferenceSubjectTable(doc_sub) {
        let index = 1;
        let document_result = [];


        // document.getElementById("DocumentCount").innerText = " 500حکم یافت شد.";


        for (let doc of doc_sub) {

            const document_link = 'http://' + location.host + "/document_profile/?id=" + doc['doc_id'];
            const doc_name = '<a ' +
                'target="_blank" href="' + document_link + '">' + doc['doc_name'] +
                "</a>";

            const para_text = '<p>' + doc['paragraph_text'] + "</p>";
            

            paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + doc['paragraph_id'];

            paragraph_tag ="<a class='' title = 'پروفایل حکم' target='blank' href='" + paragraph_link + "'>" + doc['paragraph_text'] + "</a>"
            
            
            const row = { "index": index, "doc_name": doc_name, "name": paragraph_tag, "subject": doc['document_subject'], "pre_subject": doc['document_predict_subject'] }

            document_result.push(row);
            index += 1;
        }
        console.log("________________")
        console.log(document_result)
        $('#DifferentSubjectTableId').empty();
        $('.DifferentSubjectTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": [{
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "doc_name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "name",
                "title": "متن حکم",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "subject",
                "title": "موضوع با کلیدواژه",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "pre_subject",
                "title": "موضوع غالب خوشه حکم (پیشنهادی)",
                "style": {
                    "width": "10%"
                }
            }
            ],
            "rows": document_result
        });
    }

    async function DetailFunction(country_id, topic_id) {

        RESULT_DOCUMENTS = []

        // clear prev results
        $('#KmeansDetailText').removeClass('h-100');
        document.getElementById("KmeansDetailText").innerHTML = ""
        document.getElementById("kmeans_topic_keywords_container").innerHTML = ""
        document.getElementById("KmeansModalHeader").innerHTML = ""
        $("#detail_modal_footer #close_btn").hide();
        $("#detail_modal_footer #ExportExcel2").show();

        $('#ExportExcel2').attr("onclick", "TopicParagraphs_Excel('" + topic_id + "')")


        modal_header = "احکام خوشه شماره:  " + CLUSTERS_DATA[topic_id]["name"].replaceAll('C', '')
        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' - ').slice(0, 20)

        const ngram_type = '(1,1)'

        i = 0
        for (keyword of keyword_list) {
            i += 1

            let tag = ''

            if (ngram_type == '(2, 2)') {
                tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input disabled class="form-check-input topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            }else {
                tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input class="form-check-input topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            }
            document.getElementById("kmeans_topic_keywords_container").innerHTML += tag;
        }

        document.getElementById("KmeansModalHeader").innerHTML = modal_header

        await loadParagraphs(country_id, topic_id, 1);

        $("#detailModal").modal("show")

    }

    async function loadParagraphs(country_id, topic_id, curr_page) {

        startFullPageBlockUI();


        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_ES/" + country_id + "/"
            + topic_id + "/" + SEARCH_RESULT_SIZE + "/" + curr_page + "/" + 1 + "/" + 0 + "/";

        let response = await fetch(request_link).then(response => response.json());
        topic_paragraphs = response["topic_paragraphs"]

        total_hits = response["total_hits"]
        curr_page = response["curr_page"]
        ES_SearchResult = response["result"]
        console.log(ES_SearchResult)

        await update_column_pagination_input(curr_page, total_hits);

        max_page = parseInt(document.getElementById("ColumnModalPaginationInput").max)
        document.getElementById("KmeansDocsCount").innerText = total_hits + " حکم:"


        show_modal_paragraphs(country_id, topic_id, modal_header, ES_SearchResult, curr_page, max_page)
        stopFullPageBlockUI('احکام مرتبط')
        }


        async function show_modal_paragraphs(country_id, topic_id, modal_header, paragraph_list, curr_page, max_page) {


        body_tag = ""
        index = (curr_page - 1) * SEARCH_RESULT_SIZE + 1;

        for (para of paragraph_list) {

            document_id = para['_source']['document_id']
            document_name = para['_source']['document_name']
            paragraph_id = para['_source']['paragraph_id']

            paragraph = ""
            try {
                paragraph = para["highlight"]["attachment.content"][0]

            }
            catch {
                paragraph = para["_source"]["attachment"]["content"]

            }

            const doc_link = 'http://' + location.host + "/document_profile/?id=" + document_id
            let doc_tag = "<a title = 'پروفایل سند' class='bold text-secondary' target='blank' href='" + doc_link + "'>" + document_name + "</a>"


            j = 0
            for (keyword of keyword_list) {
                j += 1
                keyword = keyword.trim()

                keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'


                paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + keyword + '</em>', keyword_tag)


            }



            paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + paragraph_id;

            paragraph_tag = "<a class='' title = 'پروفایل حکم' target='blank' href='" + paragraph_link + "'>" + paragraph + "</a>"

            // profile_tag = paragraph

            tag = "<li class='mb-3 lh-lg'>" + doc_tag + paragraph_tag + "</li>"
            body_tag += tag
            // document.getElementById("DetailText").innerHTML += "<ol start='" + index + "'>" + tag + "</ol>"


        }

        document.getElementById("KmeansDetailText").innerHTML += "<ol start='" + index + "'>" + body_tag + "</ol>"


        $('.topic_keyword').change(function () {

            if (this.checked) {
                $('.h_' + this.id).addClass('text-primary fw-bold')

            } else {
                $('.h_' + this.id).removeClass('text-primary fw-bold')

            }
        })




        if (curr_page >= max_page) {
            $("#KmeansLoadMoreDocuments").hide();
        } else {
            $("#KmeansLoadMoreDocuments").show();
        }

        /* LoadMoreDocuments */
        document.getElementById("KmeansLoadMoreDocuments").onclick = function () {

            next_page_number = ColumnModalNextPage(curr_page);
            loadParagraphs(country_id, topic_id, next_page_number);

        };
    }

    function ColumnModalNextPage(curr_page) {


        next_page_number = curr_page;
        max_page_number = parseInt(document.getElementById("ColumnModalPaginationInput").max);

        if (next_page_number < max_page_number) {
            next_page_number = curr_page + 1
        }

        document.getElementById("ColumnModalPaginationInput").value = next_page_number

        return next_page_number;

    }

    async function update_column_pagination_input(curr_page, total_hits) {

        page_count = 0;

        if (total_hits < SEARCH_RESULT_SIZE) {
            page_count = 1

        } else if (total_hits < MAX_RESULT_WINDOW) {
            page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

        } else if (total_hits >= MAX_RESULT_WINDOW) {
            page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
        }

        document.getElementById("ColumnModalPaginationInput").min = 1;
        document.getElementById("ColumnModalPaginationInput").max = page_count;
        document.getElementById("ColumnModalPaginationInput").value = curr_page;

    }





    async function DetailFunctionLDA(topic_id) {
        document.getElementById("ModalHeader").innerHTML = "";
        $('#LDAPopUpTable').empty();
        
        startFullPageBlockUI();

        let request_link = 'http://' + location.host + "/AILDADocFromTopic/" + topic_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        /*  Show detail Result */
        await showDetailsModal(response['topic_paragraphs'], response['keywords']);
        stopFullPageBlockUI('جزئیات احکام')
    }

    async function showDetailsModal(paragraphs_list, topic_words) {
        /* Title Text */
        let temp = topic_words;

        document.getElementById("ModalHeader").innerHTML =
            "<p target='to_blank' href='#'>" + "کلیدواژگان:" + ' ' + temp + "</p>";

        /* Body Text */
        let index = 1;
        let document_result = [];
        for (let paragraph of paragraphs_list) {

            const document_link = 'http://' + location.host + "/document_profile/?id=" + paragraph['document_id'];
            const doc_name = '<a ' +
                'target="_blank" href="' + document_link + '">' + paragraph['document_name'] +
                "</a>";

            let subject_name = ''

            if (paragraph['subject3_name'] == null) {
                if (paragraph['subject2_name'] == null) {
                    if (paragraph['subject1_name'] == 0) {
                        subject_name = '<p>نامشخص</p>'
                    }
                    else {
                        subject_name = '<p>1- ' + paragraph['subject1_name'] + '</p>'
                    }
                }
                else {
                    subject_name = '<p>1- ' + paragraph['subject1_name'] + '<br>2- ' + paragraph['subject2_name'] + '</p>'
                }
            }
            else {
                subject_name = '<p>1- ' + paragraph['subject1_name'] + '<br>2- ' + paragraph['subject2_name'] +
                    '<br>3- ' + paragraph['subject3_name'] + '</p>'
            }


            

            paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + paragraph['paragraph_id'];
            paragraph_tag = '<a ' +
                'target="_blank"  href="' + paragraph_link + '">' + paragraph['paragraph_text']+
                "</a>";

            const row = {
                "index": index,
                'name': doc_name,
                'paragraph_text': paragraph_tag,
                'subject_name': subject_name,
                'score': paragraph['score']
                }
            document_result.push(row);
            index += 1
        }
        $('#LDAPopUpTable').empty();
        $('.LDAPopUpTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": [{
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "paragraph_text",
                "title": "متن حکم",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "subject_name",
                "title": "موضوع حکم براساس کلیدواژه (روش دستی)",
                "style": {
                    "width": "20%"
                }
            }, {
                "name": "score",
                "title": "امتیاز حکم",
                "style": {
                    "width": "10%"
                }
            }
            ],
            "rows": document_result
        });
    }

    async function CloudFunctionLDA(topic_id) {
        startFullPageBlockUI()
        document.getElementById("CloudHeader").innerHTML = "ابر واژگان"
        document.getElementById("DetailTextCloud").innerHTML = ""

        let request_link = 'http://' + location.host + "/AILDAWordCloudTopic/" + topic_id + "/";
        let response = await fetch(request_link).then(response => response.json());

        tag_cloud_data = response['Could_data']

        // console.log(tag_cloud_data)

        await show_TagCloud_chart(tag_cloud_data, "DetailTextCloud")

        stopFullPageBlockUI('ابر واژگان');

    }

    async function CloudFunction(country_id, cluster_id) {
        $("#KmeansLoadMoreDocuments").hide();
        $('#KmeansDetailText').addClass('h-100');

        document.getElementById("KmeansModalHeader").innerHTML = "ابر واژگان"
        document.getElementById("KmeansDetailText").innerHTML = ""
        document.getElementById("KmeansDocsCount").innerHTML = ""

        document.getElementById("kmeans_topic_keywords_container").innerHTML = ""

        $("#detail_modal_footer #close_btn").show();
        $("#detail_modal_footer #ExportExcel2").hide();

        startFullPageBlockUI()

        cluster_name = CLUSTERS_DATA[cluster_id]['name'];

        let request_link = 'http://' + location.host + "/Get_Topic_TagCloud_ChartData/" + country_id + "/"
            + cluster_id + "/";

        let response = await fetch(request_link).then(response => response.json());
        tag_cloud_chart_data = response["tag_cloud_chart_data"]


        await show_TagCloud_kmeans_chart(tag_cloud_chart_data, cluster_name, "KmeansDetailText")
        stopFullPageBlockUI('ابر واژگان');


    }

    async function show_TagCloud_kmeans_chart(tag_cloud_data, cluster_name, container) {
        // create a chart and set the data

        document.getElementById(container).innerHTML = ""

        var chart = anychart.tagCloud(tag_cloud_data);
        chart.fontFamily('vazir');

        // set the chart title
        chart.title("خوشه :شماره " + cluster_name.replaceAll('C', ''));
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // configure angles
        chart.angles([0]);
        chart.textSpacing(10);
        // set the container id
        chart.container(container);
        // chart.tooltip().format("{امتیاز: %yPercentOfTotal}% \n({%value})");
        chart.tooltip().format("امتیاز: {%yPercentOfTotal}%");

        // initiate drawing the chart
        chart.draw();
    }


    async function show_TagCloud_chart(tag_cloud_data, container) {
        // create a chart and set the data

        document.getElementById(container).innerHTML = ""

        var chart = anychart.tagCloud(tag_cloud_data);
        chart.fontFamily('vazir');

        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // configure angles
        chart.angles([0]);
        chart.textSpacing(10);
        // set the container id
        chart.container(container);
        // chart.tooltip().format("{درصد نسبی: %yPercentOfTotal}% \n({%value})");
        chart.tooltip().format("درصد نسبی: {%yPercentOfTotal}%");

        // initiate drawing the chart
        chart.draw();
    }

    async function SubjectChartFunction(topic_id) {
        document.getElementById("CloudHeader").innerHTML = "تحلیل توزیعی"
        document.getElementById("DetailText").innerHTML = ""

        let request_link = 'http://' + location.host + "/AILDASubjectChartTopic/" + topic_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        paragraph_count = response['paragraph_count']
        dominant_subject_name = response['dominant_subject_name']
        correlation_score = response['correlation_score']

        chart_data = response['chart_data']
        console.log(chart_data)
        documents_information_dict = []
        showChart(chart_data, "DetailText", documents_information_dict, true, paragraph_count, dominant_subject_name, correlation_score)


        // await show_TagCloud_chart(tag_cloud_data, "DetailText")
    }



    function Centroids_showChart(data, position, sortKeys, xAxisTitle, yAxisTitle) {
        const options = {
                data,
                sortKeys,
                xAxisTitle: "خوشه",
                title: "توزیع خوشه‌ها در پاراگراف",
                yAxisTitle: "تعداد پاراگراف"

            };
        newBarChart(position, options)

    }


    function showChart(data, position, documents_information_result, sortKeys, paragraph_count, dominant_subject_name, correlation_score) {
        const options = {
            data,
            sortKeys,
            xAxisTitle: "موضوع سند",
            title: "تعداد احکام: " + paragraph_count + '\n' + 'موضوع غالب (براساس کلیدواژگان): ' + dominant_subject_name + "\n" + 'آنتروپی: ' + correlation_score + "\n",
            yAxisTitle: "تعداد سند"

        }
        newDoughnutChart(position, options)
    }


    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }

    async function ANOVAFunction(country_id, cluster_id) {
        startFullPageBlockUI()

        cluster_name = CLUSTERS_DATA[cluster_id]['name'];

        CURRENT_TOPIC_ID = cluster_id;

        $("#KmeansLoadMoreDocuments").hide();
        $('#KmeansDetailText').addClass('h-100');
        document.getElementById("KmeansModalHeader").innerHTML = "واژگان متمایزکننده خوشه " + cluster_name + " از سایر خوشه‌ها " + "(براساس الگوریتم ANOVA)"
        document.getElementById("KmeansDetailText").innerHTML = ""
        document.getElementById("KmeansDocsCount").innerHTML = ""
        document.getElementById("kmeans_topic_keywords_container").innerHTML = ""
        $("#detail_modal_footer #close_btn").show();
        $("#detail_modal_footer #ExportExcel2").hide();

        let request_link = 'http://' + location.host + "/Get_Topic_Anova_ChartData/" + country_id + "/"
            + cluster_id + "/";

        let response = await fetch(request_link).then(response => response.json());
        discriminant_words_chart_data = response["discriminant_words_chart_data"]




        showAnovaChart(discriminant_words_chart_data, "KmeansDetailText", false, "واژه", "درصد امتیاز","نمودار واژگان متمایزکننده")
        stopFullPageBlockUI('واژگان متمایزکننده');

    }
    function showAnovaChart(data, position, sortKeys, xAxisTitle, yAxisTitle, title) {
        const options = {
            data,
            sortKeys,
            xAxisTitle,
            title,
            yAxisTitle,
            onClick: async function (event, data) {
                if (position == 'KmeansDetailText') {

                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let topic_id = CURRENT_TOPIC_ID;
                    let country_id = document.getElementById('country').value
                    let word = data.row(index)[0];
                    console.log(word)
                    console.log("1111111111")

                    await Get_ANOVA_Word_Paragraphs(country_id, topic_id, word)

                    $("#anova_word_modal").modal("show");

                }
            }


        };
        newBarChart(position, options)

    }

    async function Get_ANOVA_Word_Paragraphs(country_id, topic_id, word) {

        startFullPageBlockUI();

        // clear prev results
        $('#anova_word_DetailText').removeClass('h-100');
        document.getElementById("anova_word_DetailText").innerHTML = ""
        document.getElementById("anova_word_topic_keywords_container").innerHTML = ""
        document.getElementById("anova_word_ModalHeader").innerHTML = ""


        // set modal header
        topic_name = CLUSTERS_DATA[topic_id]['name']
        modal_header = 'واژه ' + '<span class="text-primary">' + word + '</span>' + ' در خوشه ' + topic_name + ':'
        document.getElementById("anova_word_ModalHeader").innerHTML = modal_header


        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/Get_ANOVA_Word_Paragraphs_Column_ES/" +
            country_id + "/" + topic_id + "/" + word + "/";

        request_configs = {
            "link": request_link,
            "search_result_size": SEARCH_RESULT_SIZE,
            "data_type": "url_parameters",
            "form_data": null,
            "max_result_window": MAX_RESULT_WINDOW
        }

        highlight_parameters = { "selected_word": word }

        highlight_configs = {
            "parameters": highlight_parameters,
            "highlight_enabled": true,
            "custom_function": anova_word_highlight_paragraphs
        }

        modal_configs = {
            "body_id": "anova_word_DetailText",
            "modal_load_more_btn_id": "anova_word_LoadMoreDocuments",
            "result_size_container_id": "anova_word_DocsCount",
            "result_size_message": "حکم",
            "list_type": "ordered",
            "custom_body_function": null,
            "body_parameters": null

        }

        const username = getCookie("username");

        export_link = 'http://' + location.host + "/Export_ANOVA_Word_Paragraphs_Column_ES/" +
            country_id + "/" + topic_id + "/" + word + "/" + username + "/";

        export_configs = {
            "link": export_link,
            "btn_id": "anova_word_ExportExcel2"
        }
        segmentation_config = {
                "parameters": null,
                "keyword": null,
                "enable": false,
                "aggregation_keyword":null
            }
        column_interactivity_obj = new ColumnInteractivity("paragraphs",
            request_configs, export_configs, modal_configs, highlight_configs,segmentation_config)

        column_interactivity_obj.load_content();

        stopFullPageBlockUI('کلیک روی نمودار');

        $('#anova_word_ExportExcel2').on('click', async function () {
            await column_interactivity_obj.download_content();
        })


        }



    async function DistributionsFunction(country_id, topic_id) {


        cluster_name = CLUSTERS_DATA[topic_id]['name'];
        entropy = CLUSTERS_DATA[topic_id]['entropy'];
        cluster_size = CLUSTERS_DATA[topic_id]['cluster_size'];


        document.getElementById("DistModalHeader").innerHTML = "تحلیل توزیعی احکام خوشه " + cluster_name


        startFullPageBlockUI()

        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_ES/" + country_id + "/"
            + topic_id + "/" + SEARCH_RESULT_SIZE + "/" + 1 + "/" + 0 + "/" + 1 + "/";;

        let response = await fetch(request_link).then(response => response.json());
        topic_paragraphs = response["topic_paragraphs"]

        total_hits = response["total_hits"]
        curr_page = response["curr_page"]
        ES_Aggregations = response["aggregations"]

        await GetChartData_Es(country_id, topic_id, ES_Aggregations, [], entropy, cluster_size);


        stopFullPageBlockUI('تحلیل توزیعی');

    }


    async function GetChartData_Es(country_id, topic_id, ES_Aggregations, documents_information_result, entropy, cluster_size) {

        let request_link = '';

        subject_data = ES_Aggregations['subject-agg']['buckets']
        approval_references_data = ES_Aggregations['approval-ref-agg']['buckets']
        approval_year_data = ES_Aggregations['approval-year-agg']['buckets']
        level_data = ES_Aggregations['level-agg']['buckets']

        doc_ids = []


        for (doc of documents_information_result) {
            doc_ids.push(doc['_id'])
        }


        /* Show Chart  */


        showChartData(country_id, topic_id, subject_data, "subject_container", documents_information_result, false, "موضوع حکم", entropy, cluster_size, 'توزیع موضوعی احکام' + '\n' +  "آنتروپی: " + entropy + "\n" + "تعداد احکام: " + cluster_size)
        showChartData(country_id, topic_id, approval_year_data, "year_container", documents_information_result, true, "سال تصویب سند", entropy, cluster_size, "توزیع احکام براساس سال تصویب")
        // showHistogramChart(country_id, topic_id, approval_references_data, "approval_container", documents_information_result, false, "مرجع تصویب سند", "توزیع احکام براساس سطح احکام")
        showChartData(country_id, topic_id, level_data, "level_container", documents_information_result, false, "سطح سند", entropy, cluster_size, "توزیع احکام براساس سطح سند")
    }

    function showChartData(country_id, topic_id, data, container, documents_information_result, keySort, xAxisTitle, entropy, cluster_size, title) {
        let chart_data = []
        for (column of data) {

            key = column["key"]
            // key = column["key"] != 0 ? column["key"] : 'نامشخص'
            value = column["doc_count"]

            chart_data.push([key, value])
        }
        showBaseChart(country_id, topic_id, chart_data, container, documents_information_result, keySort, xAxisTitle, entropy, cluster_size, title)
    }

    function showBaseChart(country_id, topic_id, data, container, documents_information_result, sortKeys, xAxisTitle, entropy, cluster_size, title) {
        const options = {
            data,
            title,
            sortKeys,
            xAxisTitle,
            yAxisTitle: 'تعداد احکام',
            onClick: async function (event, data) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]

                let field_value = data.row(index)[0];
                let field_name = CHART_FIELD_DICT[container] + ".keyword"
                let chart_name = CHART_NAME_DICT[container]

                if (container == "year_container") {

                    field_name = field_name.replaceAll(".keyword", "");
                    if (field_value == "نامشخص")
                        field_value = 0
                }

                await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                $("#detailModal").modal("show")
                $("#detail_modal_footer #close_btn").show();
                $("#detail_modal_footer #ExportExcel2").hide();
            }
        };

        
        if (container === 'subject_container') {
            options.onClick = async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    

                    let field_value = data[index][0];
                    let field_name = CHART_FIELD_DICT[container] + ".keyword"
                    let chart_name = CHART_NAME_DICT[container]

                    await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                    $("#detailModal").modal("show")
                    $("#detail_modal_footer #close_btn").show();
                    $("#detail_modal_footer #ExportExcel2").hide();
                }
            newDoughnutChart(container, options);
        } else {
            newBarChart(container, options);
        }
        

    }

    function showHistogramChart(country_id, topic_id, data, container, documents_information_result, sortKeys, xAxisTitle, title) {
            // dict { 'approval_reference': [{ x: count, y: 1 }]
            const references = {};
            data.forEach(ref => {
                references[ref.key] = [{ x: String(ref.doc_count), y: 1 }]
            });
            const options = {
                data: references,
                sortKeys,
                xAxisTitle,
                title,
                showLabels: true,
                yAxisTitle: "تعداد احکام",
                onClick:async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let field_value = data[0];
                    let field_name = CHART_FIELD_DICT[container] + ".keyword"
                    let chart_name = CHART_NAME_DICT[container]

                    if (container == "year_container") {

                        field_name = field_name.replaceAll(".keyword", "");
                        if (field_value == "نامشخص")
                            field_value = 0
                    }

                    await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                    $("#detailModal").modal("show")
                    $("#detail_modal_footer #close_btn").show();
                    $("#detail_modal_footer #ExportExcel2").hide();
                }
            };

            newStackedColumnChart(container, options)
        }
    
        async function GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value) {
        startFullPageBlockUI();

        // clear prev results
        $('#KmeansDetailText').removeClass('h-100');
        document.getElementById("KmeansDetailText").innerHTML = ""
        document.getElementById("kmeans_topic_keywords_container").innerHTML = ""
        document.getElementById("KmeansModalHeader").innerHTML = ""


        // set modal header
        modal_header = chart_name + ": " + (field_value != 0 ? field_value : "نامشخص")
        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' - ').slice(0, 20)
        document.getElementById("KmeansModalHeader").innerHTML = modal_header


        i = 0
        for (keyword of keyword_list) {
            i += 1
            let tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input class="form-check-input  topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            document.getElementById("kmeans_topic_keywords_container").innerHTML += tag;
        }



        $('.topic_keyword').change(function () {

            if (this.checked) {
                $('.h_' + this.id).addClass('text-primary fw-bold')

            } else {
                $('.h_' + this.id).removeClass('text-primary fw-bold')

            }
        })


        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_Column_ES/" + country_id
            + "/" + topic_id + "/" + field_name + "/" + field_value + "/"

        request_configs = {
            "link": request_link,
            "search_result_size": SEARCH_RESULT_SIZE,
            "max_result_window": MAX_RESULT_WINDOW,
            "data_type": "url_parameters",
            "form_data": null
        }

        highlight_parameters = { "keyword_list": keyword_list }

        highlight_configs = {
            "parameters": highlight_parameters,
            "highlight_enabled": true,
            "custom_function": highlight_paragraphs
        }

        modal_configs = {
            "body_id": "KmeansDetailText",
            "modal_load_more_btn_id": "KmeansLoadMoreDocuments",
            "result_size_container_id": "KmeansDocsCount",
            "result_size_message": "حکم",
            "list_type": "ordered",
            "custom_body_function": null,
            "body_parameters": null

        }

        export_configs = {
            "link": null,
            "btn_id": null
        }
        segmentation_config = {
                "parameters": null,
                "keyword": null,
                "enable": false,
                "aggregation_keyword":null
            }
        column_interactivity_obj = new ColumnInteractivity("paragraphs",
            request_configs, export_configs, modal_configs, highlight_configs,segmentation_config)

        column_interactivity_obj.load_content();

        stopFullPageBlockUI('کلیک روی نمودار');
    }

    function highlight_paragraphs(paragraph, highlight_parameters) {
        keyword_list = highlight_parameters["keyword_list"]

        j = 0
        for (keyword of keyword_list) {
            j += 1
            keyword = keyword.trim()

            keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'


            paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + keyword + '</em>', keyword_tag)


        }

        return paragraph;
    }


    function anova_word_highlight_paragraphs(paragraph, highlight_parameters) {

        selected_word = highlight_parameters["selected_word"]


        selected_word = selected_word.trim()

        selected_word_tag = '<span class="text-primary fw-bold">' + selected_word + '</span>'


        paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + selected_word + '</em>', selected_word_tag)


        return paragraph;

    }

</script>

<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " پنجره واحد در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "ردیف" + sep + "موضوع" + sep + "آنتروپی" + sep + "موضوع غالب (براساس کلیدواژگان)" + "\n"
        let index = 1
        for (const topic of topic_response) {
            let temp = '';
            for (let key in topic['words']) {
                temp += key + '، ';
            }
            temp = temp.slice(0, -2);

            Csv += index + sep + temp + sep + topic["entropy"] + sep + topic["subject"] + sep + "\n"
            index += 1
        }

        let save_file_name = "موضوعات اسناد با استفاده از LDA در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

</script>


<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->
<script src="../../static/js/AI_topics/AI_topics_tour.js">
</script>
<script src="../../static/js/tour.js"></script>
<!-- {#
<script src="../../static/js/UserLogSave.js"></script>#} -->
<script src="../../static/js/signout_function.js"></script>



</html>