<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-radar.min.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/graph.css">
    <meta charset="UTF-8">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>


    <script src="./../static/js/graph/g6.min.js"></script>
    <script src="../../static/library/jquery-ui.min-1.11.4.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../static/js/CustomAlert.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../static/js/GraphClass.js"></script>
    <script src="../../static/js/column.js"></script>
    <script src="../../static/js/chart.js"></script>
    <style>
        .white-hover:hover {
            background-color: #000000 !important;
        }
    </style>

        <style>


    </style>

    <title>تحلیل گرافی اسناد رهبری</title>
    {% include "doc/title_icon.html" %}
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {


            // Active panel
            $('#RahbariDropdown').addClass('active');
            $('#rahbari_graph').addClass('active');


            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <div class="d-flex align-items-center rtl flex-row-reverse mx-auto p-1" style="background: linear-gradient(#8693AB, #cbd3da, #e9ecef); box-shadow: 0 0 2px 2px #f8f9fa inset; border: 4px solid #f8f9fa; border-radius: 24px">
            <img style="width: 120px;" id="prefix_ShowHideImg" src="../../static/image/rahbar_profile.png">
            <div class="d-flex flex-column gap-2 rtl mr-2" dir="rtl">
                <span class="font-weight-bolder">تحلیل اسناد رهبری</span>
                <span>صفحه تحلیل گرافی</span>
            </div>
        </div>
        <form action="" class="custom-control mx-auto needs-validation" id="graph_form" enctype="multipart/form-data"
            method="post" novalidate>
            <div class="row mb-0 flex-row-reverse mx-auto">

                <div class="col-12" dir="rtl">

                    <div class="d-flex">
                        <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light mt-5" dir="rtl">
                            <div class="d-flex">
                                <label class=" text-right bg-light float-right" style="direction: rtl;;">نوع گراف:</label>
                                <img style="width: 5%; height: 5%; margin: 0 5px; cursor: pointer; position: relative;"
                                     onclick="showTypeHelp()" src="../../static/icons/help.png">
                            </div>

                            <select id="GraphTypeSelect" name="GraphTypeSelect" onchange="change_graph_type()" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                            </select>
                        </div>

                        <div class="col-md-3 pt-3 col-12 col-lg-4 bg-light mt-5" style="direction: rtl">
                            <label class=" text-right bg-light float-right" style="direction: rtl;;">حداکثر همسایه:</label>
                            <select id="limit_neighbour_count" name="limit_neighbour_count" class="form-select text-right float-right searchable-select"
                                style="direction: rtl;">
                            </select>
                        </div>

                        <div class="col-md-3 pt-3 col-12 col-lg-4 bg-light mt-5" style="direction: rtl">
                            <label class=" text-right bg-light float-right" style="direction: rtl;;">سطح همسایگی:</label>
                            <select id="SearchNodeLevel" name="SearchNodeLevel" class="form-select text-right float-right searchable-select"
                                style="direction: rtl;">
                            </select>
                        </div>

                    </div>

                    <div class="d-flex">
                        <div id="LabelSelectBoxDiv" class="col-md-3 pt-3 col-12 col-lg-4 bg-light mt-3" style="direction: rtl">
                            <label class=" text-right bg-light float-right" style="direction: rtl;;">انتخاب برچسب:</label>
                            <select id="LabelSelectBox" name="LabelSelectBox" class="form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">
                            </select>
                        </div>

                        <div  id="DocumentSelectBoxDiv" class="col-md-3 pt-3 col-12 col-lg-6 bg-light mt-3" style="display:none; direction: rtl">
                            <label class=" text-right bg-light float-right" style="direction: rtl;;">انتخاب سند:</label>
                            <select id="DocumentSelectBox" name="DocumentSelectBox" class="form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">
                            </select>
                        </div>

                        <div class="col-lg-3 mr-0 col-md-6 pt-5 col-12">
                            <button type="button" id="graph_show" class="btn d-flex float-right mr-4 mt-3" onclick="ShowResult()">
                                <div class="spinner-border text-light" role="status">
                                    <span class="sr-only">درحال جستجو ...</span>
                                </div>
                                نمایش
                                گراف
                            </button>
                        </div>

                    </div>
                </div>
                <div class="col-4">
                        <div id="weight_histogram" chart-height="200px" class="d-none"></div>
                </div>
            </div>

            <!-- Constraints -->

        </form>

        <!--Original Tabs -->
        <ul id="original_tabs" class="nav nav-pills mt-3 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="rahbari_graph_graph_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#rahbari_graph_graph_pane" type="button" role="tab"
                    aria-controls="rahbari_graph_graph_pane" aria-selected="false">گراف مراکز خوشه‌ها</button>
            </li>


        </ul>

        <!-- Original Panes -->
        <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <div id="rahbari_graph_graph_pane" class="tab-pane w-100 active show fade float-right" role="tabpanel"
                    aria-labelledby="rahbari_graph_graph_tab">

                    <div class="row mt-4 w-100 mx-auto pb-5 px-4" dir="rtl">

                        <div id="rahbari_graph_constraints_container" class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">

                            <div id="rahbari_graph_DegreeDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر درجه</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="rahbari_graph_DegreeSlider" style="visibility: hidden;">
                                      <div class="container" style="display: flex; justify-content: center;">
                                        <div class="slider-wrapper">
                                          <div dir="ltr" id="slider-range"></div>
                                          <div dir="rtl" style="display:flex; width: 300px; justify-content: center" class="range-wrapper">
                                            <div dir="ltr" class="range mt-1"></div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                </div>
                            </div>

                            <div id="rahbari_graph_WeightDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="rahbari_graph_WeightSlider" style="visibility: hidden;">
                                      <div class="container" style="display: flex; justify-content: center;">
                                        <div class="slider-wrapper">
                                            <div dir="ltr" id="slider-range"></div>
                                              <div dir="rtl" style="display:flex; width: 300px; justify-content: center" class="range-wrapper">
                                                <div dir="ltr" class="range mt-1"></div>
                                              </div>
                                        </div>
                                        </div>
                                      </div>
                                    </div>
                            </div>

                        </div>

                        <div class="d-flex">
                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">نحوه نمایش</label>
                                </div>
                                <div class="source_container p-4 row mx-auto">
                                    <select id="rahbari_graph_ChangeLayout" name="rahbari_graph_ChangeLayout" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                                        <option value="grid">مربعی</option>
                                        <option value="circular"> دایره ای </option>
                                        <option value="force">ساده</option>
                                        <option value="dagre">بالا به پایین</option>
                                        <option value="radial">شعاعی</option>
                                        <option value="concentric">متحدالمرکز</option>
                                        <option value="comboForce">خوشه ای</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">جستجو در نام گره</label>
                                </div>
                                <div class="source_container p-4 d-flex">
                                    <input style="direction: rtl;" class="form-control text-right" placeholder="جستجو در نام گره ها ..." type="text" required="" name="rahbari_graph_SearchBox" id="rahbari_graph_SearchBox" value="">
                                    <button type="button" id="rahbari_graph_SearchBtn" class="btn modal_btn mr-2">جست‌وجو</button>
                                </div>
                            </div>


                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-1 d-flex">

                            </div>
                        </div>

                        <div class="d-flex mt-3">
                            <div dir="rtl" id="informationBox" class="col-md-11 p-1 col-12 col-lg-11" style="visibility: hidden; padding: 0;">
                        <table class="table table-light">
                            <thead class="table" style="background: #0e3f8b;">
                                <tr>
                                    <th class="text-center" scope="col">نوع گراف</th>
                                    <th class="text-center" scope="col">حداکثر همسایه</th>
                                    <!--<th class="text-center" scope="col">عبارت جستجو شده</th>-->
                                    <th class="text-center" scope="col">سطح همسایگی</th>
                                    <th class="text-center" scope="col">تعداد گره</th>
                                    <th class="text-center" scope="col">تعداد یال</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center" id="selected_graph_type">-</td>
                                    <td class="text-center" id="selected_limit_neighbour_count">-</td>
                                    <!--<td class="text-center" id="selected_search_keyword">-</td>-->
                                    <td class="text-center" id="selected_neighbour_level">-</td>
                                    <td class="text-center" id="selected_node_count">-</td>
                                    <td class="text-center" id="selected_edge_count">-</td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                            <div dir="ltr" class="col-md-6 p-1 col-12 col-lg-1 mt-4">
                                <img style="width: 40%; cursor: pointer; margin-top: 20px;" id="rahbari_graph_SelectNeighbourImg" src="../../static/image/neighbourhood.png">
                                <img style="width: 30%; cursor: pointer; margin-top: 20px;" id="rahbari_graph_ShowHideImg" src="../../static/image/hide_nodes.png">
                            </div>
                        </div>

                        <div id="rahbari_graph_graph_container" class="border mt-1 position-static" style="height:500px; overflow: hidden;">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="rahbari_graph_selected_node_table" class="table table-striped PopUpTable" style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                            <h6 class="table_header text-center  p-2  mb-0">
                                یال های انتخاب شده
                            </h6>
                            <table id="rahbari_graph_selected_edge_table" class="table table-striped PopUpTable" style="width: 95%;margin: auto;">

                            </table>
                        </div>
                        </div>

                    </div>

                </div>

        </div>

    </div>


    <button type="button" id="CoLabels_Node_Modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#CoLabels_Node_Modal"></button>
    <!-- Modal Container -->
    <div class="modal fade" id="CoLabels_Node_Modal">
        <div id="modal_dialog" class="modal-dialog modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header bg-light">
                    <h5 id="CoLabels_Node_ModalHeader" class="modal-title text-secondary w-100">
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="CoLabels_Node_ModalBody" class="modal-body bg-light text-justify">

                     <ul id="result_modal_tabs" style="border-bottom: 1px solid var(--header_color);" class="nav nav-pills mx-auto w-100 pr-3 pr-sm-0 float-right  d-block" role="tablist">
                        <li class="nav-item float-right" role="presentation">
                            <button id="node_click_result_tab" class="nav-link active" data-bs-toggle="pill"
                                    data-bs-target="#node_click_result_pane" type="button" role="tab" aria-controls="node_click_result_pane"
                                    aria-selected="true">نتایج جست‌وجو
                            </button>
                        </li>
                        <li id="chart_pane_li" class="nav-item float-right" role="presentation">
                            <button id="node_click_chart_tab" class="nav-link" data-bs-toggle="pill"
                                data-bs-target="#node_click_chart_pane" type="button" role="tab"
                                aria-controls="node_click_chart_pane" aria-selected="false">داشبورد آماری </button>
                        </li>
                    </ul>


                    <div id="result_modal_pane" class="tab-content w-80 px-1 mt-4">
                        <!-- Search Result Pane -->
                        <div id="node_click_result_pane" dir="rtl" class="tab-pane w-100 show active fade float-right" role="tabpanel" aria-labelledby="node_click_result_tab">
                            <p id="node_click_result_count" class="text-left mt-3 float-right text-secondary pl-2"></p>
                            <div class="table-responsive mt-4">
                                <table class="table table-striped NodeClickSearchTable" style="min-height: 200px;" id="NodeClickSearchTable">
                                </table>
                            </div>
                        </div>

                        <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100" id="node_click_chart_pane" role="tabpanel" aria-labelledby="node_click_chart_tab">
                            <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                                <div id="types_container" chart-height="400px" class="full"></div>
                                <div id="years_container" chart-height="1000px" class="half"></div>
                                <div id="labels_container" chart-height="1000px" class="half"></div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Modal footer -->
                <div class="modal-footer bg-light">
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <button type="button" id="SimilarityModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#SimilarityModal"></button>
    <div class="modal fade" id="SimilarityModal">
        <div id="modal_dialog" class="modal-dialog  modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title w-100">
                        <div class="row w-100">
                            <div id="RightHeader" class="col-6 float-right text-center my-auto"></div>
                            <div id="LeftHeader" class="col-6 float-left text-center my-auto"></div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">
                        <div id="RightDetails" class="col-6 float-right" style="overflow-y: scroll;height: 74vh;">
                        </div>
                        <div id="LeftDetails" class="col-6 float-left" style="height: 74vh;"></div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <h6 style="margin-bottom: 0.5rem;direction: rtl;">
                        کلیدواژگان مشترک (فراوانی در هر سند)
                        :
                    </h6>
                    <div id="KeywordCheckList" style="direction: rtl;width: 100%" onclick="getNewParagraphs()">

                    </div>
                    <hr style="width: 100%"/>
                </div>

            </div>
        </div>
    </div>

    <button type="button" id="HelpModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#HelpModal"></button>
    <div class="modal fade" id="HelpModal">
        <div id="modal_dialog" class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="HelpModalHeader" class="modal-title w-100"></h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="HelpModalBody" class="modal-body bg-light text-justify">
                </div>

            </div>
        </div>
    </div>

    <div id="HooshyarAlert"></div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js"></script>
    <!-- Intro Js -->
    <!-- <script src="../../static/js/graph/graph_tour.js"></script> -->
    <script src="../../static/js/tour.js"></script>

    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <script>

        initSearchableSelects();

        NeighbourhoodLimit = 100
        LevelSizeLimit = 5

        init()

        let graph_type_list = []

        async function init()
        {

            let request_link = 'http://' + location.host + "/getRahbariGraphType/";
            let response = await fetch(request_link).then(response => response.json());
            let type_list = response["type_list"]

            let options = [];
            for(let row of type_list)
            {
                options.push({ value: row["id"], text: row["name"] });
            }
            syncSelectOptions("GraphTypeSelect", options)

            options = [];
            for (let w = 1; w <= NeighbourhoodLimit; w+=1) {
                options.push({value: w, text: w});
            }
            syncSelectOptions("limit_neighbour_count", options)


            options = [];
            for(let i=1; i<= LevelSizeLimit; i++)
            {
                options.push({ value: i, text: i });
            }
            syncSelectOptions("SearchNodeLevel", options)

            request_link = 'http://' + location.host + "/getRahbariLabelsList/";
            response = await fetch(request_link).then(response => response.json());
            const rahbari_labels_list = response["labels_list"]
            syncSelectOptions("LabelSelectBox", rahbari_labels_list)


            request_link = 'http://' + location.host + "/getRahbariDocumentsList/";
            response = await fetch(request_link).then(response => response.json());
            const rahbari_doc_list = response["document_list"]
            syncSelectOptions("DocumentSelectBox", rahbari_doc_list)


            graph_type_list = type_list

            await change_graph_type()

            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)
        }

        function SearchInJson(nameKey, myArray){
            for (let i=0; i < myArray.length; i++) {
                if (myArray[i].id === nameKey) {
                    return myArray[i];
                }
            }
        }

        async function change_graph_type()
        {
            const type_id = document.getElementById("GraphTypeSelect").value
            const type_object = SearchInJson(parseInt(type_id), graph_type_list)
            if (type_object !== undefined) {
                const is_label = type_object.is_label
                const is_document = type_object.is_document
                const histogram_list = type_object.histogram_data
                const histogram_title = type_object.histogram_title

                document.getElementById("LabelSelectBox").tomselect.setValue(0)
                document.getElementById("DocumentSelectBox").tomselect.setValue(0)
                document.getElementById("limit_neighbour_count").tomselect.setValue(1)
                document.getElementById("SearchNodeLevel").tomselect.setValue(1)

                document.getElementById("LabelSelectBoxDiv").style.display = "none"
                document.getElementById("DocumentSelectBoxDiv").style.display = "none"
                console.log(is_label, is_document)
                if (is_label === 1)
                {
                    document.getElementById("LabelSelectBoxDiv").style.display = "block"
                }
                if (is_document === 1)
                {
                    document.getElementById("DocumentSelectBoxDiv").style.display = "block"
                }

                /*await showWeightChart(histogram_list, "weight_histogram", true, "حداقل وزن", histogram_title)
                document.getElementById("weight_histogram_chart_download_btn").style.display = "none"*/
            }
        }

        async function GetMultiSelectValue(container_id) {
            let e = document.getElementById(container_id);
            let selected = [...e.options]
                .filter(option => option.selected)
                .map(option => option.value)
            return selected.join("__")
        }

        async function ShowResult()
        {

            document.getElementById("informationBox").style.visibility = "visible"

            startFullPageBlockUI()

            const GraphTypeSelect = document.getElementById("GraphTypeSelect").value
            const limit_neighbour_count = document.getElementById("limit_neighbour_count").value

            let label_id = await GetMultiSelectValue("LabelSelectBox")
            let document_id = await GetMultiSelectValue("DocumentSelectBox")

            if (label_id === "")
                label_id = "0"
            if (document_id === "")
                document_id = "0"

            if (label_id.split("__").includes("0") && document_id.split("__").includes("0"))
            {
                const type_id = document.getElementById("GraphTypeSelect").value
                const type_object = SearchInJson(parseInt(type_id), graph_type_list)
                let alert_text_header = "هیچ برچسب یا سندی انتخاب نشده است."
                let alert_text_body = "لطفا حداقل یک برچسب یا سند را انتخاب نمایید."

                if (type_object !== undefined) {
                    const is_label = type_object.is_label
                    const is_document = type_object.is_document
                    if (is_label === 1 && is_document === 0)
                    {
                        alert_text_header = "هیچ برچسبی انتخاب نشده است."
                        alert_text_body = "لطفا حداقل یک برچسب را انتخاب نمایید."

                    }
                    if (is_label === 0 && is_document === 1)
                    {
                        alert_text_header = "هیچ سندی انتخاب نشده است."
                        alert_text_body = "لطفا حداقل یک سند را انتخاب نمایید."
                    }
                }

                HooshyarAlertShow(alert_text_header, alert_text_body, 2)

            }
            else
            {
                let level = document.getElementById("SearchNodeLevel").value
                let level_text = document.getElementById("SearchNodeLevel").value

                let request_link = 'http://' + location.host + "/getRahbariGraphData/" + GraphTypeSelect + "/" + limit_neighbour_count + "/" + label_id + "/" + document_id + "/" + level + "/"
                let response = await fetch(request_link).then(response => response.json());

                let Nodes_data = response["Nodes_data"]
                let Edges_data = response["Edges_data"]

                document.getElementById("selected_graph_type").innerText = $("#GraphTypeSelect option:selected").text();
                document.getElementById("selected_limit_neighbour_count").innerText = limit_neighbour_count
                //document.getElementById("selected_search_keyword").innerText = keyword_text
                document.getElementById("selected_neighbour_level").innerText = level_text
                document.getElementById("selected_node_count").innerText = Nodes_data.length
                document.getElementById("selected_edge_count").innerText = Edges_data.length

                if (Edges_data.length > 500) {

                    let alert_text_header =  "گراف خروجی شامل " + Nodes_data.length + " گره و " + Edges_data.length + " یال است. "
                    let alert_text_body = "با توجه به حجم گراف، ممکن است مرورگر شما دچار مشکل شود. لطفا با تغییر فیلترهای ورودی، گراف کوچک‌تری ایجاد نمایید."

                    HooshyarAlertShow(alert_text_header, alert_text_body, 1)

                    Nodes_data = []
                    Edges_data = []

                }
                else if (Edges_data.length === 0) {
                    let alert_text = "<p style='font-weight: bold; direction: rtl; font-size: 18px; padding: 5px 0'></p>"
                    alert_text += "<p style='font-weight: bold; direction: rtl; font-size: 16px; padding: 5px 0'></p>"

                    let alert_text_header = "هیچ گره و یالی یافت نشد."
                    let alert_text_body = "لطفا با تغییر فیلترهای ورودی، گراف خود را مجددا رسم نمایید."

                    HooshyarAlertShow(alert_text_header, alert_text_body, 2)

                    Nodes_data = []
                    Edges_data = []
                }

                const container = document.getElementById("rahbari_graph_graph_container");
                const width = 0.88 * window.innerWidth
                const height = container.scrollHeight || 500;

                let Graph_Object = new MyGraph("rahbari_graph_graph_container", Nodes_data, Edges_data, {}, {}, width, height, "force", "rahbari_graph_ChangeLayout", false,
                    "Yellow", "rahbari_graph_DegreeSlider", "rahbari_graph_WeightSlider", 1, 1, "rahbari_graph_selected_node_table", "rahbari_graph_selected_edge_table",
                    "rahbari_graph_SelectNeighbourImg", "rahbari_graph_ShowHideImg", "شباهت", rahbari_graph_node_dbl_click, rahbari_graph_edge_dbl_click,
                    "rahbari_graph_SearchBox", "rahbari_graph_SearchBtn")

                await Graph_Object.show()

            }

            stopFullPageBlockUI()

            //user log
            let form_data = new FormData()
            label_select = ""
            document_select = ""
            let detail_type = "نتایج جست و جو"
            let Graph_Type = $("#GraphTypeSelect option:selected").text();
            let Minimum_Similarity = $("#limit_neighbour_count option:selected").text();
            let neighbour_level = $("#SearchNodeLevel option:selected").text();
            $("#LabelSelectBox option:selected").each(function () {
                label_select += $(this).text() + "، ";
            });
            $("#DocumentSelectBox option:selected").each(function () {
                document_select += $(this).text() + "، ";
            });
            form_data.append('detail_type', detail_type);
            form_data.append('Graph_Type', Graph_Type);
            form_data.append('limit_neighbour_count', Minimum_Similarity);
            form_data.append('neighbour_level', neighbour_level);
            form_data.append('label', label_select);
            form_data.append('document', document_select);
            UserLog(form_data)
        }

        async function label_node_click(node_data)
        {
            $("#node_click_result_tab").click()
            $("#chart_pane_li").removeClass("d-none")

            const label_value = node_data["name"]
            const country_id = 32;
            const type_id = 0;
            const from_year = 0;
            const to_year = 0;
            const place = "عنوان";
            const text = "empty";
            const search_type = "All";
            const curr_page = 1;
            const rahbari_type = 0
            const documnet_ids = 0
            const with_rahbari_type = 0
            const request_link = 'http://' + location.host + "/SearchRahbari_ES/" + country_id + "/" + type_id + "/" +
                label_value + "/" + from_year + "/" + to_year + "/" + rahbari_type + "/" + documnet_ids + "/" + place + "/" + text + "/" + search_type + "/" + with_rahbari_type + "/" + curr_page + "/" + "100" + "/";
            let response = await fetch(request_link).then(response => response.json());

            document.getElementById("CoLabels_Node_ModalHeader").innerText = label_value
            $("#CoLabels_Node_Modal_btn").click()
            const total_hits = response["total_hits"]
            const ES_SearchResult = response["result"]
            const ES_Aggregations = response["aggregations"]
            const max_score = response["max_score"]

            await showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text, curr_page, max_score)

            await PlotChart(ES_Aggregations, ES_SearchResult)
        }

        async function document_node_click(node_data)
        {
            const document_id = node_data["id"].split("_")[1]
            window.open('http://' + location.host + "/document_profile?id=" + document_id)
        }

        async function label_label_edge_click(edge_data)
        {

            $("#node_click_result_tab").click()
            $("#chart_pane_li").removeClass("d-none")


            const label_value = edge_data["source_name"] + "__" + edge_data["target_name"]
            const country_id = 32;
            const type_id = 0;
            const from_year = 0;
            const to_year = 0;
            const place = "عنوان";
            const text = "empty";
            const search_type = "All";
            const curr_page = 1;

            const rahbari_type = 0
            const documnet_ids = 0
            const with_rahbari_type = 0
            const request_link = 'http://' + location.host + "/SearchRahbari_ES/" + country_id + "/" + type_id + "/" +
                label_value + "/" + from_year + "/" + to_year + "/" + rahbari_type + "/" + documnet_ids +  "/" + place + "/" + text + "/" + search_type + "/" + with_rahbari_type + "/" + curr_page + "/" + "100" + "/";
            let response = await fetch(request_link).then(response => response.json());

            document.getElementById("CoLabels_Node_ModalHeader").innerText = label_value.replace("__", " / ")
            $("#CoLabels_Node_Modal_btn").click()
            const total_hits = response["total_hits"]
            const ES_SearchResult = response["result"]
            const ES_Aggregations = response["aggregations"]
            const max_score = response["max_score"]

            await showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text, curr_page, max_score)

            await PlotChart(ES_Aggregations, ES_SearchResult)
        }

        async function document_document_edge_click(edge_data)
        {

            $("#node_click_result_tab").click()
            $("#chart_pane_li").addClass("d-none")

            const label_value = 0
            const country_id = 32;
            const type_id = 0;
            const from_year = 0;
            const to_year = 0;
            const place = "عنوان";

            const document_id1 = edge_data["source"].split("_")[1]
            const document_id2 = edge_data["target"].split("_")[1]

            const document_ids = document_id1 + "__" + document_id2;
            const text = "empty";
            const search_type = "exact";
            const curr_page = 1;
            const rahbari_type = 0
            const with_rahbari_type = 0
            const request_link = 'http://' + location.host + "/SearchRahbari_ES/" + country_id + "/" + type_id + "/" +
                label_value + "/" + from_year + "/" + to_year + "/" + rahbari_type + "/" + document_ids + "/" + place + "/" + text + "/" + search_type + "/" + with_rahbari_type + "/" + curr_page + "/" + "100" + "/";
            let response = await fetch(request_link).then(response => response.json());

            document.getElementById("CoLabels_Node_ModalHeader").innerText = edge_data["source_name"] + " / " + edge_data["target_name"]
            $("#CoLabels_Node_Modal_btn").click()
            const total_hits = response["total_hits"]
            const ES_SearchResult = response["result"]
            const ES_Aggregations = response["aggregations"]
            const max_score = response["max_score"]

            await showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text, curr_page, max_score)

            await PlotChart(ES_Aggregations, ES_SearchResult)
        }

        async function document_label_edge_click(edge_data)
        {
            $("#node_click_result_tab").click()
            $("#chart_pane_li").addClass("d-none")

            let document_ids = edge_data["source"]
            let label_name = edge_data["target_name"]
            if (edge_data["target_type"] === "document") {
                document_ids = edge_data["target"]
                label_name = edge_data["source_name"]
            }

            document_ids = document_ids.split("_")[1]

            const label_value = 0
            const country_id = 32;
            const type_id = 0;
            const from_year = 0;
            const to_year = 0;
            const place = "عنوان";
            const text = "empty"
            const search_type = "exact";
            const curr_page = 1;
            const rahbari_type = 0
            const with_rahbari_type = 0
            const request_link = 'http://' + location.host + "/SearchRahbari_ES/" + country_id + "/" + type_id + "/" +
                label_value + "/" + from_year + "/" + to_year + "/" + rahbari_type + "/" + document_ids + "/" + place + "/" + text + "/" + search_type + "/" + with_rahbari_type + "/" + curr_page + "/" + "100" + "/";
            let response = await fetch(request_link).then(response => response.json());

            document.getElementById("CoLabels_Node_ModalHeader").innerText = edge_data["source_name"] + " / " + label_name
            $("#CoLabels_Node_Modal_btn").click()
            const total_hits = response["total_hits"]
            const ES_SearchResult = response["result"]
            const ES_Aggregations = response["aggregations"]
            const max_score = response["max_score"]

            await showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text, curr_page, max_score)

            await PlotChart(ES_Aggregations, ES_SearchResult)
        }

        async function rahbari_graph_node_dbl_click(node_data)
        {
            if (node_data.node_type === "label")
                await label_node_click(node_data)
            else if (node_data.node_type === "document")
                await document_node_click(node_data)

        }

        async function rahbari_graph_edge_dbl_click(edge_data)
        {
            if (edge_data.source_type === "label" && edge_data.target_type === "label")
                await label_label_edge_click(edge_data)
            else if (edge_data.source_type === "document" && edge_data.target_type === "document")
                await document_document_edge_click(edge_data)
            else
                await document_label_edge_click(edge_data)
        }

        async function showDocumentInformation(documents_information_result, mode, where, total_hits, text, curr_page, max_score) {
            document.getElementById("node_click_result_count").innerText = "تعداد کل نتایج: " + total_hits + " سند"
            let index = 1;
            let document_result = []
            for (let doc of documents_information_result) {
                const doc_id = doc['_source']['document_id']
                var doc_name = doc['_source']['name']
                const doc_file_name = doc['_source']['document_file_name']
                const type = doc['_source']['type']
                const rahbari_date = doc['_source']['rahbari_date']
                const rahbari_year = doc['_source']['rahbari_year'] !== 0 ? doc['_source']['rahbari_year'] : 'نامشخص'
                const labels = doc['_source']['labels']
                let score = Math.round((doc['_score'] / max_score) * 100)

                const document_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
                doc_name = '<a target="_blank" href="' + document_link + '">' + doc_name + "</a>"

                const row = {
                    "index": index,
                    "doc_id": doc_id,
                    "doc_name": doc_name,
                    "doc_file_name": doc_file_name,
                    "rahbari_date": rahbari_date,
                    "rahbari_year": rahbari_year,
                    "rahbari_type": type,
                    "rahbari_labels": labels,
                    "count": score
                }

                document_result.push(row)
                index += 1
            }

            await show_table_result(document_result)
        }

        async function show_table_result(TABLE_INFO) {

            const columns = [{
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "doc_name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "rahbari_type",
                "title": "نوع سند",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "rahbari_date",
                "title": "تاریخ",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "rahbari_labels",
                "title": "برچسب",
                "style": {
                    "width": "40%"
                }
            }]

            $('#NodeClickSearchTable').empty();
            $('#NodeClickSearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "سندی یافت نشد.",
                "columns": columns,
                "rows": TABLE_INFO
            });
        }

        async function PlotChart(ES_Aggregations, ES_SearchResult)
        {
            const rahbari_type = ES_Aggregations['rahbari-type-agg']['buckets']
            const rahbari_year = ES_Aggregations['rahbari-year-agg']['buckets']
            const rahbari_labels = ES_Aggregations['rahbari-labels-agg']['buckets']

            await showChartData(rahbari_year, "years_container", ES_SearchResult, true, "سال تصویب سند","توزیع اسناد براساس سال تصویب")
            await showChartData(rahbari_labels, "labels_container", ES_SearchResult, false, "برچسب","توزیع اسناد براساس برچسب ها")
            await showHistogramChart(rahbari_type, "types_container", ES_SearchResult, false, "نوع","توزیع اسناد براساس نوع")
            console.log(rahbari_type)
        }

        function showChartData(data, container, documents_information_result, keySort, xAxisTitle, title) {
            let chart_data = []
            for (column of data) {
                key = column["key"]
                value = column["doc_count"]
                chart_data.push([key, value])
            }
            showChart(chart_data, container, documents_information_result, keySort, xAxisTitle, title)
        }

        function showChart(data, container, documents_information_result, sortKeys, xAxisTitle, title) {
            const options = {
                data,
                sortKeys,
                xAxisTitle,
                title,
                yAxisTitle: "تعداد سند",
                onClick: async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    const text = data.row(index)[0];
                    const best_result_count = documents_information_result.length

                    let filtered_result = []
                    let header = ""
                    let save_file_name = document.getElementById("SearchBox").value;

                    await GetClickedColumnDocuments(container, text)

                    $("#ChartModalBtn").click();
                }
            };

            if (container === "subject_container") {
                options.onClick = async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    const text = data[index][0];
                    const best_result_count = documents_information_result.length

                    let filtered_result = []
                    let header = ""
                    let save_file_name = document.getElementById("SearchBox").value;

                    await GetClickedColumnDocuments(container, text)

                    $("#ChartModalBtn").click();
                }

                newDoughnutChart(container, options);
            } else {
                newBarChart(container, options)
            }
        }

        function showHistogramChart(data, container, documents_information_result, sortKeys, xAxisTitle, title) {
            // dict { 'approval_reference': [{ x: count, y: 1 }]
            const references = {};
            data.forEach(ref => {
                references[ref.key] = [{ x: String(ref.key), y: String(ref.doc_count) }]
            });
            const options = {
                data: references,
                sortKeys,
                xAxisTitle,
                title,
                showLabels: true,
                yAxisTitle: "تعداد سند",
                onClick: async function (event, data) {
                    const text = data[0];
                    const best_result_count = documents_information_result.length

                    let filtered_result = []
                    let header = ""
                    let save_file_name = document.getElementById("SearchBox").value;

                    await GetClickedColumnDocuments(container, text)

                    $("#ChartModalBtn").click();
                }
            };

            newStackedColumnChart(container, options)
        }

        function showWeightChart(data, container, sortKeys, xAxisTitle, title) {
            const references = {};
            data.forEach(ref => {
                references[ref.key] = [{ x: String(ref.key), y: String(ref.count)}]
            });
            const options = {
                data: references,
                sortKeys,
                xAxisTitle,
                title,
                showLabels: true,
                yAxisTitle: "تعداد یال",
                onClick: async function (event, data) {
                }
            };

            newStackedColumnChart(container, options)
        }

        async function showTypeHelp()
        {
            const graph_type_name_1 = "گراف باهم‌آیی برچسب‌ها"
            const graph_type_text_1 = "در این گراف هر گره یک برچسب و هر یال بیانگر تعداد اسناد مشترکی است که دو برچسب در آن‌ها تکرار شده‌اند."

            const graph_type_name_2 = "گراف میان سند و برچسب"
            const graph_type_text_2 = "در این گراف هر گره بیانگر برچسب یا سند بوده و هر یال رخداد یک برچسب در سند را نشان می‌دهد."

            const graph_type_name_3 = "گراف برچسب‌های میان اسناد"
            const graph_type_text_3 = "در این گراف هر گره یک سند و هر یال بیانگر تعداد برچسب‌های مشترک میان دو سند است."


            let tag =`<table class="table table-light">
                        <thead class="table" style="background: #0e3f8b;"><tr><th class="text-center" scope="col">${graph_type_name_1}</th></tr></thead>
                        <tbody><tr><td class="text-center" id="selected_graph_type">${graph_type_text_1}</td></tr></tbody>
                      </table>`

            tag +=`<table class="table table-light mt-4">
                        <thead class="table" style="background: #0e3f8b;"><tr><th class="text-center" scope="col">${graph_type_name_2}</th></tr></thead>
                        <tbody><tr><td class="text-center" id="selected_graph_type">${graph_type_text_2}</td></tr></tbody>
                      </table>`


            tag +=`<table class="table table-light mt-4">
                    <thead class="table" style="background: #0e3f8b;"><tr><th class="text-center" scope="col">${graph_type_name_3}</th></tr></thead>
                    <tbody><tr><td class="text-center" id="selected_graph_type">${graph_type_text_3}</td></tr></tbody>
                  </table>`

            document.getElementById("HelpModalBody").innerHTML = tag
            document.getElementById("HelpModalHeader").innerText = "راهنما نوع گراف"
            $("#HelpModalBtn").click()



        }

    </script>

</body>


<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"

            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>
<!-- Intro Js -->
<script src="../../static/js/graph/graph_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<!-- {#
<script src="../../static/js/UserLogSave.js"></script>#} -->
<script src="../../static/js/signout_function.js"></script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>




</html>