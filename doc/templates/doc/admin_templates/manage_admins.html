<!doctype html>
<html lang="fa" dir="rtl">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dropdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->

    <!-- log js -->
    <script src="../../../static/js/log_config/log_config.js"></script>

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" href="../../static/styles/stars.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">
    <meta charset="UTF-8">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    {% comment %}  {% endcomment %}

    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>


    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">

    <!-- Footable  -->
    <script src="../../static/js/footable/footable.js"></script>

    <title>مدیریت کاربران</title>
    {% comment %} {% include "doc/title_icon.html" %} {% endcomment %}

</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/base_templates/header.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#AdminDropdown').addClass('active');
            $('#manage_users_tab').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>
<!--container-->
<div class="container-users mt-4">
    <div class="row">
        <div class="col">

            <!--confirm-users data table-->
            <div class="row data-table">
                <div class="col">
                </div>
                <div class="col-11">
                <br>
                <br>
                <br>
                    <div class="text"><p
                            class="user-list align-content-center"> لیست
                    <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                    </button>
                        افراد تایید شده :</p></div>
                    <hr style="color:darkblue">
                    <div id="searchbox" class="searching">
                        <form class="d-flex pb-2">
                            <input class="form-control me-2" id="myInput" type="search" placeholder="جستجو......"
                                   aria-label="Search">
                        </form>
                    </div>
                    <div class="table-responsive tbl">
                        <table id=accepted_user_table class="table table-striped accepted_user_table  no-row-number">
                        </table>
                    </div>
                </div>
                <div class="col">
                </div>
            </div>
            <!--end confirm-users data table-->
        </div>
    </div>

    <!-- Recommendation Modal Container -->
    <div class="modal fade" id="RecommendationModal">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="RecommendationModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="RecommendationModalBody" class="modal-body text-justify">
                    <table class="table table-striped RecommendationTable" id="RecommendationTable">
                    </table>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div dir="rtl" class="row list-table mt-3 mx-auto p-3 mb-4" id="permissionslist">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--end container-->
<script src="../../static/library/notyf.min.js"></script>

<script src="../../static/js/logincheck.js"></script>

<script>
    const notyf = new Notyf();
    var columns = [{
        "name": "index",
        "title": "ردیف",
        "breakpoints": "xs sm",
        "width": "2%"
    }, {
        "name": "first_name",
        "title": "نام",
        "width": "5%"
    }, {
        "name": "last_name",
        "title": "نام خانوادگی",
        "width": "5%"
    }, {
        "name": "username",
        "title": "نام کاربری",
        "width": "5%"
    }, {
        "name": "email",
        "title": "ایمیل",
        "width": "8%"
    }, {
        "name": "mobile",
        "title": "شماره موبایل",
        "width": "5%"
    }, {
        "name": "recommendation",
        "title": "نظرات کاربر",
        "width": "3%"
    }, {
        "name": "permissions",
        "title": "دسترسی ها",
        "width": "3%"
    }, {
        "name": "status",
        "title": "وضعیت",
        "width": "5%"
    }, {
        "name": "change_status",
        "title": "تغییر وضعیت",
        "width": "15%"
    }];
    var ft = FooTable.init('#accepted_user_table', {
        "paging": {
            "enabled": true,
            strings: {
                last: '»',
                next: '›',
                prev: '‹',
                first: '«'
            }
        },
        "filtering": {
            "enabled": false
        },
        "sorting": {
            "enabled": true
        },
        "empty": "کاربری یافت نشد.",
        "columns": columns,
    });

    ShowAcceptedUserTable("all");
    
    async function ShowAcceptedUserTable(value) {
        if (value == undefined || value == null || value == "") 
            value = "all";
        request_link = 'http://' + location.host + "/getAcceptedUsers/" + value + "/";
        let response = await fetch(request_link).then(response => response.json());
        
        accepted_users = response["users"];
        let users = [];
        let index = 1;
        for (user of accepted_users) {
            const first_name = user["first_name"];
            const last_name = user["last_name"];
            const username = user["username"];
            const email = user["email"];
            const mobile = user["mobile"];
            const is_active = user["is_active"];
            let disabled = "";
            let background_color = "";
            if (is_active == 0) {
                disabled = "disabled";
                background_color = "#C9C9C9";
            }
            else {
                disabled = "";
                background_color = "#7FB1CD";
            }
            const recommendation = `<div class="">
                                        <button id="recommendation_${username}" style="background-color:${background_color}" type="button"
                                        class="btn float-none mr-4" id="recommendation_button" ` + disabled +
                                        ` onclick="ShowRecommendationModal('${username}')">مشاهده</button>
                                    </div>`
            if (is_active == 1) {
                disabled = "";
                background_color = "#7FB1CD";
            }
            else {
                disabled = "disabled";
                background_color = "#C9C9C9";
            }

            const permissions = `<div class="">
                                    <button id="permissions_${username}" style="background-color:${background_color}" type="button"
                                    class="btn float-none mr-4" id="permissions_button" ` + disabled +
                                    ` onclick="ShowModal('${username}')">مشاهده</button>
                                </div>`

            let status_text = ""
            let status_color = ""
            if (is_active == 1) {
                status_text = "تایید شده";
                status_color = "green";
            }
            else if (is_active == 0) {
                status_text = "در انتظار تایید";
                status_color = "#8b8000";
            }
            else if (is_active == -1) {
                status_text = "رد شده";
                status_color = "red";
            }

            const status = `<div class="">
                                <h6 style="color:${status_color}" id="user_status_${username}">
                                    ${status_text}
                            </div>`  

            let change_status_text = ""
            let change_status_color = ""
            let new_status = 0
            if (is_active == 1) {
                change_status_text = "غیر فعال کردن";
                change_status_color = "#CD7F8A";
                disabled = "";
                new_status = -1;
            }
            else if (is_active == -1) {
                change_status_text = "فعال کردن";
                change_status_color = "#A5C66D";
                disabled = "disabled";
                new_status = 1;
            }
            let change_status = `<div id="change_status ${username}">
                                        <button style="background-color:${change_status_color}" type="button"
                                            class="btn float-none mr-4" ` + disabled +
                                            ` onclick="ChangeUserStatus('${username}', ${new_status})">${change_status_text}
                                        </button>
                                    </div>`
            
            if (is_active == 0) {

                change_status = `<div id="change_status ${username}">
                                        <button style="background-color:#A5C66D" type="button"
                                            class="btn float-none mr-4"
                                            onclick="ChangeUserStatus('${username}', 1)">تایید کردن
                                        </button>
                                        <button style="background-color:#CD7F8A" type="button"
                                            class="btn float-none mr-4"
                                            onclick="ChangeUserStatus('${username}', -1)">رد کردن
                                        </button>
                                    </div>`
            }
            const row = {
                "index": index,
                "first_name": first_name,
                "last_name": last_name,
                "username": username,
                "email": email,
                "mobile": mobile,
                "recommendation": recommendation,
                "permissions": permissions,
                "status": status,
                "change_status": change_status
            }
            users.push(row);
            index += 1; 
        }
        ft.rows.load(users)
    }


    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            ShowAcceptedUserTable(value);
        });
    });





</script>

<script>
    function deleteCookie(cname) {
        const d = new Date();
        d.setTime(d.getTime() + (24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=;" + expires + ";path=/";
    }
    
    async function sign_out_function()
    {
        deleteCookie("username")
        window.location.href = "../login"
    }
    async function ChangePermission(panel_name,username) {
        try {
            request_link = 'http://' + location.host + "/create_or_delete_user_panels/" + panel_name + "/" + username + "/";
            response = await fetch(request_link).then(response => response.json());
            if (response['status'] == 'created') {
                notyf.success('دسترسی با موفقیت اضافه شد');
            }
            else {
                notyf.success('دسترسی با موفقیت حذف شد');
            }
        } catch (e) {
            console.error(e)
            notyf.error('لطفا دوباره تلاش کنید');
        }
        ShowPermissions(username);
    }

    async function ChangePanelPermission(panel_name,username) {
        try {
            request_link = 'http://' + location.host + "/create_or_delete_user_mainpanels/" + panel_name + "/" + username + "/";
            response = await fetch(request_link).then(response => response.json());
            if (response['status'] == 'created') {
                notyf.success('دسترسی با موفقیت اضافه شد');
            }
            else {
                notyf.success('دسترسی با موفقیت حذف شد');
            }
        } catch (e) {
            console.error(e)
            notyf.error('لطفا دوباره تلاش کنید');
        }
        ShowPermissions(username);
    }

    async function ShowModal(username) {
        ShowPermissions(username);
        $('#myModal').modal('show');
    }

    async function ShowRecommendationModal(username) {
        request_link = 'http://' + location.host + "/get_user_recommendations/" + username + "/";
        response = await fetch(request_link).then(response => response.json());
        document.getElementById("RecommendationModalHeader").innerHTML = "نظرات کاربر: " + username
        let index = 1;
        recommendations = response['recommendations']
        let recommendation_result = []
        for (const item of recommendations) {
    
            const submited_at = item['submited_at'];
            const rating_value = item['rating_value'];
            const recommendation_text = item['recommendation_text'];
            let selected = ["", "", "", "", ""]
            for (let i = 0; i < rating_value; i++) {
                selected[i] = "style='color: #FF912C;'"
            }
            
            const stars = `<div class='rating-stars text-center' data-value="` + rating_value.toString() + `">
                                <ul>
                                <li class='star' data-value='1'>
                                    <i class='fa fa-star fa-fw' ${selected[0]}></i>
                                </li>
                                <li class='star' data-value='2'>
                                    <i class='fa fa-star fa-fw' ${selected[1]}></i>
                                </li>
                                <li class='star' data-value='3'>
                                    <i class='fa fa-star fa-fw' ${selected[2]}></i>
                                </li>
                                <li class='star' data-value='4'>
                                    <i class='fa fa-star fa-fw' ${selected[3]}></i>
                                </li>
                                <li class='star' data-value='5'>
                                    <i class='fa fa-star fa-fw' ${selected[4]}></i>
                                </li>
                                </ul>
                            </div>`

            row = {
                "id": index,
                "submited_at": submited_at,
                "stars": stars,
                "recommendation_text": recommendation_text
            }
            recommendation_result.push(row)
            index += 1;
        }
        
        
        columns = [
            {
                "name": "id",
                "title": "ردیف",
            },
            {
                "name": "submited_at",
                "title": "زمان ثبت",
            },
            {
                "name": "stars",
                "title": "امتیاز"
            },
            {
                "name": "recommendation_text",
                "title": "نظر"
            }
        ]
        $('#RecommendationTable').empty();
        $('.RecommendationTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "نظری یافت نشد.",
            "columns": columns,
            "rows": recommendation_result
        });

        $('#RecommendationModal').modal('show');

    }

    async function ShowPermissions(username) {
        const request_url = 'http://' + location.host + '/get_allowed_panels/' + username + '/';
        const response = await fetch(request_url).then(response => response.json());

        const has_access_to_all_panel = response['has_access_to_all_panel']

        document.getElementById("ModalHeader").innerHTML = '<h4>' + 'دسترسی های کاربر: ' + username + '</h4>';
        document.getElementById("permissionslist").innerHTML = "";

        let checked = "";
        if (has_access_to_all_panel == true) {
            checked = "checked";
        }

        document.getElementById("permissionslist").innerHTML += 
            '<div class="checkbox half chart-container" style="text-align: center; margin: 0 auto; background-color: #e6f2ff; width: 20%;">'+
            '<input type="checkbox" ' + checked + ' style="color: green;" class="doc_checkbox" value="all" onclick="ChangePermission(\'all\',\'' + username + '\')">'+
            '<label style="color: green; font-size: 25px; bold;" class="m-2">' + 
            'همه پنل ها</label>'+
            '</div>';

        const all_panels = response['all_panels']
        const user_panels = response['user_panels']

        for (const panel of all_panels)
        {
            const main_panel = panel['main_panel'];
            const main_persian_name = panel['persian_name'];
            const have_all_sub_panels = panel['has_access_to_all_sub_panels']
            const sub_panels = panel['sub_panels'];

            checked = ""
            if (have_all_sub_panels == true)
                checked = "checked"
            // green checkbox
            document.getElementById("permissionslist").innerHTML += 
                '<div class="checkbox full chart-container" style="margin: 0px !important;">'+
                '<input type="checkbox" style="color: green;" '+ checked +' class="doc_checkbox" value="'+main_panel+'" onclick="ChangePanelPermission(\'' + main_panel + '\',\'' + username + '\')">'+
                '<label style="color: green; font-size: 20px; bold;" class="m-2">'+
                        main_persian_name+
                '</label>'+
            '</div>';
                                                                    
            for (const sub_panel of sub_panels) { 
                english_name = sub_panel['english_name']
                persian_name = sub_panel['persian_name']
                checked = ""
                if (user_panels.includes(sub_panel['english_name']))
                    checked = "checked"
                const tag =    '<div class="col-3 checkbox p-2 text-right">'+
                                    '<input type="checkbox" '+ checked +' class="doc_checkbox" value="'+english_name+'" onclick="ChangePermission(\'' + english_name + '\',\'' + username + '\')">'+
                                    '<label class="m-2">'+
                                            persian_name+
                                    '</label>'+
                                '</div>';
                document.getElementById("permissionslist").innerHTML += tag
            }
            document.getElementById("permissionslist").innerHTML += '</div>';
        }
    }

    async function ChangeUserStatus(username, status) {
        try {
            request_link = 'http://' + location.host + "/change_user_status/" + username + "/" + status + "/";
            response = await fetch(request_link).then(response => response.json());
            let permissions_id = "permissions_" + username
            let recommendation_id = "recommendation_" + username
            let change_status_id = "change_status " + username
            let user_status_id = "user_status_" + username
            
            if (response['status'] == 'activated') {
                notyf.success('کاربر با موفقیت فعال شد');
                document.getElementById(change_status_id).innerHTML = `<button style="background-color:#CD7F8A" type="button"
                                                        class="btn float-none mr-4"
                                                        onclick="ChangeUserStatus('${username}', -1)">غیر فعال کردن</button>`
                document.getElementById(user_status_id).innerHTML = `<h6 style="color: green" id="user_status_${username}">تایید شده</h6>`
                document.getElementById(permissions_id).disabled = false;
                document.getElementById(permissions_id).style.backgroundColor = "#7FB1CD";
                document.getElementById(recommendation_id).disabled = false;
                document.getElementById(recommendation_id).style.backgroundColor = "#7FB1CD";

            }
            else {
                notyf.success('کاربر با موفقیت غیر فعال شد');
                document.getElementById(change_status_id).innerHTML = `<button style="background-color:#A5C66D" type="button"
                                                        class="btn float-none mr-4" disabled
                                                        onclick="ChangeUserStatus('${username}', 1)">فعال کردن</button>`
                document.getElementById(user_status_id).innerHTML = `<h6 style="color: red" id="user_status_${username}">رد شده</h6>`
                document.getElementById(permissions_id).disabled = true;
                document.getElementById(permissions_id).style.backgroundColor = "#C9C9C9"
            }
        } catch (e) {
            console.error(e)
            notyf.error('لطفا دوباره تلاش کنید');
        }
        
    }


    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","
        let Csv = "نام" + sep + "نام خانوادگی" + sep + "نام کاربری" + sep + "آدرس ایمیل" + sep + "شماره تماس" + sep
        const response = await fetch('http://' + location.host + '/get_permissions_excel/').then(response => response.json());

        for (const panel of Object.keys(response['panels'])) {
            console.log(panel)
            Csv += response['panels'][panel] + sep
        }
        Csv += "\n"

        for (const user of response['users']) {
            for (const col of Object.keys(user)) {
                Csv += user[col] + sep
            }
            Csv += "\n"
        }

        let save_file_name = "گزارش دسترسی"
        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

</script>

</body>
</html>