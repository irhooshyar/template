<!doctype html>
<html lang="fa" dir="rtl">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="../../../static/library/bootstrap-5.1.3.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../static/library/bootstrap-icons-1.7.1.css">
    <link href="../../../static/styles/login_signup.css" rel="stylesheet">

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">

     <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../../static/js/multiselect/jquery.multi-select.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../static/js/CustomAlert.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="../../../static/js/Bita.js"></script>

    <title>ثبت نام</title>
    {% include "doc/base_templates/title_icon.html" %}
</head>

<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-3"></div>

            <div class="col-md-6 offset-md-3">
                <form id="register" name="signup" method="POST" class="shadow p-4 bg-white" include-form-tracking>
                    <div class="row">

                        <div class="mb-3 text-center">
                        <img width="150px" style=""
                        src="../../static/image/logo.svg" alt="">

                        </div>

                        <div class="col mb-3" id="div_firstname" style="margin-top: 8px">
                            <label for="firstname">نام <span style="color: red">*</span>:</label>
                            <input type="text" class="form-control fa-input" id="firstname" include-content-tracking required>
                        </div>

                        <div class="col" id="div_lastname" style="margin-top: 8px">
                            <label for="lastname">نام خانوادگی <span style="color: red">*</span>:</label>
                            <input type="text" class="form-control fa-input" id="lastname" include-content-tracking required>
                        </div>

                        <div class="mb-3" id="div_email">
                            <label for="email">ایمیل <span style="color: red">*</span>:</label>
                            <input type="email" class="form-control" id="email" name="email" required include-content-tracking
                                placeholder="example@example.com">
                            <span class="text-danger">لطفا یک ایمیل معتبر وارد نمایید تا در فرآیند دسترسی به حساب خود دچار مشکل نشوید</span>

                        </div>

                        <div class="mb-3" id="div_phonenumber">
                            <label for="phonenumber">شماره تماس:</label>
                            <input type="tel" class="form-control" id="phonenumber" include-content-tracking placeholder="09123456789">
                        </div>

                        <div class="mb-3" id="div_role">
                            <label for="role">نوع کاربری <span style="color: red">*</span>:</label>
                            <select class="form-control" id="role">
                            </select>
                        </div>

                        <div class="mb-3" id="multipleSelectDiv">
                            <label for="expertise">زمینه تخصصی <span style="color: red">*</span>:</label>
                            <select class="form-select text-right float-right" style="direction: rtl;" id="expertise" multiple>
                            </select>
                        </div>

                        <div class="mb-3" id="div_username">
                            <label for="username">نام کاربری <span style="color: red">*</span>:</label>
                            <input type="username" class="form-control" id="username" required include-content-tracking placeholder="Username">
                        </div>

                        <div class="mb-3" id="div_password">
                            <label for="password">رمز عبور <span style="color: red">*</span>:</label>
                            <input type="password" class="form-control" id="password" required placeholder="Password">
                        </div>

                        <div class="mb-3" id="div_confirmPassword">
                            <label for="confirmPassword">تکرار رمز عبور <span style="color: red">*</span>:</label>
                            <input type="password" class="form-control" id="confirmPassword" required
                                placeholder="Confirm Password">
                        </div>
                        <div class="mb-2" id="messages"><span style="color: red">فیلدهای ستاره‌دار (*) اجباری
                                هستند</span></div>
                        <div class="mb-3" id="messages"></div>
                        
                        <div id="site_recapcha" dir="ltr" class="mb-3" style="display: flex; justify-content: center;">

                            {{ form_data }}
                        </div>
                        
                        <div class="mb-3 d-grid gap-2 col-6 mx-auto" id="div_sub">
                            
                            
                            <button class="btn btn-primary" id="sub" type="submit">ثبت نام</button>
                        </div>

                        <!--<p class="text-center mb-3" id="resend"><a href="/resend-email/"  class="text-decoration-none">ارسال مجدد کد تایید</a></p>-->
                        <div>
                            <hr id="hr">
                            <p class="text-center mb-3" id="prev_login">قبلا ثبت‌نام کرده‌اید؟<a href="{% url 'login' %}">ورود</a></p>
                        </div>
                    </div>
                </form>
                <form id="confirmEmailForm" class="shadow p-4 bg-white" style="display: none" method="POST" include-form-tracking>
                    <div class="row" id="row2">
                        <div class="mb-3 text-center" id="div_img2">
                            <img width="150px" id="img2"
                            src="../../static/image/logo.svg" alt="">
                        </div>
                        <div class="mb-3" id="messages2"></div>
                        <div class="mb-3" id="messages3"></div>
                        <div class="mb-3" id="div_confirmEmail">
                            <label for="confirmEmail"></label>
                            <input class="form-control"
                                type="password"
                                name="confirmEmail"
                                id="confirmEmail"
                                include-content-tracking
                                placeholder="کد تایید">

                            <div class="mb-3" id="messages4"></div>
                            <div class="mb-3 d-grid gap-2 col-6 mx-auto second">
                                <button class="btn btn-primary second-btn" id="sub2" type="submit">تایید کد</button>
                            </div>
                        </div>
                            <p class="mb-3" id="resend2"><a href="#" type="click" class="float-start text-decoration-none">ارسال مجدد کد تایید</a></p>
                            <p class="mb-0" id="login" style="display: none"><a href="/login/"  class="float-start  text-decoration-none">ورود</a></p>
                    </div>
                </form>

            </div>
        </div>
        <div id="HooshyarAlert"></div>
    </div>
    <div class="col-md-3"></div>
    
    
    <script>
        init()

        async function init() {
           await Promise.all([getUserRoles(), getUserExpertise()])
            $('#expertise').multiSelect();
        }

         function getMultiSelectValue(container_id) {
            let e = document.getElementById(container_id);
            let selected = [...e.options]
                .filter(option => option.selected)
                .map(option => option.value)
            return selected.join(",")
        }


        async function getUserRoles() {
            const request_link = 'http://' + location.host + "/GetUserRole/";
            let response = await fetch(request_link);
            response = await response.json();
            const user_roles = response["user_roles"]
            console.log(user_roles)
            for (const role of user_roles) {
                const tag = "<option value=" + role["id"] + " >" + role["name"] + "</option>";
                document.getElementById("role").innerHTML += tag;
            }
        }

        async function getUserExpertise() {
            const request_link = 'http://' + location.host + "/GetUserExpertise/";
            let response = await fetch(request_link);
            response = await response.json();
            const res = response["result"]
            for (const exp of res) {
                const tag = "<option value=" + exp["id"] + " >" + exp["expertise"] + "</option>";
                document.getElementById("expertise").innerHTML += tag;
            }
        }

       

        document.getElementById("register").addEventListener("submit", onSubmit);

        async function onSubmit(e){
            e.preventDefault()
            const formElements = e.target.elements

            let phonenumber = 0;
            if (formElements.phonenumber.value !== "")
                phonenumber = formElements.phonenumber.value;


            if (grecaptcha.getResponse() === ""){
                const messages = document.getElementById("messages");
                messages.classList.remove("text-danger", "text-success")
                messages.innerText = "لطفا تیک من ربات نیستم را بزنید!"
                messages.classList.add("text-danger")
            }
            else{

                const expertise = getMultiSelectValue("expertise")
                const user_ip = "127.0.0.0"
                const request_link = 'http://' + location.host + "/SaveUser/" + formElements.firstname.value + "/" + formElements.lastname.value + "/" + formElements.email.value + "/" + phonenumber + "/" + formElements.role.value + "/" + formElements.username.value + "/" + formElements.password.value + "/" + user_ip + "/" + expertise + "/";
                let response = await fetch(request_link);
                response = await response.json();

                const messages = document.getElementById("messages");
                messages.classList.remove("text-danger", "text-success")

                if (response.status === "enabled username") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "تایید شما توسط ادمین در حال بررسی است. لطفا منتظر تایید بمانید. نتیجه بررسی ادمین، به شما ایمیل خواهد شد."
                }
                else if (response.status === "enabled email") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "تایید شما توسط ادمین در حال بررسی است. لطفا منتظر تایید بمانید. نتیجه بررسی ادمین، به شما ایمیل خواهد شد."
                }
                else if (response.status === "accepted username") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "تایید شما توسط ادمین انجام شده است. می‌توانید وارد سامانه شوید."
                }
                else if (response.status === "accepted email") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "تایید شما توسط ادمین انجام شده است. می‌توانید وارد سامانه شوید."
                }
                else if (response.status === "refused username") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "متاسفانه تایید شما توسط ادمین رد شده است. در صورت داشتن هر گونه سوال، می‌توانید با پشتیبانی تماس بگیرید."
                }
                else if (response.status === "refused email") {
                    alert_text_header = "ثبت‌نام شما با موفقیت انجام شده است."
                    alert_text_body = "متاسفانه تایید شما توسط ادمین رد شده است. در صورت داشتن هر گونه سوال، می‌توانید با پشتیبانی تماس بگیرید."
                }
                else if (response.status === "OK") {
                    messages2.innerText = "عملیات با موفقیت انجام شد. کد تایید به شما ایمیل شده است."
                    messages3.innerText = "کد ارسال شده را در اینجا وارد کنید. در صورت عدم دریافت ایمیل کد تایید، بر روی دکمه‌ی ارسال مجدد کد تایید، کلیک فرمایید."
                    register.style.display = "none";
                    confirmEmailForm.style.display = "block";
                    messages2.style.color = "green";
                    messages2.classList.add("text-center")
                    messages3.style.color = "green";
                    messages3.classList.add("text-center")
                }

                HooshyarAlertShow(alert_text_header, alert_text_body, 2)
            
            }
        }
        //check password and confirm password for matching
        window.onload = function () {
            var password = document.getElementById("password");
            var confirmPassword = document.getElementById("confirmPassword");
            password.onchange = ConfirmPassword;
            confirmPassword.onkeyup = ConfirmPassword;

            function ConfirmPassword() {
                confirmPassword.setCustomValidity("");
                if (password.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity("رمز عبور و تکرار آن باید یکسان باشد");
                }
            }
        }

        document.getElementById("confirmEmailForm").addEventListener("submit", onSubmit2);
        async function onSubmit2(e2) {
            e2.preventDefault()
            try {                
                const link = 'http://' + location.host + "/signup/" + document.getElementById("register").elements.namedItem("email").value + "/" + document.getElementById("confirmEmailForm").elements.namedItem("confirmEmail").value;
                let response = await fetch(link);
                response = await response.json();
                               
                if (response.status == "OK") {
                    messages4.innerText = "ثبت‌نام شما با موفقیت انجام شد. تایید شما توسط ادمین، بررسی خواهد شد. نتیجه‌ی بررسی ادمین، در ایمیل، برای شما ارسال می‌شود."
                    sub2.style.display = "none";
                    confirmEmail.style.display = "none";
                    messages2.style.display = "none";
                    messages3.style.display = "none";
                    resend2.style.display = "none";
                    login.style.display = "block";
                    messages4.style.color = "green";
                    messages4.classList.remove("text-danger")
                    messages4.classList.add("text-center")
                } else if (response.status == "deactive code") {
                    messages4.innerText = "کد وارد شده، منقضی شده است. لطفا بر روی دکمه‌ی ارسال مجدد کد تایید کلیک فرمایید و کد جدید را دریافت کنید. کد جدید به شما ایمیل خواهد شد"
                    messages4.classList.remove("text-center")
                    messages4.classList.add("text-danger")
                } else {
                    throw new Error("Invalid data")
                }
            } catch(e2) {
                messages4.innerText = "کد تایید، نادرست است."
                messages4.classList.remove("text-center")
                messages4.classList.add("text-danger")
            }

        }

        document.querySelectorAll('a[type="click"]').forEach((element) => {
            element.addEventListener("click", resend);
        });
        async function resend(e3) {
            e3.preventDefault()
            try {                
                const link = 'http://' + location.host + "/signup/" + document.getElementById("register").elements.namedItem("email").value;
                let response = await fetch(link);
                response = await response.json();

                let alert_text_header = ""
                let alert_text_body = ""
                               
                if (response.status == "OK") {
                    console.log("ok")
                    alert_text_header = "کد تایید، مجددا ارسال شده است."
                    alert_text_body = "لطفا کد ارسال شده را وارد نمایید."
                    
                } else {
                    throw new Error("Invalid data")
                }

                HooshyarAlertShow(alert_text_header, alert_text_body, 2)
            } catch(e3) {
                console.log("not ok")
                alert_text_header = "خطایی در ارسال مجدد کد، رخ داده است."
                alert_text_body = "لطفا مجددا بر روی دکمه‌ی ارسال مجدد کد تایید، کلیک فرمایید."

                HooshyarAlertShow(alert_text_header, alert_text_body, 2)
                
            }
            
        }

    </script>
    <script>
        $('.js-captcha-refresh').click(function(){
            $form = $(this).parents('form');
            $.getJSON($(this).data('url'), {}, function(json) {
                // This should update your captcha image src and captcha hidden input
            });
            return false;
        });

        let list = document.getElementById('site_recapcha');
        list.removeChild(list.getElementsByTagName('label')[0]);

        var onSubmit_8c3429f3a8224892ad7e670900b9c2ec = function(token) {
        console.log("reCAPTCHA validated milad for 'data-widget-uuid=\"8c3429f3a8224892ad7e670900b9c2ec\"'")
    };

    </script>

    <script> initXC(304, "wKxiyjGD2r9Iv3zK4JoAV3qWL0cJlsjG2lkfcT98");</script>
</body>

</html>