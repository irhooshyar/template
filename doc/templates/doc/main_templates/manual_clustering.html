<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../../static/library/bootstrap-5.1.2.bundle.min.js"></script>


    <!--BS Icons -->
    <link rel="stylesheet" href="../../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../../static/library/fontawesome-5.10.0.all.css" />
    <link rel="stylesheet" href="../../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../../static/library/tom-select-2.2.1.css">
    <script src="../../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../../static/js/searchable-select.js"></script>

    <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-tag-cloud.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-heatmap.min.js"></script>

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../../static/js/footable/demo-rows.js"></script>
    <script src="../../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../../static/js/footable/footable.js"></script>
    <link href="../../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <!-- searchable select -->
    <link rel="stylesheet" type="text/css" href="../../../static/library/tom-select-2.2.1.css">
    <script src="../../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../../static/styles/index2.css">

    <!-- Intro Js -->
    <script src="../../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../../static/library/notyf.min-npm.css">
    <script src="../../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../../static/js/chart.js"></script>
    <meta charset="UTF-8">
    <title>خوشه‌بندی سفارشی</title>

    {% include "doc/base_templates/title_icon.html" %}

    <style>
        .popover-header,
        .popover-body {
            direction: rtl;
            text-align: right;
            font-family: vazir;
        }
    </style>
</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/base_templates/header.html" %}
    </nav>

    <!-- Intro Js -->
    <script src="../../../static/js/search/search_tour.js"></script>
    <script src="../../../static/js/tour.js"></script>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#AIDropdown').addClass('active');
            $('#ManualClustering').addClass('active');


            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row p-5 flex-row-reverse bg-light mx-0">
        <form id="subject_analysis_form" action="" class="custom-control mx-auto needs-validation"
            enctype="multipart/form-data" method="post" novalidate>

            <div class="row flex-row-reverse mx-auto">

                <!-- Country select -->
                <div class="col-md-6 col-12 col-lg-2 bg-light pt-3  mt-1" dir="rtl">
                    <label for="country" class=" text-right bg-light float-right">مجموعه خبر:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
      
                        <option value="{{ k }}">{{ v }}</option>


                        {% endfor %}
                    </select>
                </div>


                <!-- Key Words List Container-->
                <div class="row flex-row-reverse w-50 mt-1 pt-3">
                    <div class="p-4 bg-white" style="border-radius: 15px; box-shadow: 0px 1px 6px 1px #c9c9c945">
                        <div class="flex-column-reverse" id="clustering-list-container">
                        </div>
                        <div class="row" style="padding: 24px">
                            <button type="button" id="add_keyword_input" onclick="addCluster()"
                                class="btn btn-primary mt-1 col-2" style="width: 120px">
                                افزودن +
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Show button -->
                <div class="col-md-6 col-12 col-lg-1 bg-light" style="margin-top: 46px">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mt-1 mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>

                </div>


            </div>
        </form>

        <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="result_doc" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#result_doc_subject" type="button" role="tab" aria-controls="result_doc_subject"
                    aria-selected="true">پاراگراف‌ها خوشه</button>
            </li>


            <!-- <li class="nav-item float-right" role="presentation">
                <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#bar_chart_info_pane" type="button" role="tab" aria-controls="bar_chart_info_pane"
                    aria-selected="false">داشبورد آماری</button>
            </li> -->

            <!-- Download Buttons -->
            <!-- <button type="button" disabled data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اخبار"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

            </button>

            <button disabled class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
            </button> -->

            <!-- Result Count -->
            <p dir="rtl" id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>
        </ul>

        <div id="original_pane" class="tab-content float-right bg-white px-1" style="position: relative;"
            id="pills-tabContent">

            <div dir=rtl id="result_doc_subject" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                aria-labelledby="result_doc_subject">
                <div class="table-responsive mt-4">
                    <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                    </table>
                </div>
            </div>

        </div>



    </div>

    <!-- Distributions Modal Container -->
    <div class="modal fade" id="distributionsModal">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="DistModalHeader" class="modal-title">تحلیل توزیعی</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="dist_chart_info" class="modal-body bg-light text-justify">


                    <div class="row mt-0 w-100 flex-row-reverse mx-0 px-0">

                        <div id="year_container" class="half">
                        </div>
                        <div id="subject_container"  class="half"></div>

                        <div id="category_container" class="full" chart-height="750px"></div>
                        
                        </div>

                    </div>

                </div>
                <!-- Modal footer -->
                <div class="modal-footer">

                    
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="ClouddetailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="CloudHeader" class="modal-title">ابر واژگان</h5>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div id="CloudText" class="bg-light text-justify mx-2 h-100">
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="paraDetailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="paraModalHeader" class="modal-title">جزئیات خوشه</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <h6 id="DocsCount" class='text-secondary'></h6>

                    <div id="paraDetailText" class="bg-light text-justify mx-2">
                    </div>

                    <button id="LoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left" style="color: #0e3f8b"><i
                            class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش بیش‌تر</button>

                </div>
                <!-- Modal footer -->
                <div id="detail_modal_footer" dir="ltr" class="modal-footer">


                    <!-- <input type="number" id="ColumnModalPaginationInput" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none"> -->

                    

                    <!-- <button id="ExportExcel2" onclick="TopicParagraphs_Excel()"
                        class="btn btn-outline-primary float-left"><i class="fa fa-download"></i>
                        خروجی اکسل پاراگراف‌ها
                    </button> -->
                </div>

            </div>
        </div>
    </div>



    <!-- Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content" style="direction: rtl !important;">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 id="detailModalHeader" class="modal-title">عنوان خبر</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"
                        onclick="default_modal()"></button>
                </div>

                <!-- Modal body -->
                <div id="detailModalBody" class="modal-body bg-light text-justify">
                    <h4>کلیدواژه‌های خوشه:</h3>
                        <div dir='ltr' class="flex-column-reverse" id="keywords-list-container">
                        </div>
                        <div dir='ltr' class="row" style="padding: 24px">
                            <button type="button" id="add_keyword_input" onclick="addKeyword()"
                                class="btn btn-primary mt-1 col-2" style="width: 120px">
                                افزودن +
                            </button>
                        </div>
                        <hr>
                        <h4>کلیدواژه‌های حذفی:</h3>
                            <div dir='ltr' class="flex-column-reverse" id="Delete-keywords-list-container">
                            </div>
                            <div dir='ltr' class="row" style="padding: 24px">
                                <button type="button" id="add_keyword_input" onclick="addDeleteKeyword()"
                                    class="btn btn-primary mt-1 col-2" style="width: 120px">
                                    افزودن +
                                </button>
                            </div>

                </div>

                <!-- Modal footer -->
                <div id="modal-footer" class="modal-footer">
                </div>

            </div>
        </div>
    </div>






    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../../static/js/logincheck.js"></script>


    <script src="../../../static/js/scroll_button_handler.js"></script>

    <script src="../../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../../static/js/zipDownload/FileSaver.min.js"></script>
    <script src="../../../static/js/ChartColumnInteractivity.js"></script>

        <!-- save log user -->
    <script>
        async function UserLog(form_data) {
            if (getCookie("username") !== "") {
                const user_name = getCookie("username")
                let page_url = window.location.pathname
                const user_ip = "127.0.0.0"
                page_url = page_url.slice(0, -1);
                if (page_url === "") {
                    page_url = "/0";
                }


                let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

                $.ajax({
                    url: link_request,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: true,


                }).done(function (res) {
                    console.log("done")

                }).fail(function (res) {
                    console.log("fail")
                });

            }
        }
    </script>

    <script>
        let SearchResultValue = {}
        init()
        container_id_list = ['SearchTable', 'SearchResultLable']
        let main_cluster_index = 1
        let main_cluster_result = []
        let clusters_data = {}
        CHART_FIELD_DICT = {
            "category_container": "category_name",
            "year_container": "document_year",
            "subject_container": "subject_name",
        }
        CHART_NAME_DICT = {
            "category_container": "دسته پاراگراف‌ها",
            "year_container": "سال  پاراگراف‌ها",
            "subject_container": "موضوع پاراگراف‌ها",
        }

        MAX_RESULT_WINDOW = 5000
        SEARCH_RESULT_SIZE = 25


        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        async function init() {
            initSearchableSelects();
            addCluster();
            addKeyword()
            addKeyword()
            addDeleteKeyword()
            addDeleteKeyword()

            //user log
            let form_data = new FormData()
            detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)
        }

        async function CountryChanged() {

            clearPrevResults(container_id_list);
            countryId = document.getElementById("country").value

             //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name = $("#country option:selected").text();
            form_data.append('detail_type', detail_type);
            form_data.append('country_name', country_name);
            UserLog(form_data)
 

        }

        async function ShowResult() {
            await clearPrevResults(container_id_list)
            await SpinnerModeFunction("Active");
            await show_main_table_result();
            await SpinnerModeFunction("Disable");

        }

        async function show_table_result() {

            columns = [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام خبر",
                "style": {
                    "width": "30%"
                }
            }, {
                "name": "paragraph_text",
                "title": "متن حکم",
                "style": {
                    "width": "60%"
                }
            }, {
                "name": "count",
                "title": "امتیاز",
                "style": {
                    "width": "5%"
                }
            }]


            $('#SearchTable').empty();
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "خبری یافت نشد.",
                "columns": columns,
                "rows": TABLE_INFO
            });
        }


        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }

        }


        function addKeyword() {
            const values = getKeywordsListValues()
            values.push({ name: "", score: null })
            renderKeywordItems(values)
        }

        function renderKeywordItems(values) {
            if (!values) {
                values = getKeywordsListValues()
            }

            const tags = values.map((v, idx) => {
                let deleteTag = ""
                if (idx > 1) {
                    deleteTag = `<div class="col-2 row flex-column-reverse">
                                <button class="btn btn-danger" style="width: 120px" onclick="removeKeywordItem(${idx})">حذف x</button>
                            </div>`
                }

                return `<div class="row flex-row-reverse mb-2 item">
                            <div class="col-7">
                                <label class="text-right float-right">کلیدواژه ${idx + 1}:</label>
                                <input type="text" value="${v.name}" class="item-keyword float-left form-control text-right"
                                       style="direction: rtl;">
                            </div>
                            <div class="col-3">
                                <label class="text-right float-right">امتیاز:</label>
                                <input type="number" value="${v.score}" class="item-keyword-score float-left form-control text-right"
                                       style="direction: rtl;"/>
                            </div>
                            ${deleteTag}
                        </div>`
            }).join('')

            document.getElementById("keywords-list-container").innerHTML = tags;
        }

        function removeKeywordItem(index) {
            document.querySelectorAll(`#keywords-list-container .item`)[index].remove();
            renderKeywordItems()
        }

        function getKeywordsListValues() {
            const items = document.querySelectorAll(`#keywords-list-container .item`);
            const values = [...items].map(item => {
                const name = item.querySelector(".item-keyword").value;
                const score = item.querySelector(".item-keyword-score").value;
                return { name, score }
            })

            return values;
        }

        function addDeleteKeyword() {
            const values = getDeleteKeywordsListValues()
            values.push({ name: "" })
            renderDeleteKeywordItems(values)
        }

        function renderDeleteKeywordItems(values) {
            if (!values) {
                values = getDeleteKeywordsListValues()
            }

            const tags = values.map((v, idx) => {
                let deleteTag = ""
                if (idx > 1) {
                    deleteTag = `<div class="col-2 row flex-column-reverse">
                                <button class="btn btn-danger" style="width: 120px" onclick="removeDeleteKeywordItem(${idx})">حذف x</button>
                            </div>`
                }

                return `<div class="row flex-row-reverse mb-2 item">
                            <div class="col-7">
                                <label class="text-right float-right">کلیدواژه ${idx + 1}:</label>
                                <input type="text" value="${v.name}" class="item-keyword float-left form-control text-right"
                                       style="direction: rtl;">
                            </div>
                            ${deleteTag}
                        </div>`
            }).join('')

            document.getElementById("Delete-keywords-list-container").innerHTML = tags;
        }

        function removeDeleteKeywordItem(index) {
            document.querySelectorAll(`#Delete-keywords-list-container .item`)[index].remove();
            renderDeleteKeywordItems()
        }

        function getDeleteKeywordsListValues() {
            const items = document.querySelectorAll(`#Delete-keywords-list-container .item`);
            const values = [...items].map(item => {
                const name = item.querySelector(".item-keyword").value;
                return { name }
            })

            return values;
        }

        function addCluster() {
            const values = getClusteringListValues()
            values.push({ cluster_name: "" })
            renderClusteringItems(values)
        }

        function renderClusteringItems(values) {
            if (!values) {
                values = getClusteringListValues()
            }

            const tags = values.map((v, idx) => {
                let deleteTag = ""
                if (idx > 0) {
                    deleteTag = `<div class="col-2 row flex-column-reverse">
                                <button class="btn btn-danger" style="width: 120px" onclick="removeClusteringItems(${idx})">حذف x</button>
                            </div>`
                }

                return `<div class="row flex-row-reverse mb-2 item">
                            <div class="col-7">
                                <label class="text-right float-right">خوشه ${idx + 1}:</label>
                                <input type="text" value="${v.cluster_name}" class="item-cluster float-left form-control text-right"
                                       style="direction: rtl;">
                            </div>
                            <div class="col-2" style="margin-top: 27px;">
                                <button type="button" id="keyword_detail_button" onclick="KeywordShowDetail(${idx + 1})"
                                    class="keyword_detail_button btn btn-primary mt-1 float-left form-control" data-bs-toggle="modal" data-bs-target="#detailModal">
                                    جزئیات
                                </button>
                            </div>
                            ${deleteTag}
                        </div>`
            }).join('')

            document.getElementById("clustering-list-container").innerHTML = tags;
        }

        function removeClusteringItems(index) {
            document.querySelectorAll(`#clustering-list-container .item`)[index].remove();
            renderClusteringItems()
        }

        function getClusteringListValues() {
            const items = document.querySelectorAll(`#clustering-list-container .item`);
            const values = [...items].map(item => {
                const cluster_name = item.querySelector(".item-cluster").value;

                return { cluster_name }
            })

            return values;
        }

        function KeywordShowDetail(cluster_id) {
            cluster_name = 'خوشه ' + cluster_id
            document.getElementById("detailModalHeader").innerHTML = cluster_name
            const tag = `<button type="button" class="btn btn-primary" onclick="submitData(${cluster_id})" data-bs-dismiss="modal">تایید</button>`
            document.getElementById("modal-footer").innerHTML = tag
        }

        function default_modal() {
            document.getElementById("keywords-list-container").innerHTML = ''
            addKeyword()
            addKeyword()
            document.getElementById("Delete-keywords-list-container").innerHTML = ''
            addDeleteKeyword()
            addDeleteKeyword()
        }

        function submitData(cluster_id) {
            document.getElementById("document_search").disabled = true;
            console.log(cluster_id)
            const clusterValues = getClusteringListValues();
            const keywordsValues = getKeywordsListValues();
            const deleteKeywordsValues = getDeleteKeywordsListValues();
            const country_id = document.getElementById("country").value

             //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name = $("#country option:selected").text();
            form_data.append('detail_type', detail_type);
            form_data.append('country_name', country_name);
            UserLog(form_data)

            let data = {
                "cluster_name": "",
                "cluster_id": null,
                "cluser_keyword_data": [],
                "cluster_delete_data": []
            }

            data["cluster_id"] = cluster_id

            if (clusterValues[cluster_id - 1]['cluster_name'] != '') {
                data["cluster_name"] = clusterValues[cluster_id - 1]['cluster_name']
            } else {
                cluster_name = 'خوشه ' + cluster_id
                data["cluster_name"] = cluster_name
            }

            keywordsValues.forEach(v => {
                if (v.name != "" && v.score != "") {
                    data["cluser_keyword_data"].push([v.name, v.score]);
                }
            })
            deleteKeywordsValues.forEach(v => {
                if (v.name != "") {
                    data["cluster_delete_data"].push(v.name);
                }
            })

            clusters_data[cluster_id] = data

            if (data["cluser_keyword_data"].length == 0) {
                // console.log(data)
            }
            else {
                let form_data = new FormData()
                form_data.append('cluster_name', data['cluster_name'])
                form_data.append('cluster_id', data['cluster_id'])
                form_data.append('cluser_keyword_data', data['cluser_keyword_data'])
                form_data.append('cluster_delete_data', data['cluster_delete_data'])
                
                //user log
                UserLog(form_data)

                let link_request = 'http://' + location.host + "/BoostingSearchParagraph_ES/" + country_id + "/" + 1 + "/" + 100 + "/";

                $.ajax({
                    url: link_request,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: true,


                }).done(function (res) {
                    total_hits = res["total_hits"]
                    console.log(total_hits)

                    const detail_function = "DetailFunction(" + cluster_id + ")";
                    const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" '
                        + ' onclick="' + detail_function + '" data-bs-target="#paraDetailModal">جزئیات</button>';

                    const cloud_function = `CloudFunction('${data['cluser_keyword_data']}','CloudText')`;
                    const cloud = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" '
                        + ' onclick="' + cloud_function + '" data-bs-target="#ClouddetailModal">مشاهده</button>'

                    const chart_function = "ChartFunction(" + cluster_id + ")";
                    const chart = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' 
                        + ' onclick="' + chart_function + '" data-bs-target="#distributionsModal">مشاهده</button>'


                    const row = {
                        "id": main_cluster_index,
                        "cluster_name": data['cluster_name'],
                        "total_hits": total_hits,
                        "subject_chart": chart,
                        "cloud": cloud,
                        "detail": detail,
                    }
                    main_cluster_result.push(row)
                    main_cluster_index += 1

                    default_modal()
                    document.getElementById("document_search").disabled = false;

                }).fail(function (res) {
                    console.log("fail")
                });
            }
        }

        async function show_main_table_result() {

            columns = [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "cluster_name",
                "title": "نام خوشه",
                "style": {
                    "width": "30%"
                }
            }, {
                "name": "total_hits",
                "title": "تعداد پاراگراف‌ها",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "cloud",
                "title": "ابر واژگان",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "subject_chart",
                "title": "داشبورد آماری",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "detail",
                "title": "پاراگراف‌ها مرتبط",
                "style": {
                    "width": "10%"
                }
            }]


            $('#SearchTable').empty();
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "خبری یافت نشد.",
                "columns": columns,
                "rows": main_cluster_result
            });
        }

        function DetailFunction(cluster_id) {

            data = clusters_data[cluster_id]
            const country_id = document.getElementById("country").value

            document.getElementById("paraDetailText").innerHTML = ''
            let form_data = new FormData()
            form_data.append('cluster_name', data['cluster_name'])
            form_data.append('cluster_id', data['cluster_id'])
            form_data.append('cluser_keyword_data', data['cluser_keyword_data'])
            form_data.append('cluster_delete_data', data['cluster_delete_data'])

            let link_request = 'http://' + location.host + "/BoostingSearchParagraph_ES/" + country_id + "/" ;

            request_configs = {
            "link": link_request,
            "search_result_size": SEARCH_RESULT_SIZE,
            "max_result_window": MAX_RESULT_WINDOW,
            "data_type": "form_data",
            "form_data": form_data
            }

            // highlight_parameters = { "keyword_list": keyword_list }

            highlight_configs = {
                "parameters": null,
                "highlight_enabled": false,
                "custom_function": null
            }

            modal_configs = {
                "body_id": "paraDetailText",
                "modal_load_more_btn_id": "LoadMoreDocuments",
                "result_size_container_id": "DocsCount",
                "result_size_message": "حکم",
                "list_type": "ordered",
                "custom_body_function": null,
                "body_parameters": null

            }

            export_configs = {
                "link": null,
                "btn_id": null
            }
            segmentation_config = {
                "parameters": null,
                "keyword": null,
                "enable": false,
                "aggregation_keyword":null
            }
            column_interactivity_obj = new ColumnInteractivity("paragraphs",
                request_configs, export_configs, modal_configs, highlight_configs,segmentation_config)

            column_interactivity_obj.load_content();

}

        function ChartFunction(cluster_id){
            data = clusters_data[cluster_id]
            const country_id = document.getElementById("country").value

            let form_data = new FormData()
            form_data.append('cluster_name', data['cluster_name'])
            form_data.append('cluster_id', data['cluster_id'])
            form_data.append('cluser_keyword_data', data['cluser_keyword_data'])
            form_data.append('cluster_delete_data', data['cluster_delete_data'])

            let link_request = 'http://' + location.host + "/BoostingSearchParagraph_ES/" + country_id + "/" + 1 + "/" + 100 + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                curr_page = res["curr_page"]
                total_hits = res["total_hits"]
                ES_Aggregations = res["aggregations"]

                // subject_data = ES_Aggregations['subject-agg']['buckets']
                subject_data = ES_Aggregations['subject-agg']['buckets']
                document_year_data = ES_Aggregations['document-year-agg']['buckets']
                category_data = ES_Aggregations['category-agg']['buckets']



                // showChartData(country_id, subject_data, "subject_container", documents_information_result, false, "موضوع حکم")
                showChartData(country_id, cluster_id, document_year_data, "year_container", true, "سال خبر", "توزیع پاراگراف‌ها براساس سال اخبار")
                showHistogramChart(country_id, cluster_id, subject_data, "subject_container", false, "موضوع خبر", "توزیع پاراگراف‌ها براساس موضوع")
                showChartData(country_id, cluster_id, category_data, "category_container", false, "دسته خبر", "توزیع پاراگراف‌ها براساس دسته اخبار")

            }).fail(function (res) {
                console.log("fail")
            });
        }

        function showChartData(country_id, cluster_id, data, container, keySort, xAxisTitle, title) {
        let chart_data = []
        for (column of data) {

            key = column["key"]
            value = column["doc_count"]

            chart_data.push([key, value])
        }
        showBaseChart(country_id, cluster_id, chart_data, container, keySort, xAxisTitle, title)
    }

        function showHistogramChart(country_id, cluster_id, data, container, sortKeys, xAxisTitle, title) {
            // dict { 'approval_reference': [{ x: count, y: 1 }]
            const references = {};
            data.forEach(ref => {
                references[ref.key] = [{x: String(ref.doc_count), y: 1}]
            });
            const options = {
                data: references,
                sortKeys,
                xAxisTitle,
                title,
                showLabels: true,
                yAxisTitle: "تعداد پاراگراف‌ها",
                onClick: async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let field_value = data.row(index)[0];
                    let field_name = CHART_FIELD_DICT[position] + ".keyword"
                    let chart_name = CHART_NAME_DICT[position]

                    if (position == "year_container") {

                        field_name = field_name.replaceAll(".keyword", "");
                        if (field_value == "نامشخص")
                            field_value = 0
                    }

                    await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                    $("#detailModal").modal("show")
                    $("#detail_modal_footer #close_btn").show();
                    $("#detail_modal_footer #ExportExcel2").hide();
                }
            };

            newStackedColumnChart(container, options)
        }

        function showBaseChart(country_id, cluster_id, data, position, sortKeys, xAxisTitle, title) {
            const options = {
                title,
                xAxisTitle,
                data,
                yAxisTitle: "تعداد پاراگراف‌ها",
                sortKeys,
                onclick: async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let field_value = data.row(index)[0];
                    let field_name = CHART_FIELD_DICT[position] + ".keyword"
                    let chart_name = CHART_NAME_DICT[position]

                    if (position == "year_container") {

                        field_name = field_name.replaceAll(".keyword", "");
                        if (field_value == "نامشخص")
                            field_value = 0
                    }

                    await GetClickedColumnParagraphs(country_id, cluster_id, chart_name, field_name, field_value)

                    $("#paraDetailModal").modal("show")

                }
            }
            newBarChart(position, options)
        }

    async function GetClickedColumnParagraphs(country_id, cluster_id, chart_name, field_name, field_value) {
        startFullPageBlockUI();

        // clear prev results
        document.getElementById("paraModalHeader").innerHTML = ""
        document.getElementById("DocsCount").innerHTML = ""
        document.getElementById("paraDetailText").innerHTML = ""

        // get data
        data = clusters_data[cluster_id]

        let form_data = new FormData()
        form_data.append('cluster_name', data['cluster_name'])
        form_data.append('cluster_id', data['cluster_id'])
        form_data.append('cluser_keyword_data', data['cluser_keyword_data'])
        form_data.append('cluster_delete_data', data['cluster_delete_data'])

        modal_header = chart_name + ": " + (field_value != 0 ? field_value : "نامشخص")
        document.getElementById("paraModalHeader").innerHTML = modal_header

        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/BoostingSearchParagraph_Column_ES/" + country_id
            + "/" + field_name + "/" + field_value + "/";

            request_configs = {
            "link": request_link,
            "search_result_size": SEARCH_RESULT_SIZE,
            "max_result_window": MAX_RESULT_WINDOW,
            "data_type": "form_data",
            "form_data": form_data
        }

        // highlight_parameters = { "keyword_list": keyword_list }

        highlight_configs = {
            "parameters": null,
            "highlight_enabled": false,
            "custom_function": null
        }

        modal_configs = {
            "body_id": "paraDetailText",
            "modal_load_more_btn_id": "LoadMoreDocuments",
            "result_size_container_id": "DocsCount",
            "result_size_message": "حکم",
            "list_type": "ordered",
            "custom_body_function": null,
            "body_parameters": null

        }

        export_configs = {
            "link": null,
            "btn_id": null
        }
        segmentation_config = {
                "parameters": null,
                "keyword": null,
                "enable": false,
                "aggregation_keyword":null
            }
        column_interactivity_obj = new ColumnInteractivity("paragraphs",
            request_configs, export_configs, modal_configs, highlight_configs,segmentation_config)

        column_interactivity_obj.load_content();

        stopFullPageBlockUI('کلیک روی نمودار');
    }


    async function GetClickedColumnParagraphs2(country_id, cluster_id, chart_name, field_name, field_value) {
        startFullPageBlockUI();

        // clear prev results
        document.getElementById("paraModalHeader").innerHTML = ""
        document.getElementById("DocsCount").innerHTML = ""
        document.getElementById("paraDetailText").innerHTML = ""

        // get data
        data = clusters_data[cluster_id]

        let form_data = new FormData()
        form_data.append('cluster_name', data['cluster_name'])
        form_data.append('cluster_id', data['cluster_id'])
        form_data.append('cluser_keyword_data', data['cluser_keyword_data'])
        form_data.append('cluster_delete_data', data['cluster_delete_data'])

        modal_header = chart_name + ": " + (field_value != 0 ? field_value : "نامشخص")
        document.getElementById("paraModalHeader").innerHTML = modal_header

        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/BoostingSearchParagraph_Column_ES/" + country_id
            + "/" + field_name + "/" + field_value + "/" + 1 + "/" + 100 + "/";

            $.ajax({
                url: request_link,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                curr_page = res["curr_page"]
                boosting_paragraphs = res["result"]
                total_hits = res["total_hits"]

                let index = 1
                let document_result = []
                let body_content = "";

                for (let doc of boosting_paragraphs) {
                    const es_id = doc["_id"]
                    const id = doc["_source"]["document_id"]
                    const name = doc["_source"]["document_name"]
                    const paragraph_id = doc["_source"]["paragraph_id"]
                    let paragraph_text = ''

                    try {
                        paragraph_text = doc["highlight"]["attachment.content"]
                    } catch (error) {
                        paragraph_text = doc["_source"]["attachment"]["content"]
                    }
                    // console.log(paragraph_text)

                    let count = Math.round((doc['_score'] * 100)) / 100

                    const document_link = 'http://' + location.host + "/document_profile/?id=" + id
                    const doc_name = "<a title='پروفایل خبر' class='bold text-secondary' target='blank' href='" + document_link + "'>" + name + "</a>"

                    paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + paragraph_id;

                    paragraph_tag = "<a class='' title = 'پروفایل حکم' target='blank' href='" + paragraph_link + "'>" + paragraph_text + "</a>"


                    const tag = "<li class='mb-3 lh-lg'>" + doc_name + paragraph_tag + "</li>"
                    body_content += tag

                }

                modal_content = "<ol start='" + 1 + "'>" + body_content + "</ol>"
                document.getElementById("paraDetailText").innerHTML += modal_content
                document.getElementById("DocsCount").innerHTML = total_hits + ' حکم:'


            }).fail(function (res) {
                console.log("fail")
            });

        stopFullPageBlockUI('کلیک روی نمودار');
    }



        async function CloudFunction(tag_cloud_data, container) {
            // create a chart and set the data
            const data = tag_cloud_data.split(",");
            Could_data = []

            for (let i = 0; i < data.length; i += 2) {
                Could_data.push({ "x": data[i], "value": parseFloat(data[i + 1]) })
            }
            console.log(Could_data)

            document.getElementById(container).innerHTML = ""

            var chart = anychart.tagCloud(Could_data);
            chart.fontFamily('vazir');

            // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
            chart.tooltip().fontFamily('vazir').textDirection('rtl');

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir").textDirection('rtl');

            // configure angles
            chart.angles([0]);
            chart.textSpacing(10);
            // set the container id
            chart.container(container);
            // chart.tooltip().format("{درصد نسبی: %yPercentOfTotal}% \n({%value})");
            chart.tooltip().format("درصد نسبی: {%yPercentOfTotal}%");

            // initiate drawing the chart
            chart.draw();
        }

    </script>
    <!-- Export results -->

    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = $('#country option:selected').val()

            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            // save_file_name += " مجموعه خبر {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            // file_name_list = documents_information_dict
            for (const doc_info of file_name_list) {

                const document_name = doc_info['document_name'] + extension

                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI('دانلود اخبار');
        }

        async function DownloadSerachResultFunction() {
            const save_file_name = "پنل تحلیل درگاه: "
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var csv = "";

            sep = ","


            let Csv = "نام خبر" + sep + "موضوع خبر" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "کلمات کلیدی" +
                "\n"
            for (const doc_info of SearchResultValue) {
                const document_name = doc_info["document_name"]
                const document_subject = doc_info['document_subject']
                const document_approval_reference = doc_info['document_approval_reference']
                const document_approval_date = doc_info['document_approval_date']
                const document_keyword = doc_info['document_keywords']


                Csv += document_name + sep + document_subject + sep + document_approval_reference +
                    sep + document_approval_date +
                    sep + document_keyword + "\n"

            }

            let save_file_name = "پنل تحلیل درگاه: "
            save_file_name += " مجموعه خبر {" + $('#country option:selected').text() + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }

    </script>


</body>



<!-- BS Tooltips handler -->
<script src="../../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<!-- Intro Js -->
<script src="../../../static/js/portal/portal_tour.js">
</script>
<script src="../../../static/js/tour.js"></script>
<!-- {#
<script src="../../static/js/UserLogSave.js"></script>#} -->
<script src="../../../static/js/signout_function.js"></script>


<script>

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    });


</script>


<!-- Blocking UI -->
<script src="../../../static/js/blockUI.js"></script>
<script src="../../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../../static/styles/loader.css">

</html>