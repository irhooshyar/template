<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../../static/library/fontawesome-5.10.0.all.css" />
    <link rel="stylesheet" href="../../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-radar.min.js"></script>

    <script src="../../../static/library/anychart-base.min-8.10.0.js"></script>
    <!-- <script src="../../static/library/anychart-8.10.0-exports.min.js"></script> -->
    <script src="../../../static/library/anychart-ui.min-8.10.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../static/library/anychart-ui.min-8.10.0.css">
    <link rel="stylesheet" type="text/css" href="../../../static/library/anychart-font.min-8.10.0.css">

    <script src="../../../static/library/anychart-8.10.0-tag-cloud.min.js"></script>
    <script src="../../../static/library/anychart-8.10.0-heatmap.min.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../../static/js/multiselect/jquery.multi-select.js"></script>


    <script src="./../static/js/graph/g6.min.js"></script>
    <script src="../../../static/library/jquery-ui.min-1.11.4.js"></script>

    <!-- Footable  -->
    <script src="../../../static/js/footable/demo-rows.js"></script>
    <script src="../../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../../static/js/footable/footable.js"></script>
    <link href="../../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">



    <link rel="stylesheet" type="text/css" href="../../../static/library/tom-select-2.2.1.css">
    <script src="../../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../../static/js/searchable-select.js"></script>

    <!-- Download Zip Files -->
    <script src="../../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../../static/library/tom-select-2.2.1.css">
    <script src="../../../static/library/tom-select.complete-2.2.1.min.js"></script>

    <link rel="stylesheet" href="../../../static/styles/index2.css">
    <link rel="stylesheet" href="../../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../../static/library/notyf.min-npm.css">
    <script src="../../../static/library/notyf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../../static/js/GraphClass.js"></script>

    <script src="../../../static/js/chart.js"></script>
    <meta charset="UTF-8">
    <title>خوشه‌بندی پاراگراف</title>
    {% include "doc/base_templates/title_icon.html" %}


    <script>
        $(document).ready(function () {

            // Active panel
            $('#AIDropdown').addClass('active');
            $('#paragraph_clustering').addClass('active');



            // chart controller


            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });


        });
    </script>

</head>

<body>
    {% load static %}

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/base_templates/header.html" %}
    </nav>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input مجموعه خبر-->
                <div class="col-md-6  pt-3 col-12 col-lg-2 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه خبر:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        {% if v == 'تابناک' %}
                        <option selected value="{{ k }}">{{ v }}</option>
                        {% elif v == 'خبر آنلاین' %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>


                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12 mt-1">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-2">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>


            </div>


            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">


                <!-- Clustering Algorithm -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">الگوریتم خوشه‌بندی:</label>
                    <select id="Clustering_Algorithm_Select"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                        <option value="K-Means">K-Means</option>
                        <option disabled value="Agglomerative">Agglomerative</option>

                        <!-- <option value="DB-SCAN">DB-SCAN</option> -->
                        <option disabled value="FCM">FCM</option>
                    </select>
                </div>


                <!-- Cluster Size  -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">
                    <label class="text-right bg-light float-right" style="direction: rtl;;">تعداد خوشه‌ها:</label>
                    <select id="Cluster_Count_Select" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>
                </div>

                <!-- Ngram Type  -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">
                    <label class="text-right bg-light float-right" style="direction: rtl;;">نوع ویژگی‌ها:</label>
                    <select id="Ngram_Type_Select" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">

                        <option value="(1, 1)">تک- واژه‌ای</option>
                        <option disabled value="(2, 2)">دو- واژه‌ای</option>
                        <option disabled value="(2-3)">دو تا سه واژه</option>
                        <option disabled value="(2-4)">دو تا چهار واژه</option>
                    </select>
                </div>

                <!-- DocumentVector -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">نوع بردار:</label>
                    <select id="Document_Vector_Select" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                        <option value="TF-IDF">TF-IDF</option>
                        <!-- <option>LDA</option> -->
                        <option disabled value="BERT">BERT</option>
                    </select>
                </div>

                <!-- ClusterName  -->
                <!-- <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light ActorSelect" id="multipleSelectDiv" style="direction: rtl;">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">موضوع:</label>
                    <select id="ClusterNameSelect" class="form-select text-right float-right">
                    </select>

                </div> -->

            </div>


        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">
                        نتایج خوشه‌بندی</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="centroids_result_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#centroids_result_pane" type="button" role="tab"
                        aria-controls="centroids_result_pane" aria-selected="false">تحلیل مراکز خوشه‌ها</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="vocabulary_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#vocabulary_pane"
                        type="button" role="tab" aria-controls="vocabulary_pane" aria-selected="false">واژگان
                        منتخب</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="discriminant_features_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#discriminant_features_pane" type="button" role="tab"
                        aria-controls="discriminant_features_pane" aria-selected="false">واژگان متمایزکننده</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="centroids_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#centroids_graph_pane" type="button" role="tab"
                        aria-controls="centroids_graph_pane" aria-selected="false">گراف مراکز خوشه‌ها</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="clustersKeywords_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#clustersKeywords_graph_pane" type="button" role="tab"
                        aria-controls="clustersKeywords_graph_pane" aria-selected="false">گراف خوشه کلیدواژه</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="result_evaluation_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#result_evaluation_pane" type="button" role="tab"
                        aria-controls="result_evaluation_pane" aria-selected="false">ارزیابی نتایج خوشه‌بندی</button>
                </li>

                <!-- Download Buttons -->
                <!-- <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود پاراگراف"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button> -->

                <!-- Result Count -->

                <!-- <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل جدول" onclick="ExportExcelSerachResultFunction()"
                type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button> -->

                <p country_id="{{k}}" id="SearchResultLable"
                    class="decision_tree_btn text-left float-left text-secondary pl-2">
                    تفسیرپذیری نتایج:

                    <a id="decision_tree_link" class="decision_tree_link  text-primary fw-bold" target="_blank"
                        style="text-decoration: none;" href="#">
                        درخت تصمیم
                    </a>
                    <span id="line_splitter">|</span>
                    <a id="dendrogram_link" class="dendrogram_link  text-primary fw-bold" target="_blank"
                        style="text-decoration: none;" href="#">
                        دندروگرام
                    </a>

                </p>



            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Table Headers -->
                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right">

                            <select id="ColumnSelect" onchange="show_table_result();"
                                class="form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">

                            </select>

                        </div>


                        <!-- Page select -->
                        <!-- <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled="true" onchange="TablePaginationChanged(event)"
                                id="TablePaginationInput" min="1" max="1" value="1"
                                class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p> -->

                    </div>
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>
                </div>


                <!-- Centroids Pane -->
                <div id="centroids_result_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="centroids_result_tab">

                    <div class="charts-list-container">
                        <div id="cluster_size_chart_container" class="full">
                        </div>
                    </div>
                    <!-- Members Count Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        فاصله مراکز خوشه‌ها
                    </h5>
                    <br>
                    <div id="heatmap_chart_container" style="height: 85vh" class="bg-white w-100 p-4 border border-2">
                    </div>

                </div>

                <!-- Discriminant-Features Pane -->
                <div id="discriminant_features_pane" class="tab-pane" role="tabpanel"
                    aria-labelledby="discriminant_features_tab">


                    <div class="charts-list-container">
                        <div id="anova_chart_container" class="half">
                        </div>

                        <div id="decision_tree_chart_container" class="half">
                        </div>

                    </div>

                </div>


                <!-- Result-evaluationp Pane -->
                <div id="result_evaluation_pane" class="tab-pane" role="tabpanel"
                    aria-labelledby="result_evaluation_tab">

                    <div class="charts-list-container">
                        <!-- Silhouette Pane -->
                        <div id="silhouette_chart_container" class="half">
                        </div>

                        <div class="chart-container half">
                            <h5 class="chart-title">
                                تعیین تعداد بهینه خوشه‌ها براساس نمودار Elbow
                            </h5>
                            <div id="elbow_inertia_chart_container" style="height: 450px">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ------------------------------- -->

                <!-- Centroids-Graph Pane -->
                <div id="centroids_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="centroids_graph_tab">

                    <!-- Graph Between Clusters -->
                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">

                        <div id="centroids_constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">
                            <div id="centroids_WeightDiv" class="col-md-12 p-1 col-12 col-lg-12 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="centroids_WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper" style="width: 100% !important;">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex">
                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">نحوه نمایش</label>
                                </div>
                                <div class="source_container p-4 row mx-auto">

                                    <select id="centroids_ChangeLayout" name="centroids_ChangeLayout"
                                        class="form-select text-right float-right searchable-select"
                                        style="direction: rtl;">

                                        <option value="grid">مربعی</option>
                                        <option value="circular"> دایره ای </option>
                                        <option value="force">ساده</option>
                                        <option value="dagre">بالا به پایین</option>
                                        <option value="radial">شعاعی</option>
                                        <option value="concentric">متحدالمرکز</option>
                                        <option value="comboForce">خوشه ای</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">جستجو در نام گره</label>
                                </div>
                                <div class="source_container p-4 d-flex">
                                    <input style="direction: rtl;" class="form-control text-right"
                                        placeholder="جستجو در نام گره ها ..." type="text" required=""
                                        name="centroids_SearchBox" id="centroids_SearchBox" value="">
                                    <button type="button" id="centroids_SearchBtn"
                                        class="btn modal_btn mr-2">جست‌وجو</button>
                                </div>
                            </div>


                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-1 d-flex">

                            </div>
                        </div>

                        <div dir="ltr">

                            <img style="width: 4%; cursor: pointer; margin-top: 20px;" id="centroids_SelectNeighbourImg"
                                src="../../../static/image/neighbourhood.png">
                            <img style="width: 3%; cursor: pointer; margin-top: 20px;" id="centroids_ShowHideImg"
                                src="../../../static/image/hide_nodes.png">

                        </div>

                        <div id="centroids_graph_container" class="border mt-1 position-static"
                            style="height:500px; overflow: hidden;">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="centroids_selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="centroids_selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>

                    </div>

                </div>


                <!-- Cluster-Keywords Pane -->
                <div id="clustersKeywords_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="clustersKeywords_graph_tab">

                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">

                        <div id="clustersKeywords_constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">

                            <div id="clustersKeywords_DegreeDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر درجه</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="clustersKeywords_DegreeSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="clustersKeywords_WeightDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="clustersKeywords_WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="d-flex">
                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">نحوه نمایش</label>
                                </div>
                                <div class="source_container p-4 row mx-auto">
                                    <select id="clustersKeywords_ChangeLayout" name="clustersKeywords_ChangeLayout"
                                        class="form-select text-right float-right searchable-select"
                                        style="direction: rtl;">
                                        <option value="grid">مربعی</option>
                                        <option value="circular"> دایره ای </option>
                                        <option value="force">ساده</option>
                                        <option value="dagre">بالا به پایین</option>
                                        <option value="radial">شعاعی</option>
                                        <option value="concentric">متحدالمرکز</option>
                                        <option value="comboForce">خوشه ای</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-3">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">جستجو در نام گره</label>
                                </div>
                                <div class="source_container p-4 d-flex">
                                    <input style="direction: rtl;" class="form-control text-right"
                                        placeholder="جستجو در نام گره ها ..." type="text" required=""
                                        name="clustersKeywords_SearchBox" id="clustersKeywords_SearchBox" value="">
                                    <button type="button" id="clustersKeywords_SearchBtn"
                                        class="btn modal_btn mr-2">جست‌وجو</button>
                                </div>
                            </div>


                            <div class="col-md-6 p-1 col-12 col-lg-6 mt-1 d-flex">

                            </div>
                        </div>

                        <div dir="ltr">
                            <img style="width: 4%; cursor: pointer; margin-top: 20px;"
                                id="clustersKeywords_SelectNeighbourImg" src="../../../static/image/neighbourhood.png">
                            <img style="width: 3%; cursor: pointer; margin-top: 20px;" id="clustersKeywords_ShowHideImg"
                                src="../../../static/image/hide_nodes.png">
                        </div>

                        <div id="clustersKeywords_graph_container" class="border mt-1 position-static"
                            style="height:500px; overflow: hidden;">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="clustersKeywords_selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="clustersKeywords_selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>

                    </div>

                </div>



                <!-- Search Result Pane -->
                <div id="vocabulary_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="vocabulary_tab">

                    <!-- Table Headers -->

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped VocabularyTable" style="min-height: 200px;"
                            id="VocabularyTable">
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    </div>



    <!-- Distributions Modal Container -->
    <div class="modal fade" id="distributionsModal">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="DistModalHeader" class="modal-title">تحلیل توزیعی</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="dist_chart_info" class="modal-body bg-light text-justify">
                    <div class="charts-list-container">
                        <div id="subject_container" class="half"></div>

                        <div id="year_container" class="half" ></div>


                        <div id="category_container" class="full" chart-height="750px"></div>

                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">


                </div>

            </div>
        </div>
    </div>



    <!-- Details Modal Container -->
    <button type="button" id="detailModal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#detailModal"></button>
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">ابر واژگان</h5>
                    <div id="topic_keywords_container" class="w-80 text-right" dir="rtl"></div>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <h6 id="DocsCount" class='text-secondary'></h6>

                    <div id="DetailText" class="bg-light text-justify mx-2 h-100">
                    </div>

                    <button id="LoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left" style="color: #0e3f8b"><i
                            class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش بیش‌تر</button>

                </div>
                <!-- Modal footer -->
                <div id="detail_modal_footer" dir="rtl" class="modal-footer">


                    <input type="number" id="ColumnModalPaginationInput" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none">


                    <button id="ExportExcel2" onclick="TopicParagraphs_Excel()"
                        class="btn green-button float-left"><i class="fa fa-file-excel"></i>
                        خروجی اکسل پاراگراف
                    </button>
                </div>

            </div>
        </div>
    </div>



    <!-- ANOVA Word Modal Container -->

    <div class="modal fade" id="anova_word_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="anova_word_ModalHeader" class="modal-title">ابر واژگان</h5>
                    <div id="anova_word_topic_keywords_container" class="w-80 text-right" dir="rtl"></div>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <h6 id="anova_word_DocsCount" class='text-secondary'></h6>

                    <div id="anova_word_DetailText" class="bg-light text-justify mx-2 h-100">
                    </div>

                    <button id="anova_word_LoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left"
                        style="color: #0e3f8b"><i class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش
                        بیش‌تر</button>

                </div>
                <!-- Modal footer -->
                <div id="detail_modal_footer" dir="rtl" class="modal-footer">


                    <input type="number" id="anova_word_ColumnModalPaginationInput" min="1" max="1" value="1"
                        class="form-select text-right float-right d-none">

                    <button id="anova_word_ExportExcel2" class="btn green-button float-left"><i
                            class="fa fa-file-excel"></i>
                        خروجی اکسل پاراگراف
                    </button>

                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../../static/js/logincheck.js"></script>

    <script src="../../../static/js/scroll_button_handler.js">
    </script>

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>


<!-- Blocking UI -->
<script src="../../../static/js/blockUI.js"></script>
<script src="../../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../../static/styles/loader.css">

<script src="../../../static/js/column.js"></script>
<script src="../../../static/js/ChartColumnInteractivity.js"></script>

<script>
    CLUSTERS_DATA = {}

    CURRENT_TOPIC_ID = 0;
    CLUSTERING_ALG_ID = 0;

    COUNTRY_CLUSTER_COUNT_DICT = {
        "ایسنا": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50],
        "تابناک": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50],
        "خبر آنلاین": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50],
    }

    TABLE_INFO = []
    const COLUMNS = {
        "anova": "واژگان متمایزکننده (ANOVA)",
        "cluster_entropy": 'آنتروپی',
        "distributions": "تحلیل توزیعی",
        "cluster_frequent_keyword_subject": 'موضوع غالب (براساس مدل‌های عمیق)',
        "cloud": 'ابر واژگان',
        "detail": "پاراگراف مرتبط"
    }

    MAX_RESULT_WINDOW = 5000
    SEARCH_RESULT_SIZE = 25

    CHART_FIELD_DICT = {
        "subject_container": "subject_name",
        "category_container": "category_name",
        "year_container": "document_year"
    }
    CHART_NAME_DICT = {
        "subject_container": "موضوع پاراگراف",
        "category_container": "دسته پاراگراف",
        "year_container": "سال  پاراگراف",
    }

    container_id_list = ['SearchTable',
        'heatmap_chart_container',
        'centroids_graph_container',
        'clustersKeywords_graph_container'
    ]

    async function TopicParagraphs_Excel(topic_id) {
        startFullPageBlockUI();


        const country_id = document.getElementById("country").value;
        const curr_page = parseInt(document.getElementById("ColumnModalPaginationInput").value);
        const username = getCookie("username");

        let request_link = 'http://' + location.host + "/Excel_Topic_Paragraphs_ES/" + country_id + "/"
            + topic_id + "/" + SEARCH_RESULT_SIZE + "/" + curr_page + "/" + username + "/";

        let response = await fetch(request_link).then(response => response.json());

        let file_name = response["file_name"]
        const path = 'http://' + location.host + '/media/' + file_name;
        var link = document.createElement("a");
        link.href = path
        link.click()
        stopFullPageBlockUI('دانلود پاراگراف خوشه');
    }

    function clearPrevResults(container_id_list) {
        for (let container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }



    async function init() {


        document.getElementById("document_search").disabled = true;

        const country_name = $("#country option:selected").text();

        country_cluster_count_list = COUNTRY_CLUSTER_COUNT_DICT[country_name]

        const options = []
        for (c of country_cluster_count_list) {
            options.push({ value: c, text: c })
        }
        syncSelectOptions("Cluster_Count_Select", options);


        document.getElementById("document_search").disabled = false;
        await CountryChanged()
        // await ShowResult();
        clearPrevResults(container_id_list);

        //user log
        let form_data = new FormData()
        detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)


    }

    initSearchableSelects();
    init()
    append_column(COLUMNS)

    async function CountryChanged() {

        const country_name = $("#country option:selected").text();
        country_cluster_count_list = COUNTRY_CLUSTER_COUNT_DICT[country_name]

        const options = []
        for (c of country_cluster_count_list) {
            options.push({ value: c, text: c })
        }
        syncSelectOptions("Cluster_Count_Select", options);

        if (country_name == 'فاوا') {
            $('#dendrogram_link').show();
            $('#line_splitter').show()
        } else {
            $('#dendrogram_link').hide();
            $('#line_splitter').hide();

        }

        clearPrevResults(container_id_list);
        // await ShowResult();
    }


    async function ShowResult() {



        clearPrevResults(container_id_list);
        startBlockUI('SearchTable');


        const country_id = document.getElementById("country").value;
        const country_name = $("#country option:selected").text();
        const algorithm_name = document.getElementById("Clustering_Algorithm_Select").value;
        const vector_type = document.getElementById("Document_Vector_Select").value;
        const cluster_count = document.getElementById("Cluster_Count_Select").value;
        const ngram_type = document.getElementById("Ngram_Type_Select").value;
        const username = getCookie("username");

        let request_link = 'http://' + location.host + "/GetParagraph_Clusters/" + country_id + "/"
            + algorithm_name + "/" + vector_type + "/" + cluster_count + "/" + ngram_type + "/" + username + "/";

        let response = await fetch(request_link).then(response => response.json());

        CLUSTERS_DATA = response["clusters_data"]

        CLUSTERING_ALG_ID = response["clustering_algorithm_id"]

        TABLE_INFO = response["table_data"]

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let search_algorithm_name = algorithm_name
        let search_cluster_count = cluster_count
        let search_ngram_type = ngram_type
        let search_vector_type = vector_type
        form_data.append('detail_type', detail_type);
        form_data.append('country_name', country_name);
        form_data.append('search_algorithm_name', search_algorithm_name);
        form_data.append('search_cluster_count', search_cluster_count);
        form_data.append('search_ngram_type', search_ngram_type);
        form_data.append('search_vector_type', search_vector_type);
        UserLog(form_data)


        await show_table_result()

        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },

            "filtering": {
                "enabled": true,
                "placeholder": "نام کلیدواژه ...",
                "filters": [{
                    "name": "my-filter",
                    "query": $('.form-control').val(),
                    "columns": ["word_list"]
                }]
            },

            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

        stopBlockUI('SearchTable', 'نتایج خوشه‌بندی');
        // --------------------- vacabulary -------------------------------------------
        startBlockUI('VocabularyTable');
        request_link = 'http://' + location.host + "/Get_Clustering_Vocabulary/" + country_id + "/"
            + vector_type + "/" + ngram_type + "/";

        response = await fetch(request_link).then(response => response.json());
        console.log(response)
        vocabulary_data = response["table_data"]

        let vacab_table_columns = [{
            "name": "index",
            "title": "ردیف",
            "breakpoints": "xs sm",
            "type": "number",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "term",
            "title": "واژه",
        }, {
            "name": "IDF",
            "title": "IDF",
        },]

        $('#VocabularyTable').empty();
        $('.VocabularyTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },

            "filtering": {
                "enabled": true,
                "placeholder": "نام کلیدواژه ...",
                "filters": [{
                    "name": "my-filter",
                    "query": $('.form-control').val(),
                    "columns": ["term"]
                }]
            },

            "sorting": {
                "enabled": true
            },
            "empty": "واژه‌ای یافت نشد.",
            "columns": vacab_table_columns,
            "rows": vocabulary_data
        });

        stopBlockUI('VocabularyTable', 'نتایج خوشه‌بندی');

        //------------- heatmap & cluster-size chart --------------------------------

        startBlockUI('heatmap_chart_container');
        startBlockUI('cluster_size_chart_container');

        request_link = 'http://' + location.host + "/Get_ClusterCenters_ChartData/" + country_id + "/"
            + algorithm_name + "/" + vector_type + "/" + cluster_count + "/" + ngram_type + "/";

        response = await fetch(request_link).then(response => response.json());


        heatmap_chart_data = response["heatmap_chart_data"]
        cluster_size_chart_data = response["cluster_size_chart_data"]

        if (cluster_size_chart_data.length != 0)
            await showChart(cluster_size_chart_data, "cluster_size_chart_container", false, "خوشه", "تعداد پاراگراف", "توزیع خوشه‌ها در پاراگراف")

        if (heatmap_chart_data.length != 0)
            await show_heatmap_charts('heatmap_chart_container', heatmap_chart_data);

        stopBlockUI('heatmap_chart_container', 'فاصله مراکز خوشه‌ها');
        stopBlockUI('cluster_size_chart_container', 'توزیع اندازه خوشه‌ها');

        //------------- ANOVA & DecisionTree chart --------------------------------

        startBlockUI('discriminant_features_pane');

        request_link = 'http://' + location.host + "/Get_ClusteringAlgorithm_DiscriminatWords_ChartData/" + country_id + "/"
            + algorithm_name + "/" + vector_type + "/" + cluster_count + "/" + ngram_type + "/";

        response = await fetch(request_link).then(response => response.json());

        anova_chart_data = response["anova_chart_data"]
        decision_tree_chart_data = response["decision_tree_chart_data"]

        if (anova_chart_data.length != 0)
            await showChart(anova_chart_data, "anova_chart_container", false, "واژه", "درصد امتیاز", "واژگان متمایزکننده براساس الگوریتم ANOVA")

        if (decision_tree_chart_data.length != 0)
            await showChart(decision_tree_chart_data, "decision_tree_chart_container", false, "واژه", "درصد امتیاز", " واژگان متمایزکننده براساس الگوریتم درخت تصمیم (ضریب Gini)")

        stopBlockUI('discriminant_features_pane', 'واژگان متمایزکننده');
        //------------- Silhouette chart --------------------------------

        request_link = 'http://' + location.host + "/Get_ClusteringEvaluation_Silhouette_ChartData/" + country_id + "/"
            + algorithm_name + "/" + vector_type + "/" + ngram_type + "/";


        response = await fetch(request_link).then(response => response.json());

        silhouette_score_chart_data = response["silhouette_score_chart_data"]
        elbow_inertia_chart_data = response["elbow_inertia_chart_data"]

        showChart(silhouette_score_chart_data, "silhouette_chart_container", true, "تعداد خوشه‌ها", "silhouette score", " تعیین تعداد بهینه خوشه‌ها براساس معیار silhouette")
        showLineChart(elbow_inertia_chart_data, "elbow_inertia_chart_container", true, "تعداد خوشه‌ها", "inertia")

        //------------- Show Graph Between Centroid --------------------------------
        startBlockUI('centroids_graph_pane');

        await showCentroidGraph("centroids_graph_container")

        stopBlockUI('centroids_graph_pane', 'گراف مراکز خوشه‌ها');

        startBlockUI('clustersKeywords_graph_pane');

        await showClusterKeywordGraph("clustersKeywords_graph_container")

        stopBlockUI('clustersKeywords_graph_pane', 'گراف خوشه کلیدواژه');

    }

    $('#decision_tree_link').on('click', function (e) {
        e.preventDefault();
        const country_id = document.getElementById("country").value;

        decision_tree_url = 'http://' + location.host + "/decision_tree/" + country_id + "/" + CLUSTERING_ALG_ID + "/"
        window.open(decision_tree_url, '_blank')
    })

    $('#dendrogram_link').on('click', function (e) {
        e.preventDefault();
        const country_id = document.getElementById("country").value;
        const ngram_type = document.getElementById("Ngram_Type_Select").value;

        decision_tree_url = 'http://' + location.host + "/dendrogram/" + country_id + "/" + ngram_type + "/"
        window.open(decision_tree_url, '_blank')
    })


    function showChart(data, position, sortKeys, xAxisTitle, yAxisTitle, title) {
        const options = {
            data,
            sortKeys,
            xAxisTitle,
            title,
            yAxisTitle,
            onClick: async function (event, data) {
                if (position == 'DetailText') {

                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let topic_id = CURRENT_TOPIC_ID;
                    let country_id = document.getElementById('country').value
                    let word = data.row(index)[0];

                    await Get_ANOVA_Word_Paragraphs(country_id, topic_id, word)

                    $("#anova_word_modal").modal("show");

                }
            }


        };
        newBarChart(position, options)

    }


    async function Get_ANOVA_Word_Paragraphs(country_id, topic_id, word) {

        startFullPageBlockUI();

        // clear prev results
        $('#anova_word_DetailText').removeClass('h-100');
        document.getElementById("anova_word_DetailText").innerHTML = ""
        document.getElementById("anova_word_topic_keywords_container").innerHTML = ""
        document.getElementById("anova_word_ModalHeader").innerHTML = ""


        // set modal header
        topic_name = CLUSTERS_DATA[topic_id]['name']
        modal_header = 'واژه ' + '<span class="text-primary">' + word + '</span>' + ' در خوشه ' + topic_name + ':'
        document.getElementById("anova_word_ModalHeader").innerHTML = modal_header


        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/Get_ANOVA_Word_Paragraphs_Column_ES/" +
            country_id + "/" + topic_id + "/" + word + "/";

        request_configs = {
            "link": request_link,
            "search_result_size": SEARCH_RESULT_SIZE,
            "data_type": "url_parameters",
            "form_data": null,
            "max_result_window": MAX_RESULT_WINDOW
        }

        highlight_parameters = { "selected_word": word }

        highlight_configs = {
            "parameters": highlight_parameters,
            "highlight_enabled": true,
            "custom_function": anova_word_highlight_paragraphs
        }

        modal_configs = {
            "body_id": "anova_word_DetailText",
            "modal_load_more_btn_id": "anova_word_LoadMoreDocuments",
            "result_size_container_id": "anova_word_DocsCount",
            "result_size_message": "پاراگراف",
            "list_type": "ordered",
            "custom_body_function": null,
            "body_parameters": null

        }

        const username = getCookie("username");

        export_link = 'http://' + location.host + "/Export_ANOVA_Word_Paragraphs_Column_ES/" +
            country_id + "/" + topic_id + "/" + word + "/" + username + "/";

        export_configs = {
            "link": export_link,
            "btn_id": "anova_word_ExportExcel2"
        }
        segmentation_config = {
            "parameters": null,
            "keyword": null,
            "enable": false,
            "aggregation_keyword": null
        }
        column_interactivity_obj = new ColumnInteractivity("paragraphs",
            request_configs, export_configs, modal_configs, highlight_configs, segmentation_config)

        column_interactivity_obj.load_content();

        stopFullPageBlockUI('کلیک روی نمودار');

        $('#anova_word_ExportExcel2').on('click', async function () {
            await column_interactivity_obj.download_content();
        })


    }


    function showLineChart(data, position, keySort, xAxisTitle, yAxisTitle) {


        if (keySort === true) {
            data.sort(function (element_a, element_b) {
                return element_a[0] - element_b[0];
            });
        }
        else {
            data.sort(function (element_a, element_b) {
                return element_a[1] - element_b[1];
            });
        }

        data.sort(function (x, y) { return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });

        if (data[0][0] == 0) {
            data[0][0] = 'نامشخص'
        }
        // Sorts the data by descending.
        data = anychart.data.set(data)

        document.getElementById(position).innerHTML = ""

        chart = anychart.line();

        chart.container(position);
        // create a column series and set the data
        var series = chart.line(data);
        chart
            .animation(true)
            .padding([10, 40, 5, 20])


        // var state = series.normal();
        // state.fill('#1481c0')

        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");
        // xAxisLabels.rotation(315);

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        let xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");
        xAxis.title(xAxisTitle);
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");
        xAxis.title().height(40);

        var yAxis = chart.yAxis();
        yAxis.title(yAxisTitle);
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        yAxis.title().height(40);


        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        chart.tooltip().hAlign('center').format("{%value}");

        chart.xAxis().labels().height(60);

        chart.yAxis().labels().format("{%value}");

        // chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);

        //xAxisLabels.rotation(-90)
        // initiate drawing the chart
        chart.draw();

        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

    }


    async function show_heatmap_charts(container, data) {
        document.getElementById(container).innerHTML = ""

        // create a chart and set the data
        chart = anychart.heatMap(data);

        // set the container id
        chart.container(container);


        // set the chart title
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // initiate drawing the chart
        chart.draw();
    }

    async function show_table_result() {
        selected_columns = ["id", "user_label", "cluster_name", "word_list", "cluster_size"]
        selected_columns = find_selected_column(selected_columns)


        columns = [{
            "name": "id",
            "title": "ردیف",
            "breakpoints": "xs sm",
            "type": "number",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cluster_name",
            "title": "نام خوشه",
        }, {
            "name": "word_list",
            "title": "موضوع (20 کلمه کلیدی)",
        }, {
            "name": "cluster_size",
            "title": "تعداد پاراگراف",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cloud",
            "title": "ابر واژگان",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "detail",
            "title": "پاراگراف مرتبط",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "anova",
            "title": "واژگان متمایزکننده (ANOVA)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "cluster_entropy",
            "title": "آنتروپی",
            "style": {
                "width": "5%"
            }
        }, {
            "name": "cluster_frequent_keyword_subject",
            "title": "موضوع غالب (براساس مدل‌های عمیق)",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "distributions",
            "title": "تحلیل توزیعی",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "user_label",
            "title": "برچسب پیشنهادی",
            "style": {
                "width": "10%"
            }
        },]

        if (!selected_columns.includes("all")) {
            for (let column of columns) {
                if (selected_columns.includes(column["name"])) {
                    column["visible"] = true
                } else {
                    column["visible"] = false
                }
            }
        }


        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '«',
                    prev: '‹',
                    next: '›',
                    last: '»'
                }
            },

            "filtering": {
                "enabled": true,
                "placeholder": "نام کلیدواژه ...",
                "filters": [{
                    "name": "my-filter",
                    "query": $('.form-control').val(),
                    "columns": ["word_list"]
                }]
            },

            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

    }

    function get_highlight_templates(keyword, keyword_tag) {
        highlight_templates = [
            // [keyword + ' ', keyword_tag + ' ']
            // , [' ' + keyword, ' ' + keyword_tag]
            [' ' + keyword + ' ', ' ' + keyword_tag + ' ']
            // , [keyword + '‌', keyword_tag + '‌']

            // , ['‌' + keyword, '‌' + keyword_tag]

            // , ['‌' + keyword + '‌', '‌' + keyword + '‌']


        ]
        return highlight_templates;
    }


    async function DetailFunction(country_id, topic_id) {

        RESULT_DOCUMENTS = []

        // clear prev results
        $('#DetailText').removeClass('h-100');
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""
        document.getElementById("ModalHeader").innerHTML = ""
        $("#detail_modal_footer #close_btn").hide();
        $("#detail_modal_footer #ExportExcel2").show();

        $('#ExportExcel2').attr("onclick", "TopicParagraphs_Excel('" + topic_id + "')")


        modal_header = "پاراگراف خوشه شماره:  " + CLUSTERS_DATA[topic_id]["name"].replaceAll('C', '')
        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' - ').slice(0, 20)

        const ngram_type = document.getElementById("Ngram_Type_Select").value;

        i = 0
        for (keyword of keyword_list) {
            i += 1

            let tag = ''

            if (ngram_type == '(2, 2)') {
                tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input disabled class="form-check-input topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            } else {
                tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input class="form-check-input topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            }
            document.getElementById("topic_keywords_container").innerHTML += tag;
        }

        document.getElementById("ModalHeader").innerHTML = modal_header

        await loadParagraphs(country_id, topic_id, 1);

        $("#detailModal").modal("show")

    }


    async function save_user_label(topic_id) {
        username = getCookie("username");
        label = $("#" + topic_id).val();

        if (label != "" && label != "بدون برچسب") {
            let request_link = 'http://' + location.host + "/save_topic_label/" +
                topic_id + "/" + username + "/" + label + "/"

            let response = await fetch(request_link).then(response => response.json());
            result_response = response["result_response"];
            notyf.success(result_response);

        } else {
            notyf.error("!برچسبی وارد نشده‌است");
        }

    }


    async function show_modal_paragraphs(country_id, topic_id, modal_header, paragraph_list, curr_page, max_page) {


        body_tag = ""
        index = (curr_page - 1) * SEARCH_RESULT_SIZE + 1;

        for (para of paragraph_list) {

            document_id = para['_source']['document_id']
            document_name = para['_source']['document_name']
            paragraph_id = para['_source']['paragraph_id']

            paragraph = ""
            try {
                paragraph = para["highlight"]["attachment.content"][0]

            }
            catch {
                paragraph = para["_source"]["attachment"]["content"]

            }

            const doc_link = 'http://' + location.host + "/information/?id=" + document_id
            let doc_tag = "<a title = 'پروفایل خبر' class='bold text-secondary' target='blank' href='" + doc_link + "'>" + document_name + "</a>"


            j = 0
            for (keyword of keyword_list) {
                j += 1
                keyword = keyword.trim()

                keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'


                paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + keyword + '</em>', keyword_tag)


            }



            paragraph_link = 'http://' + location.host + "/sentiment_analysis/?id=" + paragraph_id;

            paragraph_tag = "<a class='' title = 'پروفایل پاراگراف' target='blank' href='" + paragraph_link + "'>" + paragraph + "</a>"

            // profile_tag = paragraph

            tag = "<li class='mb-3 lh-lg'>" + doc_tag + paragraph_tag + "</li>"
            body_tag += tag
            // document.getElementById("DetailText").innerHTML += "<ol start='" + index + "'>" + tag + "</ol>"


        }

        document.getElementById("DetailText").innerHTML += "<ol start='" + index + "'>" + body_tag + "</ol>"


        $('.topic_keyword').change(function () {

            if (this.checked) {
                $('.h_' + this.id).addClass('text-primary fw-bold')

            } else {
                $('.h_' + this.id).removeClass('text-primary fw-bold')

            }
        })




        if (curr_page >= max_page) {
            $("#LoadMoreDocuments").hide();
        } else {
            $("#LoadMoreDocuments").show();
        }

        /* LoadMoreDocuments */
        document.getElementById("LoadMoreDocuments").onclick = function () {

            next_page_number = ColumnModalNextPage(curr_page);
            loadParagraphs(country_id, topic_id, next_page_number);

        };
    }


    function ColumnModalNextPage(curr_page) {


        next_page_number = curr_page;
        max_page_number = parseInt(document.getElementById("ColumnModalPaginationInput").max);

        if (next_page_number < max_page_number) {
            next_page_number = curr_page + 1
        }

        document.getElementById("ColumnModalPaginationInput").value = next_page_number

        return next_page_number;

    }


    async function update_column_pagination_input(curr_page, total_hits) {

        page_count = 0;

        if (total_hits < SEARCH_RESULT_SIZE) {
            page_count = 1

        } else if (total_hits < MAX_RESULT_WINDOW) {
            page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

        } else if (total_hits >= MAX_RESULT_WINDOW) {
            page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
        }

        document.getElementById("ColumnModalPaginationInput").min = 1;
        document.getElementById("ColumnModalPaginationInput").max = page_count;
        document.getElementById("ColumnModalPaginationInput").value = curr_page;

    }


    async function loadParagraphs(country_id, topic_id, curr_page) {

        startFullPageBlockUI();


        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_ES/" + country_id + "/"
            + topic_id + "/" + SEARCH_RESULT_SIZE + "/" + curr_page + "/" + 1 + "/" + 0 + "/";

        let response = await fetch(request_link).then(response => response.json());
        topic_paragraphs = response["topic_paragraphs"]

        total_hits = response["total_hits"]
        curr_page = response["curr_page"]
        ES_SearchResult = response["result"]
        console.log(ES_SearchResult)

        await update_column_pagination_input(curr_page, total_hits);

        max_page = parseInt(document.getElementById("ColumnModalPaginationInput").max)
        document.getElementById("DocsCount").innerText = total_hits + " پاراگراف:"


        show_modal_paragraphs(country_id, topic_id, modal_header, ES_SearchResult, curr_page, max_page)
        stopFullPageBlockUI('پاراگراف مرتبط')
    }


    async function DistributionsFunction(country_id, topic_id) {


        cluster_name = CLUSTERS_DATA[topic_id]['name'];
        entropy = CLUSTERS_DATA[topic_id]['entropy'];
        cluster_size = CLUSTERS_DATA[topic_id]['cluster_size'];


        document.getElementById("DistModalHeader").innerHTML = "تحلیل توزیعی پاراگراف خوشه " + cluster_name


        startFullPageBlockUI()

        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_ES/" + country_id + "/"
            + topic_id + "/" + SEARCH_RESULT_SIZE + "/" + 1 + "/" + 0 + "/" + 1 + "/";;

        let response = await fetch(request_link).then(response => response.json());
        topic_paragraphs = response["topic_paragraphs"]

        total_hits = response["total_hits"]
        curr_page = response["curr_page"]
        ES_Aggregations = response["aggregations"]

        await GetChartData_Es(country_id, topic_id, ES_Aggregations, [], entropy, cluster_size);


        stopFullPageBlockUI('تحلیل توزیعی');

    }


    async function GetChartData_Es(country_id, topic_id, ES_Aggregations, documents_information_result, entropy, cluster_size) {

        let request_link = '';

        subject_data = ES_Aggregations['subject-agg']['buckets']
        document_year_data = ES_Aggregations['document-year-agg']['buckets']
        category_data = ES_Aggregations['category-agg']['buckets']

        doc_ids = []


        for (doc of documents_information_result) {
            doc_ids.push(doc['_id'])
        }


        /* Show Chart  */


        showChartData(country_id, topic_id, subject_data, "subject_container", documents_information_result, false, "موضوع پاراگراف", entropy, cluster_size, 'توزیع موضوعی پاراگراف' + '\n' + "آنتروپی: " + entropy + "\n" + "تعداد پاراگراف: " + cluster_size)
        showChartData(country_id, topic_id, document_year_data, "year_container", documents_information_result, true, "سال خبر", entropy, cluster_size, "توزیع پاراگراف براساس سال اخبار")
        showChartData(country_id, topic_id, category_data, "category_container", documents_information_result, false, "دسته خبر", entropy, cluster_size, "توزیع پاراگراف براساس دسته اخبار")
    }

    function showStackedChart(country_id, topic_id, data, container, xAxisTitle, title) {
        let dataDict = {}
        for (let column of data) {
            const key = column["key"]

            let year = ''
            if (key[0] == '0') {
                year = 'نامشخص';
            } else {
                year = key[0];
            }
            const d = key[1];

            if (!dataDict[d]) {
                dataDict[d] = [];
            }
            dataDict[d].push({ x: String(year), value: column["doc_count"] });
        }

        const options = {
            title,
            xAxisTitle,
            data: dataDict,
            sortKeys: true,
            yAxisTitle: "تعداد پاراگراف",
            onClick:
                async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]

                    let field_value = data.row(index)[0];
                    let field_name = CHART_FIELD_DICT[container] + ".keyword"
                    let chart_name = CHART_NAME_DICT[container]

                    if (container == "year_container") {

                        field_name = field_name.replaceAll(".keyword", "");
                        if (field_value == "نامشخص")
                            field_value = 0
                    }

                    await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                    $("#detailModal").modal("show")
                    $("#detail_modal_footer #close_btn").show();
                    $("#detail_modal_footer #ExportExcel2").hide();
                }
        };

        newStackedColumnChart(container, options)
    }

    function showHistogramChart(country_id, topic_id, data, container, documents_information_result, sortKeys, xAxisTitle, title) {
        // dict { 'approval_reference': [{ x: count, y: 1 }]
        const references = {};
        data.forEach(ref => {
            references[ref.key] = [{ x: String(ref.doc_count), y: 1 }]
        });
        const options = {
            data: references,
            sortKeys,
            xAxisTitle,
            title,
            showLabels: true,
            yAxisTitle: "تعداد پاراگراف",
            onClick: async function (event, data) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]

                let field_value = data.row(index)[0];
                let field_name = CHART_FIELD_DICT[container] + ".keyword"
                let chart_name = CHART_NAME_DICT[container]

                if (container == "year_container") {

                    field_name = field_name.replaceAll(".keyword", "");
                    if (field_value == "نامشخص")
                        field_value = 0
                }

                await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                $("#detailModal").modal("show")
                $("#detail_modal_footer #close_btn").show();
                $("#detail_modal_footer #ExportExcel2").hide();
            }
        };

        newStackedColumnChart(container, options)
    }

    function showChartData(country_id, topic_id, data, container, documents_information_result, keySort, xAxisTitle, entropy, cluster_size, title) {
        let chart_data = []
        for (column of data) {

            key = column["key"]
            // key = column["key"] != 0 ? column["key"] : 'نامشخص'
            value = column["doc_count"]

            chart_data.push([key, value])
        }
        showBaseChart(country_id, topic_id, chart_data, container, documents_information_result, keySort, xAxisTitle, entropy, cluster_size, title)
    }

    function showBaseChart(country_id, topic_id, data, container, documents_information_result, sortKeys, xAxisTitle, entropy, cluster_size, title) {
        const options = {
            data,
            title,
            sortKeys,
            xAxisTitle,
            yAxisTitle: 'تعداد پاراگراف',
            onClick: async function (event, data) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                let field_value = ""
                if (container == "subject_container") {
                    field_value = data[index][0];
                }
                else {
                    field_value = data.row(index)[0];

                }
                let field_name = CHART_FIELD_DICT[container] + ".keyword"
                let chart_name = CHART_NAME_DICT[container]

                if (container == "year_container") {

                    field_name = field_name.replaceAll(".keyword", "");
                    if (field_value == "نامشخص")
                        field_value = 0
                }



                await GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value)

                $("#detailModal").modal("show")
                $("#detail_modal_footer #close_btn").show();
                $("#detail_modal_footer #ExportExcel2").hide();
            }
        };

        if (container === 'subject_container') {
            newDoughnutChart(container, options);
        } else {
            newBarChart(container, options);
        }

    }

    function paragraph_highlight_function(paragraph, topic_id) {

        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' - ').slice(0, 20)

        j = 0
        for (keyword of keyword_list) {
            j += 1
            keyword = keyword.trim()

            keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'


            paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + keyword + '</em>', keyword_tag)


        }
        return paragraph;
    }


    async function GetClickedColumnParagraphs(country_id, topic_id, chart_name, field_name, field_value) {
        startFullPageBlockUI();

        // clear prev results
        $('#DetailText').removeClass('h-100');
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""
        document.getElementById("ModalHeader").innerHTML = ""


        // set modal header
        modal_header = chart_name + ": " + (field_value != 0 ? field_value : "نامشخص")
        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' - ').slice(0, 20)
        document.getElementById("ModalHeader").innerHTML = modal_header


        i = 0
        for (keyword of keyword_list) {
            i += 1
            let tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input class="form-check-input  topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            document.getElementById("topic_keywords_container").innerHTML += tag;
        }



        $('.topic_keyword').change(function () {

            if (this.checked) {
                $('.h_' + this.id).addClass('text-primary fw-bold')

            } else {
                $('.h_' + this.id).removeClass('text-primary fw-bold')

            }
        })


        // define request link without curr_page & search_result_size
        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs_Column_ES/" + country_id
            + "/" + topic_id + "/" + field_name + "/" + field_value + "/"

        request_configs = {
            "link": request_link,
            "search_result_size": SEARCH_RESULT_SIZE,
            "max_result_window": MAX_RESULT_WINDOW,
            "data_type": "url_parameters",
            "form_data": null
        }

        highlight_parameters = { "keyword_list": keyword_list }

        highlight_configs = {
            "parameters": highlight_parameters,
            "highlight_enabled": true,
            "custom_function": highlight_paragraphs
        }

        modal_configs = {
            "body_id": "DetailText",
            "modal_load_more_btn_id": "LoadMoreDocuments",
            "result_size_container_id": "DocsCount",
            "result_size_message": "پاراگراف",
            "list_type": "ordered",
            "custom_body_function": null,
            "body_parameters": null

        }

        export_configs = {
            "link": null,
            "btn_id": null
        }
        segmentation_config = {
            "parameters": null,
            "keyword": null,
            "enable": false,
            "aggregation_keyword": null
        }
        column_interactivity_obj = new ColumnInteractivity("paragraphs",
            request_configs, export_configs, modal_configs, highlight_configs, segmentation_config)

        column_interactivity_obj.load_content();

        stopFullPageBlockUI('کلیک روی نمودار');
    }


    function highlight_paragraphs(paragraph, highlight_parameters) {
        keyword_list = highlight_parameters["keyword_list"]

        j = 0
        for (keyword of keyword_list) {
            j += 1
            keyword = keyword.trim()

            keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'


            paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + keyword + '</em>', keyword_tag)


        }

        return paragraph;
    }


    function anova_word_highlight_paragraphs(paragraph, highlight_parameters) {

        selected_word = highlight_parameters["selected_word"]


        selected_word = selected_word.trim()

        selected_word_tag = '<span class="text-primary fw-bold">' + selected_word + '</span>'


        paragraph = paragraph.replaceAll("<em class='text-primary fw-bold'>" + selected_word + '</em>', selected_word_tag)


        return paragraph;

    }

    async function ANOVAFunction(country_id, cluster_id) {
        startFullPageBlockUI()

        cluster_name = CLUSTERS_DATA[cluster_id]['name'];

        CURRENT_TOPIC_ID = cluster_id;

        $("#LoadMoreDocuments").hide();
        $('#DetailText').addClass('h-100');
        document.getElementById("ModalHeader").innerHTML = "واژگان متمایزکننده خوشه " + cluster_name + " از سایر خوشه‌ها " + "(براساس الگوریتم ANOVA)"
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("DocsCount").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""
        $("#detail_modal_footer #close_btn").show();
        $("#detail_modal_footer #ExportExcel2").hide();

        let request_link = 'http://' + location.host + "/Get_Topic_Anova_ChartData/" + country_id + "/"
            + cluster_id + "/";

        let response = await fetch(request_link).then(response => response.json());
        discriminant_words_chart_data = response["discriminant_words_chart_data"]




        showChart(discriminant_words_chart_data, "DetailText", false, "واژه", "درصد امتیاز", "نمودار واژگان متمایزکننده")
        stopFullPageBlockUI('واژگان متمایزکننده');

    }

    async function CloudFunction(country_id, cluster_id) {
        $("#LoadMoreDocuments").hide();
        $('#DetailText').addClass('h-100');

        document.getElementById("ModalHeader").innerHTML = "ابر واژگان"
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("DocsCount").innerHTML = ""

        document.getElementById("topic_keywords_container").innerHTML = ""

        $("#detail_modal_footer #close_btn").show();
        $("#detail_modal_footer #ExportExcel2").hide();

        startFullPageBlockUI()

        cluster_name = CLUSTERS_DATA[cluster_id]['name'];

        let request_link = 'http://' + location.host + "/Get_Topic_TagCloud_ChartData/" + country_id + "/"
            + cluster_id + "/";

        let response = await fetch(request_link).then(response => response.json());
        tag_cloud_chart_data = response["tag_cloud_chart_data"]


        await show_TagCloud_chart(tag_cloud_chart_data, cluster_name, "DetailText")
        stopFullPageBlockUI('ابر واژگان');


    }

    async function show_TagCloud_chart(tag_cloud_data, cluster_name, container) {
        // create a chart and set the data

        document.getElementById(container).innerHTML = ""

        var chart = anychart.tagCloud(tag_cloud_data);
        chart.fontFamily('vazir');

        // set the chart title
        chart.title("خوشه :شماره " + cluster_name.replaceAll('C', ''));
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // configure angles
        chart.angles([0]);
        chart.textSpacing(10);
        // set the container id
        chart.container(container);
        // chart.tooltip().format("{امتیاز: %yPercentOfTotal}% \n({%value})");
        chart.tooltip().format("امتیاز: {%yPercentOfTotal}%");

        // initiate drawing the chart
        chart.draw();
    }

    function popup_handler() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    }

    async function showCentroidGraph(container) {
        $('#selected_node_table').empty();
        $('#selected_edge_table').empty();

        const country_id = document.getElementById("country").value;
        const algorithm_name = document.getElementById("Clustering_Algorithm_Select").value;
        const vector_type = document.getElementById("Document_Vector_Select").value;
        const cluster_size = document.getElementById("Cluster_Count_Select").value;
        const ngram_type = document.getElementById("Ngram_Type_Select").value;

        let request_link = 'http://' + location.host + "/GetClusteringGraphData/" + country_id + "/" + algorithm_name + "/" + vector_type + "/" + cluster_size + "/" + ngram_type + "/";
        let response = await fetch(request_link).then(response => response.json());

        const Nodes_data = response["Nodes_data"]
        const Edges_data = response["Edges_data"]

        container = document.getElementById(container);
        const width = 0.88 * window.innerWidth
        const height = container.scrollHeight || 500;

        let Graph_Object = new MyGraph("centroids_graph_container", Nodes_data, Edges_data, {}, {}, width, height, "circular", "centroids_ChangeLayout", false,
            "Yellow", "", "centroids_WeightSlider", 1, 0.001, "centroids_selected_node_table", "centroids_selected_edge_table",
            "centroids_SelectNeighbourImg", "centroids_ShowHideImg", "شباهت", centroids_node_dbl_click, "",
            "centroids_SearchBox", "centroids_SearchBtn")

        await Graph_Object.show()

        console.log("Graph_Show")
    }



    async function centroids_node_dbl_click(node_date) {

        const country_id = document.getElementById("country").value;
        await DetailFunction(country_id, node_date["id"])
        $("#detailModal").modal("show")
    }
    function centroids_edge_dbl_click(edge_date) {
        console.log(edge_date)
    }

    async function showClusterKeywordGraph(container) {
        $('#selected_node_table').empty();
        $('#selected_edge_table').empty();

        const country_id = document.getElementById("country").value;
        const algorithm_name = document.getElementById("Clustering_Algorithm_Select").value;
        const vector_type = document.getElementById("Document_Vector_Select").value;
        const cluster_size = document.getElementById("Cluster_Count_Select").value;
        const ngram_type = document.getElementById("Ngram_Type_Select").value;

        let request_link = 'http://' + location.host + "/GetClusterKeywordGraphData/" + country_id + "/" + algorithm_name + "/" + vector_type + "/" + cluster_size + "/" + ngram_type + "/";
        let response = await fetch(request_link).then(response => response.json());

        const Nodes_data = response["Nodes_data"]
        const Edges_data = response["Edges_data"]

        container = document.getElementById(container);
        const width = 0.88 * window.innerWidth
        const height = container.scrollHeight || 500;

        let Graph_Object = new MyGraph("clustersKeywords_graph_container", Nodes_data, Edges_data, {}, {}, width, height, "circular", "clustersKeywords_ChangeLayout", false,
            "Yellow", "clustersKeywords_DegreeSlider", "clustersKeywords_WeightSlider", 1, 0.001, "clustersKeywords_selected_node_table", "clustersKeywords_selected_edge_table",
            "clustersKeywords_SelectNeighbourImg", "clustersKeywords_ShowHideImg", "امتیاز", clustersKeywords_node_dbl_click, clustersKeywords_edge_dbl_click,
            "clustersKeywords_SearchBox", "clustersKeywords_SearchBtn")

        await Graph_Object.show()

        console.log("Graph2_Show")
    }

    async function clustersKeywords_node_dbl_click(node_date) {
        if (node_date["node_type"] === "cluster") {
            const country_id = document.getElementById("country").value;
            await DetailFunction(country_id, node_date["id"])
            $("#detailModal").modal("show")
        }
        else {
            const country_id = document.getElementById("country").value;
            const algorithm_name = document.getElementById("Clustering_Algorithm_Select").value;
            const vector_type = document.getElementById("Document_Vector_Select").value;
            const cluster_size = document.getElementById("Cluster_Count_Select").value;
            $("#LoadMoreDocuments").hide();
            $('#DetailText').addClass('h-100');
            $("#detail_modal_footer #close_btn").show();
            $("#detail_modal_footer #ExportExcel2").hide();

            let request_link = 'http://' + location.host + "/GetKeywordClustersData/" + country_id + "/" + algorithm_name + "/" + vector_type + "/" + cluster_size + "/" + node_date["id"] + "/";
            let response = await fetch(request_link).then(response => response.json());

            TABLE_INFO = response["table_data"]

            document.getElementById("DocsCount").innerHTML = ""
            document.getElementById("topic_keywords_container").innerHTML = ""
            document.getElementById("ModalHeader").innerHTML = "کلیدواژه: " + node_date["id"]
            document.getElementById("DetailText").innerHTML = '<table class="table table-striped" style="min-height: 200px;" id="KeywordSearchTable"></table>'
            let columns = [
                {
                    "name": "index",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "cluster_name",
                    "title": "نام خوشه",
                }, {
                    "name": "word_list",
                    "title": "موضوع (20 کلمه کلیدی)",
                }, {
                    "name": "cluster_size",
                    "title": "تعداد پاراگراف",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "cluster_entropy",
                    "title": "آنتروپی",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "cluster_frequent_keyword_subject",
                    "title": "موضوع غالب (براساس مدل‌های عمیق)",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "user_label",
                    "title": "برچسب پیشنهادی",
                },]

            $('#KeywordSearchTable').empty();
            $('#KeywordSearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        last: '»',
                        next: '›',
                        prev: '‹',
                        first: '«'
                    }
                },

                "filtering": {
                    "enabled": true,
                    "placeholder": "نام کلیدواژه ...",
                    "filters": [{
                        "name": "my-filter",
                        "query": $('.form-control').val(),
                        "columns": ["word_list"]
                    }]
                },

                "sorting": {
                    "enabled": true
                },
                "empty": "موضوعی یافت نشد.",
                "columns": columns,
                "rows": TABLE_INFO
            });

            $("#detailModal").modal("show")
        }
    }
    async function clustersKeywords_edge_dbl_click(edge_date) {
        const country_id = document.getElementById("country").value;
        await CloudFunction(country_id, edge_date["source"])
        $("#detailModal").modal("show")
    }

</script>



<script src="../../../static/js/tooltip_handler.js"></script>

<!-- {#
<script src="../../static/js/UserLogSave.js"></script>#} -->
<script src="../../../static/js/signout_function.js"></script>
<script src="../../../static/js/actors/actors_tour.js"></script>
<script src="../../../static/js/tour.js"></script>


</html>